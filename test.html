<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>My Box TV - Diagnostic Complet (15k+)</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root { --primary: #e50914; --bg: #0b0b0b; --panel: #161616; --text: #eee; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 380px; background: var(--panel); border-right: 1px solid #333; display: flex; flex-direction: column; }
        .header { padding: 15px; text-align: center; border-bottom: 2px solid var(--primary); background: #000; }
        
        .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; background: #222; }
        .stat-card { background: #000; padding: 10px; border-radius: 5px; text-align: center; border: 1px solid #444; }
        .stat-card span { display: block; font-size: 18px; font-weight: bold; color: var(--primary); }
        .stat-card label { font-size: 10px; color: #888; text-transform: uppercase; }

        .controls { padding: 15px; border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 8px; }
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        select { padding: 10px; background: #333; color: white; border: 1px solid #555; }

        /* Liste */
        #channel-list { flex: 1; overflow-y: auto; padding: 10px; }
        .ch-item { padding: 10px; background: #222; margin-bottom: 5px; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; }
        .ch-item:hover { background: #333; }
        .ch-item.active { border-left: 4px solid var(--primary); background: #400; }

        /* Main Content */
        .main { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 15px; }
        video { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .console { flex: 1; background: #000; border: 1px solid #333; padding: 15px; font-family: monospace; font-size: 12px; color: #0f0; overflow-y: auto; border-radius: 5px; }
        .progress-bar { height: 4px; background: #333; width: 100%; position: relative; }
        #progress { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="header">
        <h2 style="margin:0; font-size: 1.1rem; color: var(--primary);">LABORATOIRE MY BOX TV</h2>
    </div>

    <div class="controls">
        <button onclick="startFullScan()">ðŸš€ LANCER LE SCAN TOTAL</button>
        <div class="progress-bar"><div id="progress"></div></div>
        <select id="tp-filter" onchange="filterChannels()">
            <option value="ALL">Tous les transpondeurs</option>
        </select>
        <input type="text" id="search" placeholder="Chercher une chaÃ®ne..." oninput="filterChannels()" 
               style="padding:10px; background:#222; border:1px solid #444; color:white;">
    </div>

    <div class="stats-container">
        <div class="stat-card"><span id="count-tp">0</span><label>Sources</label></div>
        <div class="stat-card"><span id="count-ch">0</span><label>ChaÃ®nes</label></div>
    </div>

    <div id="channel-list">
        <div style="text-align:center; padding:40px; color:#666;">Cliquez sur "Lancer le scan" pour synchroniser vos 15 000+ chaÃ®nes.</div>
    </div>
</div>

<div class="main">
    <video id="video" controls autoplay></video>
    <div class="console" id="logs">> En attente du scan...</div>
</div>

<script>
    // URL de ton API
    const API_URL = "https://script.google.com/macros/s/AKfycbyTVVHd3DGbEtlRfVN5aboerVM1UEbDYTGv4vJxabValUYDAHRxgLoFppjUO8xwv9SsTw/exec";
    
    let allChannels = [];
    let filteredChannels = [];
    let visibleCount = 0;
    const BATCH_SIZE = 300; 

    function log(msg, type="info") {
        const logs = document.getElementById('logs');
        const color = type === "error" ? "#ff4444" : (type === "success" ? "#00ff00" : "#00ccff");
        logs.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        logs.scrollTop = logs.scrollHeight;
    }

    async function startFullScan() {
        allChannels = [];
        document.getElementById('channel-list').innerHTML = "";
        log("RÃ©cupÃ©ration de la liste des transpondeurs...", "info");
        
        try {
            const res = await fetch(`${API_URL}?action=admin_get_m3u_sources`);
            const sources = await res.json();
            document.getElementById('count-tp').innerText = sources.length;
            
            let i = 0;
            for (let url of sources) {
                i++;
                const percent = (i / sources.length) * 100;
                document.getElementById('progress').style.width = percent + "%";
                
                log(`Analyse source ${i}/${sources.length} : ${url.split('/').pop()}`);
                await scanOneM3U(url);
                
                // Mise Ã  jour du compteur en temps rÃ©el
                document.getElementById('count-ch').innerText = allChannels.length;
                
                // On met Ã  jour le filtre
                addSourceToFilter(url);
            }
            
            log(`Scan terminÃ© ! Total : ${allChannels.length} chaÃ®nes.`, "success");
            filterChannels();
            
        } catch (e) {
            log("Erreur critique : " + e.message, "error");
        }
    }

    async function scanOneM3U(url) {
        try {
            // Utilisation d'un proxy pour Ã©viter les blocages CORS du navigateur
            const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
            const response = await fetch(proxyUrl);
            const data = await response.text();
            
            const lines = data.split('\n');
            let currentName = "";
            let currentGroup = "GÃ©nÃ©ral";

            for (let line of lines) {
                line = line.trim();
                if (line.startsWith('#EXTINF:')) {
                    const info = line.split(',');
                    currentName = info[1] ? info[1].trim() : "ChaÃ®ne inconnue";
                    const groupMatch = line.match(/group-title="([^"]+)"/);
                    currentGroup = groupMatch ? groupMatch[1] : "TV";
                } else if (line.startsWith('http')) {
                    allChannels.push({
                        name: currentName,
                        url: line,
                        group: currentGroup,
                        source: url
                    });
                }
            }
        } catch (err) {
            log(`Impossible de lire ${url} (Serveur inaccessible ou CORS)`, "error");
        }
    }

    function addSourceToFilter(url) {
        const filter = document.getElementById('tp-filter');
        const fileName = url.split('/').pop() || url;
        if (!Array.from(filter.options).some(o => o.value === url)) {
            const opt = document.createElement('option');
            opt.value = url;
            opt.innerText = fileName;
            filter.appendChild(opt);
        }
    }

    function filterChannels() {
        const tp = document.getElementById('tp-filter').value;
        const search = document.getElementById('search').value.toLowerCase();
        
        filteredChannels = allChannels.filter(ch => {
            const matchTP = (tp === "ALL" || ch.source === tp);
            const matchSearch = ch.name.toLowerCase().includes(search);
            return matchTP && matchSearch;
        });

        visibleCount = 0;
        document.getElementById('channel-list').innerHTML = "";
        renderBatch();
    }

    function renderBatch() {
        const container = document.getElementById('channel-list');
        const end = Math.min(visibleCount + BATCH_SIZE, filteredChannels.length);
        
        const fragment = document.createDocumentFragment();
        for (let i = visibleCount; i < end; i++) {
            const ch = filteredChannels[i];
            const div = document.createElement('div');
            div.className = 'ch-item';
            div.innerHTML = `<span>${ch.name}</span> <small style="color:#666">${ch.group}</small>`;
            div.onclick = () => play(ch.url, ch.name, div);
            fragment.appendChild(div);
        }
        container.appendChild(fragment);
        visibleCount = end;
    }

    // Scroll Infini
    document.getElementById('channel-list').onscroll = function() {
        if (this.scrollTop + this.clientHeight >= this.scrollHeight - 50) {
            if (visibleCount < filteredChannels.length) renderBatch();
        }
    };

    let hls = null;
    function play(url, name, el) {
        document.querySelectorAll('.ch-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        log(`Lecture de : ${name}`, "success");
        
        const video = document.getElementById('video');
        if (hls) hls.destroy();

        if (url.includes('m3u8') && Hls.isSupported()) {
            hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else {
            video.src = url;
            video.play().catch(e => log("Format non supportÃ© par le navigateur (TS/MKV)", "error"));
        }
    }
</script>

</body>
</html>
