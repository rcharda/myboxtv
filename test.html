<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Box TV - Testeur Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root { --primary: #e50914; --bg: #121212; --panel: #1e1e1e; --text: #fff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 350px; background: var(--panel); border-right: 1px solid #333; display: flex; flex-direction: column; }
        .header { padding: 15px; background: #111; border-bottom: 2px solid var(--primary); text-align: center; }
        .header h2 { margin: 0; font-size: 1.2rem; color: var(--primary); }
        
        .controls { padding: 15px; border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 10px; }
        button { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        select { padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 5px; outline: none;}
        
        /* Stats Box */
        .stats-box { background: #000; padding: 10px; border-radius: 5px; text-align: center; border: 1px solid #333;}
        .count-number { font-size: 1.5rem; color: #2ecc71; font-weight: bold; }
        
        .channel-list { flex: 1; overflow-y: auto; padding: 10px; list-style: none; margin: 0; }
        .channel-item { padding: 10px; background: #2a2a2a; margin-bottom: 8px; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .channel-item:hover { background: #333; }
        .channel-item.active { border-left: 3px solid var(--primary); background: rgba(229, 9, 20, 0.2); }
        .badge { font-size: 0.7rem; padding: 3px 6px; border-radius: 3px; background: #444; }

        .main { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 20px; }
        .video-container { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 10px; overflow: hidden; }
        video { width: 100%; height: 100%; outline: none; }
        .console { background: #000; color: #0f0; font-family: monospace; font-size: 0.85rem; height: 150px; overflow-y: auto; padding: 10px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header"><h2>üõ†Ô∏è Testeur IPTV Pro</h2></div>
        
        <div class="controls">
            <button onclick="fetchFromSheet()">üì• Charger depuis Google Sheets</button>
            
            <select id="transponderFilter" onchange="applyFilters()">
                <option value="ALL">üåç Tous les Transpondeurs</option>
            </select>
            
            <div class="stats-box">
                <div class="count-number" id="channelCount">0</div>
                <div style="font-size: 0.8rem; color: #888;">Cha√Ænes trouv√©es</div>
            </div>
        </div>
        
        <ul class="channel-list" id="channelList">
            <div style="text-align:center; padding: 20px; color: #888;">En attente de chargement...</div>
        </ul>
    </div>

    <div class="main">
        <div class="video-container">
            <video id="videoPlayer" controls autoplay></video>
        </div>
        <div class="console" id="consoleLogs">
            <div>> Pr√™t. En attente de flux...</div>
        </div>
    </div>

    <script>
        // Remplace par ton vrai lien Google Apps Script
        const API_URL = "https://script.google.com/macros/s/AKfycbyTVVHd3DGbEtlRfVN5aboerVM1UEbDYTGv4vJxabValUYDAHRxgLoFppjUO8xwv9SsTw/exec?action=get_playlists";
        
        let allChannels = [];
        let filteredChannels = [];
        
        // --- VARIABLES SCROLL INFINI ---
        let visibleCount = 0;
        const BATCH_SIZE = 100; // Charge par paquet de 100

        const listEl = document.getElementById('channelList');
        const video = document.getElementById('videoPlayer');
        const consoleEl = document.getElementById('consoleLogs');
        let hlsInstance = null;

        function logMsg(msg) {
            const div = document.createElement('div');
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            consoleEl.appendChild(div);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        // 1. R√©cup√©ration des donn√©es
        async function fetchFromSheet() {
            logMsg("Connexion √† Google Sheets en cours...");
            listEl.innerHTML = "<div style='text-align:center; padding:20px;'>Extraction des donn√©es...</div>";
            
            try {
                const response = await fetch(API_URL);
                allChannels = await response.json();
                
                logMsg(`${allChannels.length} cha√Ænes r√©cup√©r√©es.`);
                
                // Extraire les Transpondeurs uniques (ou cat√©gories)
                extractTransponders();
                
                // Lancer l'affichage
                applyFilters();
            } catch (error) {
                logMsg(`Erreur API: ${error.message}`);
            }
        }

        // 2. Extraire la liste des Transpondeurs/Groupes
        function extractTransponders() {
            const select = document.getElementById('transponderFilter');
            select.innerHTML = '<option value="ALL">üåç Tous les Transpondeurs</option>';
            
            const uniqueGroups = new Set();
            allChannels.forEach(ch => {
                // Si tu as une colonne "category" ou "group" dans ton sheet :
                let groupName = ch.category || "Inconnu"; 
                uniqueGroups.add(groupName);
            });

            uniqueGroups.forEach(group => {
                const opt = document.createElement('option');
                opt.value = group;
                opt.innerText = `üìÅ ${group}`;
                select.appendChild(opt);
            });
        }

        // 3. Appliquer le Filtre
        function applyFilters() {
            const selectedGroup = document.getElementById('transponderFilter').value;
            
            if (selectedGroup === "ALL") {
                filteredChannels = allChannels;
            } else {
                filteredChannels = allChannels.filter(ch => (ch.category || "Inconnu") === selectedGroup);
            }

            // Mise √† jour du compteur
            document.getElementById('channelCount').innerText = filteredChannels.length;
            
            // R√©initialiser le scroll
            visibleCount = 0;
            listEl.innerHTML = "";
            renderBatch();
        }

        // 4. Rendu avec Scroll Infini
        function renderBatch() {
            const end = Math.min(visibleCount + BATCH_SIZE, filteredChannels.length);
            
            for (let i = visibleCount; i < end; i++) {
                const ch = filteredChannels[i];
                const li = document.createElement('li');
                li.className = 'channel-item';
                
                // Petit badge pour le format
                let type = ch.url.includes('.m3u8') ? 'HLS' : 'TS';
                
                li.innerHTML = `
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-weight: bold; font-size: 0.9rem;">${ch.name || 'Sans nom'}</span>
                        <span style="font-size: 0.7rem; color: #888;">${ch.category || 'Inconnu'}</span>
                    </div>
                    <span class="badge">${type}</span>
                `;
                
                li.onclick = () => playStream(ch.url, ch.name, li);
                listEl.appendChild(li);
            }
            visibleCount = end;
        }

        // 5. √âcouteur de Scroll pour charger la suite
        listEl.addEventListener('scroll', function() {
            if (this.scrollTop + this.clientHeight >= this.scrollHeight - 100) {
                if (visibleCount < filteredChannels.length) {
                    renderBatch();
                }
            }
        });

        // 6. Lecture de la vid√©o
        function playStream(url, name, element) {
            logMsg(`Test de : ${name}`);
            document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('active'));
            if(element) element.classList.add('active');

            if (hlsInstance) hlsInstance.destroy();
            video.src = "";

            if (url.includes('.m3u8') && Hls.isSupported()) {
                hlsInstance = new Hls();
                hlsInstance.loadSource(url);
                hlsInstance.attachMedia(video);
                hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else {
                video.src = url;
                video.play().catch(() => logMsg("Erreur : Format non support√© nativement."));
            }
        }
    </script>
</body>
</html>
