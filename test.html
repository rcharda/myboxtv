<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>My Box TV - Testeur de Transpondeurs</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #e50914; --bg: #000; --panel: #111; --text: #fff; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar avec Filtres */
        .sidebar { width: 380px; background: var(--panel); border-right: 1px solid #333; display: flex; flex-direction: column; }
        .header { padding: 20px; text-align: center; border-bottom: 2px solid var(--primary); }
        .stats { background: #222; margin: 10px; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #444; }
        .count { font-size: 24px; font-weight: bold; color: var(--primary); }

        .filter-section { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        select, input { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; box-sizing: border-box; }

        /* Liste avec Scroll Infini */
        #channel-list { flex: 1; overflow-y: auto; padding: 5px; }
        .ch-item { display: flex; align-items: center; padding: 10px; margin-bottom: 5px; background: #1a1a1a; border-radius: 5px; cursor: pointer; border-left: 3px solid transparent; }
        .ch-item:hover { background: #252525; }
        .ch-item.active { border-left-color: var(--primary); background: #300; }
        .ch-info { margin-left: 10px; font-size: 13px; }
        .badge { font-size: 10px; background: var(--primary); padding: 2px 5px; border-radius: 3px; margin-left: auto; }

        /* Lecteur */
        .player-area { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 15px; }
        video { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .console { flex: 1; background: #050505; border: 1px solid #222; border-radius: 5px; padding: 15px; font-family: monospace; font-size: 12px; color: #0f0; overflow-y: auto; }
        .btn-load { background: var(--primary); color: white; border: none; padding: 12px; font-weight: bold; cursor: pointer; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" width="120">
            <h3>TESTEUR DE SOURCES</h3>
        </div>

        <div class="filter-section">
            <button class="btn-load" onclick="loadFromSheet()">ðŸ“¥ CHARGER LE SHEET</button>
            <select id="tp-filter" onchange="applyFilters()">
                <option value="ALL">-- Tous les Transpondeurs --</option>
            </select>
            <input type="text" id="search" placeholder="ðŸ” Rechercher une chaÃ®ne..." oninput="applyFilters()">
        </div>

        <div class="stats">
            <div class="count" id="total-count">0</div>
            <div style="font-size: 11px; color: #888;">CHAÃŽNES DÃ‰TECTÃ‰ES</div>
        </div>

        <div id="channel-list"></div>
    </div>

    <div class="player-area">
        <video id="video" controls autoplay></video>
        <div class="console" id="logs">> PrÃªt pour l'analyse...</div>
    </div>

    <script>
        // Utilisation de ton URL API existante
        const API_URL = "https://script.google.com/macros/s/AKfycbyTVVHd3DGbEtlRfVN5aboerVM1UEbDYTGv4vJxabValUYDAHRxgLoFppjUO8xwv9SsTw/exec";
        
        let allChannels = [];
        let filteredChannels = [];
        let visibleCount = 0;
        const BATCH_SIZE = 500; // Identique Ã  ton application
        let hls = null;

        function log(msg, color = "#0f0") {
            const div = document.createElement('div');
            div.style.color = color;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] > ${msg}`;
            const logs = document.getElementById('logs');
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        async function loadFromSheet() {
            log("Connexion au Google Sheet (Onglet Sources)...", "#3498db");
            try {
                // On appelle l'action qui rÃ©cupÃ¨re les sources m3u
                const res = await fetch(`${API_URL}?action=admin_get_m3u_sources`);
                const sources = await res.json(); // ReÃ§oit la liste des liens
                
                log(`${sources.length} sources (Transpondeurs) trouvÃ©es. Analyse en cours...`, "#ffd700");
                
                // On remplit le filtre Transpondeur
                const filter = document.getElementById('tp-filter');
                filter.innerHTML = '<option value="ALL">-- Tous les Transpondeurs --</option>';
                
                // Pour chaque lien dans ton sheet, on va scanner les chaÃ®nes
                for(let url of sources) {
                    log(`Analyse : ${url.substring(0, 50)}...`);
                    await scanM3U(url);
                }
                
                log("Analyse terminÃ©e avec succÃ¨s !", "#2ecc71");
                applyFilters();
                
            } catch(e) {
                log("Erreur de chargement : " + e.message, "red");
            }
        }

        async function scanM3U(url) {
            try {
                // Utilisation d'un proxy pour Ã©viter les erreurs CORS sur navigateur
                const res = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(url));
                const text = await res.text();
                const lines = text.split('\n');
                
                let currentName = "";
                let currentCat = "Inconnu";

                lines.forEach(line => {
                    line = line.trim();
                    if(line.startsWith('#EXTINF:')) {
                        const nameMatch = line.split(',')[1];
                        currentName = nameMatch ? nameMatch.trim() : "Sans nom";
                        const groupMatch = line.match(/group-title="([^"]+)"/);
                        currentCat = groupMatch ? groupMatch[1] : "TV";
                    } else if(line.startsWith('http')) {
                        allChannels.push({
                            name: currentName,
                            url: line,
                            category: currentCat,
                            source: url // On garde l'origine pour le filtre
                        });
                        // Ajout dynamique au filtre TP si nouveau
                        addSourceToFilter(url);
                    }
                });
            } catch(e) { log("Ã‰chec sur une source : " + url, "orange"); }
        }

        function addSourceToFilter(url) {
            const filter = document.getElementById('tp-filter');
            const exists = Array.from(filter.options).some(opt => opt.value === url);
            if(!exists) {
                const opt = document.createElement('option');
                opt.value = url;
                opt.innerText = "Transpondeur : " + url.split('/').pop();
                filter.appendChild(opt);
            }
        }

        function applyFilters() {
            const tp = document.getElementById('tp-filter').value;
            const search = document.getElementById('search').value.toLowerCase();
            
            filteredChannels = allChannels.filter(ch => {
                const matchTP = (tp === "ALL" || ch.source === tp);
                const matchSearch = ch.name.toLowerCase().includes(search);
                return matchTP && matchSearch;
            });

            document.getElementById('total-count').innerText = filteredChannels.length;
            visibleCount = 0;
            document.getElementById('channel-list').innerHTML = "";
            renderBatch();
        }

        function renderBatch() {
            const list = document.getElementById('channel-list');
            const end = Math.min(visibleCount + BATCH_SIZE, filteredChannels.length);
            
            for (let i = visibleCount; i < end; i++) {
                const ch = filteredChannels[i];
                const div = document.createElement('div');
                div.className = 'ch-item';
                div.innerHTML = `
                    <div class="ch-info">
                        <div style="font-weight:bold">${ch.name}</div>
                        <div style="font-size:10px; color:#888">${ch.category}</div>
                    </div>
                    <div class="badge">${ch.url.includes('.m3u8') ? 'HLS' : 'TS'}</div>
                `;
                div.onclick = () => play(ch.url, ch.name, div);
                list.appendChild(div);
            }
            visibleCount = end;
        }

        // DÃ©tection du scroll pour charger la suite (Scroll Infini)
        document.getElementById('channel-list').onscroll = function() {
            if(this.scrollTop + this.clientHeight >= this.scrollHeight - 100) {
                renderBatch();
            }
        };

        function play(url, name, el) {
            log(`Lecture de : ${name}`, "#2ecc71");
            document.querySelectorAll('.ch-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');

            const video = document.getElementById('video');
            if(hls) hls.destroy();

            if(url.includes('m3u8') && Hls.isSupported()) {
                hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                hls.on(Hls.Events.ERROR, () => log("Erreur HLS sur ce lien", "red"));
            } else {
                video.src = url;
                video.play().catch(e => log("Le navigateur ne peut pas lire ce format directement (TS/MKV)", "orange"));
            }
        }
    </script>
</body>
</html>
