<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN ADMIN PANEL</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e50914; --bg: #0f0f0f; --panel: #1a1a1a; --text: #fff; --border: #333; --green: #2ecc71; }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 250px; background: #000; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; }
        .logo-area { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 15px; cursor: pointer; color: #888; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; font-weight: 600; }
        .nav-item:hover, .nav-item.active { background: #1a1a1a; color: #fff; border-left: 4px solid var(--primary); }

        /* MAIN */
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .card-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .card h3 { margin: 0; color: #888; font-size: 12px; }
        .card .val { font-size: 28px; font-weight: bold; margin-top: 10px; }

        /* TABLES */
        .table-box { background: var(--panel); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border); font-size: 13px; }
        th { background: #111; color: #aaa; text-transform: uppercase; font-size: 11px; }
        tr:hover { background: #222; }

        /* INPUTS & BTNS */
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; color: white; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .btn:hover { opacity: 0.8; transform: translateY(-2px); }
        .btn-primary { background: var(--primary); }
        .btn-green { background: var(--green); }
        .btn-icon { width: 30px; height: 30px; border-radius: 5px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #333; color: #fff; }
        
        input, select { background: #000; border: 1px solid var(--border); padding: 10px; color: #fff; border-radius: 5px; width: 100%; margin-bottom: 10px; }

        /* LOGIN SCREEN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { width: 320px; text-align: center; }
        
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: var(--panel); padding: 30px; border-radius: 10px; width: 400px; border: 1px solid var(--border); }

        /* TOGGLE SWITCH */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:var(--primary); margin-bottom:5px;">TITAN ADMIN</h1>
            <p style="color:#666; margin-bottom:20px;">Connexion Serveur</p>
            <input type="password" id="admin-pass" placeholder="Mot de passe" style="text-align:center; letter-spacing:3px;">
            <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="tryLogin()">CONNEXION</button>
            <div id="login-msg" style="color:#e74c3c; margin-top:10px; font-size:12px;"></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo-area"><i class="fas fa-shield-alt"></i> ADMIN V2</div>
        <div class="nav-item active" onclick="switchView('users')"><i class="fas fa-users"></i> Abonn√©s</div>
        <div class="nav-item" onclick="switchView('sources')"><i class="fas fa-tv"></i> Sources M3U</div>
        <div class="nav-item" onclick="switchView('system')"><i class="fas fa-cogs"></i> Syst√®me</div>
        <div class="nav-item" onclick="loadData()" style="margin-top:auto; color:var(--green);"><i class="fas fa-sync"></i> Rafra√Æchir</div>
        <div class="nav-item" onclick="location.reload()" style="color:var(--primary);"><i class="fas fa-power-off"></i> D√©co</div>
    </div>

    <div class="main">
        <div id="view-users">
            <div class="header">
                <h2>Gestion des Licences</h2>
                <button class="btn btn-primary" onclick="openModal('modal-user')"><i class="fas fa-user-plus"></i> Cr√©er Licence</button>
            </div>
            <div class="card-grid">
                <div class="card"><h3>Total</h3><div class="val" id="stat-total">0</div></div>
                <div class="card" style="border-color:var(--green);"><h3>Actifs</h3><div class="val" id="stat-active" style="color:var(--green);">0</div></div>
                <div class="card" style="border-color:var(--primary);"><h3>Expir√©s</h3><div class="val" id="stat-expired" style="color:var(--primary);">0</div></div>
            </div>
            <div class="table-box">
                <div style="padding:15px; border-bottom:1px solid #333;">
                    <input type="text" id="searchUser" placeholder="üîç Filtrer par ID ou Appareil..." onkeyup="renderUsers()" style="margin:0;">
                </div>
                <table>
                    <thead><tr><th>ID Licence</th><th>Dur√©e (Jours)</th><th>Appareil (Device)</th><th>Expiration</th><th>Actions</th></tr></thead>
                    <tbody id="tbody-users"></tbody>
                </table>
            </div>
        </div>

        <div id="view-sources" style="display:none;">
            <div class="header">
                <h2>Sources & Transpondeurs</h2>
                <button class="btn btn-primary" onclick="openModal('modal-source')"><i class="fas fa-plus"></i> Ajouter Source</button>
            </div>
            <div class="table-box">
                <table>
                    <thead><tr><th>Nom du Bouquet</th><th>Lien M3U</th><th>Actions</th></tr></thead>
                    <tbody id="tbody-sources"></tbody>
                </table>
            </div>
        </div>

        <div id="view-system" style="display:none;">
            <div class="header"><h2>Configuration Syst√®me</h2></div>
            
            <div class="card" style="max-width:500px; text-align:left; margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div>
                        <h3 style="color:#fff; font-size:16px;">Mode Maintenance</h3>
                        <span style="color:#666; font-size:12px;">Bloque l'acc√®s √† tous les utilisateurs</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="maint-switch" onchange="toggleMaintenance()">
                        <span class="slider"></span>
                    </label>
                </div>
                <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
                
                <h3 style="color:#fff; font-size:16px; margin-bottom:10px;">Message Global</h3>
                <input type="text" id="global-msg" placeholder="Message affich√© sur l'√©cran des utilisateurs...">
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="setMessage()">Envoyer</button>
                    <button class="btn btn-green" style="background:#333;" onclick="setMessage('')">Effacer</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-user" class="modal">
        <div class="modal-content">
            <h2>Nouvelle Licence</h2>
            <label>ID Utilisateur</label>
            <input type="text" id="new-key" placeholder="Ex: USER-2026">
            <label>Dur√©e (Jours)</label>
            <input type="number" id="new-days" value="30">
            <label>Ecrans Max</label>
            <input type="number" id="new-screens" value="1">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" style="flex:1" onclick="addUser()">VALIDER</button>
                <button class="btn" style="flex:1; background:#333;" onclick="closeModals()">ANNULER</button>
            </div>
        </div>
    </div>

    <div id="modal-source" class="modal">
        <div class="modal-content">
            <h2>Nouvelle Source</h2>
            <label>Nom</label>
            <input type="text" id="src-name" placeholder="Ex: Canal+">
            <label>Lien M3U</label>
            <input type="text" id="src-url" placeholder="http://...">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" style="flex:1" onclick="addSource()">AJOUTER</button>
                <button class="btn" style="flex:1; background:#333;" onclick="closeModals()">ANNULER</button>
            </div>
        </div>
    </div>

<script>
    // ==========================================
    // METS L'URL DE TON SCRIPT GOOGLE ICI üëá
    const API = "https://script.google.com/macros/s/AKfycbwg49-A8a5q72hnhcf99865CBqAErbxAMUX4TDDsR47anl4ELo6iZhDzS2hH4yMMJ1CcQ/exec";
    // ==========================================

    let users = [];
    let sources = [];

    // --- AUTH ---
    async function tryLogin() {
        const pass = document.getElementById('admin-pass').value;
        const btn = document.querySelector('#login-screen button');
        btn.innerText = "V√âRIFICATION...";
        
        try {
            // V√©rification via le script Google (action=admin_login)
            const res = await fetch(`${API}?action=admin_login&pass=${encodeURIComponent(pass)}`);
            const txt = await res.text();
            
            if(txt.includes("AUTH:OK")) {
                document.getElementById('login-screen').style.display = 'none';
                loadData();
            } else {
                document.getElementById('login-msg').innerText = "Mot de passe incorrect (V√©rifie feuille Config cellule A1)";
                btn.innerText = "ENTRER";
            }
        } catch(e) {
            alert("Erreur connexion au script Google");
            btn.innerText = "ENTRER";
        }
    }

    // --- DATA LOADING ---
    async function loadData() {
        try {
            // R√©cup√®re tout d'un coup via action=get_admin_data (d√©fini dans ton script)
            const res = await fetch(`${API}?action=get_admin_data`);
            const data = await res.json();
            
            users = data.users;     // Array [Key, Duration, Device, Date, Screens]
            sources = data.sources; // Array [Name, Link]
            
            // Config syst√®me
            document.getElementById('maint-switch').checked = (data.maintenance === "ON");
            document.getElementById('global-msg').value = data.message;

            renderUsers();
            renderSources();
            calcStats();
        } catch(e) {
            console.log(e);
            alert("Erreur chargement donn√©es. V√©rifiez que le script Google est bien publi√© en 'Web App' -> 'Anyone'.");
        }
    }

    // --- RENDERING ---
    function renderUsers() {
        const tbody = document.getElementById('tbody-users');
        tbody.innerHTML = "";
        const term = document.getElementById('searchUser').value.toLowerCase();

        users.forEach(u => {
            // Structure de ton script : u[0]=Key, u[1]=Duration, u[2]=Device, u[3]=Date
            const key = u[0];
            const duration = u[1];
            const device = u[2];
            const startDate = u[3] ? new Date(u[3]) : null;
            
            // Calcul expiration
            let expireTxt = "-";
            let isExpired = false;
            if(startDate && duration !== "VIE") {
                const end = new Date(startDate);
                end.setDate(end.getDate() + parseInt(duration));
                expireTxt = end.toISOString().split('T')[0];
                if(new Date() > end) isExpired = true;
            }

            if(key.toLowerCase().includes(term)) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:bold; color:#fff;">${key}</td>
                    <td>${duration}</td>
                    <td style="font-family:monospace; color:#888;">${device || "Non connect√©"}</td>
                    <td style="color:${isExpired ? 'red' : 'lightgreen'}">${expireTxt}</td>
                    <td style="display:flex; gap:5px;">
                        <div class="btn-icon" onclick="resetUser('${key}')" title="Reset Device"><i class="fas fa-mobile-alt"></i></div>
                        <div class="btn-icon" style="background:#c0392b;" onclick="deleteUser('${key}')"><i class="fas fa-trash"></i></div>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        });
    }

    function renderSources() {
        const tbody = document.getElementById('tbody-sources');
        tbody.innerHTML = "";
        sources.forEach(s => {
            // Structure : s[0]=Name, s[1]=Link
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><b>${s[0]}</b></td>
                <td style="color:#888; max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${s[1]}</td>
                <td><div class="btn-icon" style="background:#c0392b;" onclick="deleteSource('${s[1]}')"><i class="fas fa-trash"></i></div></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function calcStats() {
        document.getElementById('stat-total').innerText = users.length;
        // Calcul simple des actifs (ceux qui ont un device connect√©)
        const active = users.filter(u => u[2] && u[2].length > 2).length;
        document.getElementById('stat-active').innerText = active;
        document.getElementById('stat-expired').innerText = users.length - active;
    }

    // --- ACTIONS ---
    async function addUser() {
        const k = document.getElementById('new-key').value;
        const d = document.getElementById('new-days').value;
        const s = document.getElementById('new-screens').value;
        if(!k) return alert("ID requis");
        
        await fetch(`${API}?action=admin_user_action&type=add&key=${encodeURIComponent(k)}&days=${d}&screens=${s}`);
        closeModals(); loadData();
    }

    async function deleteUser(key) {
        if(!confirm("Supprimer " + key + " ?")) return;
        await fetch(`${API}?action=admin_user_action&type=delete&key=${encodeURIComponent(key)}`);
        loadData();
    }

    async function resetUser(key) {
        if(!confirm("Reset Device pour " + key + " ?")) return;
        await fetch(`${API}?action=admin_user_action&type=edit&key=${encodeURIComponent(key)}&reset=yes`);
        loadData();
    }

    async function addSource() {
        const n = document.getElementById('src-name').value;
        const l = document.getElementById('src-url').value;
        await fetch(`${API}?action=admin_source_action&type=add&name=${encodeURIComponent(n)}&link=${encodeURIComponent(l)}`);
        closeModals(); loadData();
    }

    async function deleteSource(link) {
        if(!confirm("Supprimer cette source ?")) return;
        await fetch(`${API}?action=admin_source_action&type=delete&link=${encodeURIComponent(link)}`);
        loadData();
    }

    async function toggleMaintenance() {
        const status = document.getElementById('maint-switch').checked ? "ON" : "OFF";
        await fetch(`${API}?action=set_maintenance&status=${status}`);
    }

    async function setMessage(val) {
        const msg = val !== undefined ? val : document.getElementById('global-msg').value;
        await fetch(`${API}?action=admin_set_message&msg=${encodeURIComponent(msg)}`);
        if(val === "") document.getElementById('global-msg').value = "";
        alert("Message mis √† jour");
    }

    // --- UI ---
    function switchView(id) {
        ['users','sources','system'].forEach(v => document.getElementById('view-'+v).style.display='none');
        document.getElementById('view-'+id).style.display='block';
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
    function openModal(id) { document.getElementById(id).style.display='flex'; }
    function closeModals() { document.querySelectorAll('.modal').forEach(e=>e.style.display='none'); }

</script>
</body>
</html>
