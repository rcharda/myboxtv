<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel V40</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #eee; margin: 0; }
        
        /* LOGIN */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: #1e1e1e; padding: 40px; border-radius: 10px; border: 1px solid #333; text-align: center; }
        input { padding: 10px; border-radius: 5px; border: 1px solid #444; background: #222; color: white; width: 200px; }
        button { padding: 10px 20px; background: #e50914; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #ff0f1f; }

        /* DASHBOARD */
        #dashboard { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
        h1 { color: #e50914; margin: 0; }
        
        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { background: #333; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .tab-btn.active { background: #e50914; color: white; }
        
        .section { display: none; }
        .section.active { display: block; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; background: #1e1e1e; border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #252525; color: #aaa; font-size: 12px; text-transform: uppercase; }
        tr:hover { background: #2a2a2a; }
        
        .action-btn { padding: 5px 10px; font-size: 12px; margin-right: 5px; }
        .btn-edit { background: #007bff; }
        .btn-del { background: #ff4444; }

        /* MESSAGE BOX */
        .msg-box { background: #222; padding: 20px; border-radius: 10px; }
        .msg-input { width: 100%; padding: 15px; margin: 10px 0; font-size: 16px; }

        /* ADD USER FORM */
        .add-form { background: #222; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color:#e50914;">ADMINISTRATION V40</h2>
        <input type="password" id="admin-pass" placeholder="Mot de passe Admin">
        <button onclick="adminLogin()">ENTRER</button>
        <div id="login-error" style="color:red; margin-top:10px;"></div>
    </div>
</div>

<div id="dashboard">
    <div class="header">
        <h1>MY BOX TV <span style="font-size:14px; color:#aaa;">CONTROL PANEL</span></h1>
        <button onclick="location.reload()" style="background:#444;">ACTUALISER</button>
    </div>

    <div class="tabs">
        <div class="tab-btn active" onclick="showTab('users')"><i class="fas fa-users"></i> UTILISATEURS</div>
        <div class="tab-btn" onclick="showTab('sources')"><i class="fas fa-link"></i> SOURCES IPTV</div>
        <div class="tab-btn" onclick="showTab('message')"><i class="fas fa-bullhorn"></i> MESSAGE GLOBAL</div>
    </div>

    <div id="users" class="section active">
        <div class="add-form">
            <h3 style="margin:0; color:#aaa;">Ajouter :</h3>
            <input type="text" id="new-key" placeholder="ID (ex: CLIENT-JEAN)" style="width:150px;">
            <select id="new-days" style="padding:10px; background:#333; color:white; border:1px solid #444; border-radius:5px;">
                <option value="30">30 Jours</option>
                <option value="365">1 An</option>
                <option value="VIE">À VIE</option>
            </select>
            <select id="new-screens" style="padding:10px; background:#333; color:white; border:1px solid #444; border-radius:5px;">
                <option value="1">1 Écran</option>
                <option value="2">2 Écrans</option>
                <option value="4">4 Écrans</option>
            </select>
            <button onclick="addUser()">CRÉER</button>
        </div>

        <table id="users-table">
            <thead>
                <tr>
                    <th>CLÉ / ID</th>
                    <th>DURÉE</th>
                    <th>ÉCRANS (Max)</th>
                    <th>APPAREILS CONNECTÉS</th>
                    <th>ACTIVÉ LE</th>
                    <th>ACTIONS</th>
                </tr>
            </thead>
            <tbody id="users-body"></tbody>
        </table>
    </div>

    <div id="sources" class="section">
        <div class="add-form">
            <h3 style="margin:0; color:#aaa;">Ajouter Source :</h3>
            <input type="text" id="new-source-name" placeholder="Nom (ex: Canal+ Backup)" style="width:200px;">
            <input type="text" id="new-source-link" placeholder="http://lien-m3u..." style="width:400px;">
            <button onclick="addSource()">AJOUTER</button>
        </div>
        
        <table id="sources-table">
            <thead>
                <tr><th>NOM</th><th>LIEN</th><th>ACTIONS</th></tr>
            </thead>
            <tbody id="sources-body"></tbody>
        </table>
    </div>

    <div id="message" class="section">
        <div class="msg-box">
            <h3>Message d'accueil (Popup)</h3>
            <input type="text" id="global-msg-input" class="msg-input" placeholder="Bienvenue...">
            <button onclick="saveMessage()" style="width:100%;">METTRE À JOUR LE MESSAGE</button>
        </div>
    </div>
</div>

<script>
    // =========================================================
    // NOUVEAU LIEN GOOGLE SCRIPT DEPLOYÉ (V40)
    const API_URL = "https://script.google.com/macros/s/AKfycbwtT21oefu4dRVMR-dn2bMM8y8Sqv_lXSgYO-vccxosP7j87y1CvyGqlp3HYSbYL4XPaw/exec";
    // =========================================================

    async function adminLogin() {
        const pass = document.getElementById('admin-pass').value;
        const btn = document.querySelector('#login-overlay button');
        btn.innerText = "Vérification...";
        
        try {
            const res = await fetch(`${API_URL}?action=admin_login&pass=${encodeURIComponent(pass)}`);
            const text = await res.text();
            if(text === "AUTH:OK") {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadData();
            } else {
                document.getElementById('login-error').innerText = "Mot de passe incorrect";
            }
        } catch(e) { alert("Erreur connexion"); }
        btn.innerText = "ENTRER";
    }

    async function loadData() {
        const res = await fetch(`${API_URL}?action=get_admin_data`);
        const data = await res.json();
        
        const usersBody = document.getElementById('users-body');
        usersBody.innerHTML = "";
        data.users.forEach(u => {
            const key = u[0];
            const duration = u[1];
            const devices = u[2] ? u[2].split(',').length : 0;
            const date = u[3] ? new Date(u[3]).toLocaleDateString() : "-";
            const maxScreens = u[4] || 1;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:bold; color:white;">${key}</td>
                <td>${duration}</td>
                <td>${maxScreens}</td>
                <td>${devices} / ${maxScreens} <button onclick="resetDevices('${key}')" style="font-size:9px; background:#444; padding:2px;">RESET</button></td>
                <td>${date}</td>
                <td>
                    <button class="action-btn btn-edit" onclick="editUser('${key}', '${duration}', '${maxScreens}')"><i class="fas fa-edit"></i></button>
                    <button class="action-btn btn-del" onclick="deleteUser('${key}')"><i class="fas fa-trash"></i></button>
                </td>
            `;
            usersBody.appendChild(tr);
        });

        const sourcesBody = document.getElementById('sources-body');
        sourcesBody.innerHTML = "";
        data.sources.forEach(s => {
            const name = s[0];
            const link = s[1];
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:bold;">${name}</td>
                <td style="color:#aaa; font-size:12px;">${link.substring(0, 50)}...</td>
                <td><button class="action-btn btn-del" onclick="deleteSource('${link}')"><i class="fas fa-trash"></i></button></td>
            `;
            sourcesBody.appendChild(tr);
        });

        document.getElementById('global-msg-input').value = data.message;
    }

    async function addUser() {
        const key = document.getElementById('new-key').value;
        const days = document.getElementById('new-days').value;
        const screens = document.getElementById('new-screens').value;
        if(!key) return alert("Mettez un ID");
        
        await fetch(`${API_URL}?action=admin_user_action&type=add&key=${encodeURIComponent(key)}&days=${days}&screens=${screens}`);
        loadData();
        document.getElementById('new-key').value = "";
    }

    async function deleteUser(key) {
        if(confirm("Supprimer " + key + " ?")) {
            await fetch(`${API_URL}?action=admin_user_action&type=delete&key=${encodeURIComponent(key)}`);
            loadData();
        }
    }

    async function editUser(key, oldDays, oldScreens) {
        const newDays = prompt("Nouvelle durée (laisser vide pour garder " + oldDays + ") :", oldDays);
        const newScreens = prompt("Nouveaux écrans Max (laisser vide pour garder " + oldScreens + ") :", oldScreens);
        
        if(newDays !== null && newScreens !== null) {
            await fetch(`${API_URL}?action=admin_user_action&type=edit&key=${encodeURIComponent(key)}&days=${newDays}&screens=${newScreens}`);
            loadData();
        }
    }

    async function resetDevices(key) {
        if(confirm("Déconnecter tous les appareils de " + key + " ?")) {
            await fetch(`${API_URL}?action=admin_user_action&type=edit&key=${encodeURIComponent(key)}&reset=yes`);
            loadData();
            alert("Appareils débloqués !");
        }
    }

    async function addSource() {
        const name = document.getElementById('new-source-name').value;
        const link = document.getElementById('new-source-link').value;
        if(!link) return;
        await fetch(`${API_URL}?action=admin_source_action&type=add&name=${encodeURIComponent(name)}&link=${encodeURIComponent(link)}`);
        loadData();
    }

    async function deleteSource(link) {
        if(confirm("Supprimer cette source ?")) {
            await fetch(`${API_URL}?action=admin_source_action&type=delete&link=${encodeURIComponent(link)}`);
            loadData();
        }
    }

    async function saveMessage() {
        const msg = document.getElementById('global-msg-input').value;
        await fetch(`${API_URL}?action=admin_set_message&msg=${encodeURIComponent(msg)}`);
        alert("Message mis à jour !");
    }

    function showTab(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }
</script>

</body>
</html>
