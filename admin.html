<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN COMMAND CENTER - ADMIN</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e50914; --bg: #0f0f0f; --panel: #1a1a1a; --text: #fff; --border: #333; --green: #2ecc71; --orange: #e67e22; }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 250px; background: #000; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; }
        .logo-area { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 15px; cursor: pointer; color: #888; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .nav-item:hover { background: #1a1a1a; color: #fff; }
        .nav-item.active { background: var(--primary); color: #fff; box-shadow: 0 5px 15px rgba(229, 9, 20, 0.3); }

        /* MAIN CONTENT */
        .main { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .title { font-size: 24px; font-weight: 700; }
        
        /* DASHBOARD CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .card h3 { margin: 0 0 10px 0; color: #888; font-size: 12px; text-transform: uppercase; }
        .card .value { font-size: 32px; font-weight: 800; }
        .card.red { border-left: 4px solid var(--primary); }
        .card.green { border-left: 4px solid var(--green); }
        .card.orange { border-left: 4px solid var(--orange); }

        /* TABLES */
        .table-container { background: var(--panel); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        .toolbar { padding: 20px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border); font-size: 14px; }
        th { background: #111; color: #888; font-weight: 600; text-transform: uppercase; font-size: 12px; }
        tr:hover { background: #222; }
        
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .badge.active { background: rgba(46, 204, 113, 0.2); color: var(--green); }
        .badge.expired { background: rgba(229, 9, 20, 0.2); color: var(--primary); }

        /* BUTTONS & INPUTS */
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #b20710; }
        .btn-icon { padding: 8px; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #333; color: #fff; cursor: pointer; }
        .btn-icon:hover { background: #fff; color: #000; }
        
        input, select { background: #000; border: 1px solid var(--border); padding: 10px; color: #fff; border-radius: 6px; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: var(--panel); padding: 30px; border-radius: 15px; width: 400px; border: 1px solid var(--border); }
        .modal h2 { margin-top: 0; color: var(--primary); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #888; font-size: 12px; }
        .form-group input, .form-group select { width: 100%; }

        /* LOGIN SCREEN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { width: 350px; text-align: center; }
        .login-box input { width: 100%; margin: 20px 0; padding: 15px; text-align: center; font-size: 20px; letter-spacing: 5px; }

        /* NOTIFICATION */
        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; padding: 15px 25px; border-radius: 8px; display: none; animation: slideIn 0.3s; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        @keyframes slideIn { from{transform: translateX(100%)} to{transform: translateX(0)} }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:var(--primary); margin-bottom:10px;">TITAN ADMIN</h1>
            <p style="color:#666;">ACCESS CONTROL</p>
            <input type="password" id="admin-pass" placeholder="••••">
            <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="adminLogin()">ENTRER</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo-area"><i class="fas fa-server"></i> ADMIN V2</div>
        <div class="nav-item active" onclick="showSection('users')"><i class="fas fa-users"></i> Utilisateurs</div>
        <div class="nav-item" onclick="showSection('sources')"><i class="fas fa-satellite-dish"></i> Sources (M3U)</div>
        <div class="nav-item" onclick="showSection('broadcast')"><i class="fas fa-bullhorn"></i> Messages</div>
        <div class="nav-item" onclick="refreshData()" style="margin-top:auto; color:var(--green);"><i class="fas fa-sync"></i> Actualiser</div>
        <div class="nav-item" onclick="logout()" style="color:var(--primary);"><i class="fas fa-sign-out-alt"></i> Quitter</div>
    </div>

    <div class="main">
        
        <div id="sec-users">
            <div class="header">
                <div class="title">Gestion des Abonnés</div>
                <button class="btn btn-primary" onclick="openModal('modal-add-user')"><i class="fas fa-plus"></i> Nouvel Abonné</button>
            </div>

            <div class="stats-grid">
                <div class="card red"><h3>Total Utilisateurs</h3><div class="value" id="stat-total">0</div></div>
                <div class="card green"><h3>Actifs</h3><div class="value" id="stat-active">0</div></div>
                <div class="card orange"><h3>Expirés</h3><div class="value" id="stat-expired">0</div></div>
            </div>

            <div class="table-container">
                <div class="toolbar">
                    <input type="text" id="searchUser" placeholder="Rechercher (ID, Device...)" style="width: 300px;" onkeyup="filterUsers()">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID Abonnement</th>
                            <th>Appareil (Device ID)</th>
                            <th>Expiration</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="sec-sources" style="display:none;">
            <div class="header">
                <div class="title">Sources & Playlists</div>
                <button class="btn btn-primary" onclick="openModal('modal-add-source')"><i class="fas fa-plus"></i> Ajouter Source</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nom du Bouquet</th>
                            <th>URL du Flux (M3U)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="source-table-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="sec-broadcast" style="display:none;">
            <div class="header"><div class="title">Diffusion Message</div></div>
            <div class="card" style="max-width: 600px;">
                <h3>Message Global (Maintenance, Info...)</h3>
                <p style="color:#666; font-size:12px; margin-bottom:15px;">Ce message s'affichera en pop-up sur tous les écrans des utilisateurs connectés.</p>
                <div class="form-group">
                    <input type="text" id="global-msg" placeholder="Ex: Maintenance serveur dans 10 minutes...">
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="sendMessage()">ENVOYER</button>
                    <button class="btn" style="background:#333; color:#fff;" onclick="clearMessage()">EFFACER</button>
                </div>
            </div>
        </div>

    </div>

    <div id="modal-add-user" class="modal">
        <div class="modal-content">
            <h2>Nouvel Abonnement</h2>
            <div class="form-group">
                <label>Clé d'abonnement (ID)</label>
                <input type="text" id="new-key" placeholder="Généré auto ou manuel">
            </div>
            <div class="form-group">
                <label>Durée</label>
                <select id="new-duration">
                    <option value="30">1 Mois (30j)</option>
                    <option value="90">3 Mois (90j)</option>
                    <option value="180">6 Mois (180j)</option>
                    <option value="365">1 An (365j)</option>
                    <option value="9999">Illimité</option>
                </select>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" style="flex:1;" onclick="submitNewUser()">CRÉER</button>
                <button class="btn" style="background:#333; color:#fff; flex:1;" onclick="closeModal()">ANNULER</button>
            </div>
        </div>
    </div>

    <div id="modal-add-source" class="modal">
        <div class="modal-content">
            <h2>Nouvelle Source</h2>
            <div class="form-group">
                <label>Nom du Bouquet</label>
                <input type="text" id="src-name" placeholder="Ex: Canal+, Sports...">
            </div>
            <div class="form-group">
                <label>URL M3U</label>
                <input type="text" id="src-url" placeholder="http://serveur.com/file.m3u">
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" style="flex:1;" onclick="submitNewSource()">AJOUTER</button>
                <button class="btn" style="background:#333; color:#fff; flex:1;" onclick="closeModal()">ANNULER</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Action effectuée</div>

<script>
    // ==========================================
    // CONFIGURATION ADMIN
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbwg49-A8a5q72hnhcf99865CBqAErbxAMUX4TDDsR47anl4ELo6iZhDzS2hH4yMMJ1CcQ/exec";
    const ADMIN_PASS = "admin123"; // CHANGE CE MOT DE PASSE !!!
    
    // --- VARIABLES ---
    let usersData = [];
    let sourcesData = [];

    // --- AUTH ---
    function adminLogin() {
        const p = document.getElementById('admin-pass').value;
        if(p === ADMIN_PASS) {
            document.getElementById('login-screen').style.display = 'none';
            refreshData();
        } else {
            alert("Accès Refusé");
        }
    }

    function logout() { location.reload(); }

    // --- CORE DATA FETCHING ---
    async function refreshData() {
        showToast("Chargement des données...");
        try {
            // On simule une requête ADMIN qui récupère tout
            // Note: Ton Google Script doit avoir une action ?action=admin_get_all
            // Si tu n'as pas mis à jour ton script Google, cela ne marchera pas.
            // Je vais supposer que tu vas mettre à jour le script ou que tu utilises le mode "Mock" pour l'instant.
            
            // Pour l'instant, je vais faire des appels séparés si ton script ne supporte pas le "bulk"
            // Mais pour une vraie admin, il faut modifier le script Google.
            
            // Appel API (Adapté à ton script actuel si possible, sinon demande mise à jour script)
            const res = await fetch(`${API_URL}?action=admin_get_all`); 
            const data = await res.json();
            
            usersData = data.users || [];
            sourcesData = data.sources || [];
            
            renderUsers();
            renderSources();
            updateStats();
            showToast("Données à jour");

        } catch(e) {
            console.error(e);
            // Mode Démo si pas de connexion API Admin valide
            showToast("Erreur API - Mode Démo activé (Vérifie ton Google Script)");
            usersData = [
                {key: "TEST-USER-1", device: "DEV-XH55", expiry: "2026-01-01", status: "Active"},
                {key: "TEST-USER-2", device: "None", expiry: "2024-12-31", status: "Expired"}
            ];
            renderUsers();
            updateStats();
        }
    }

    // --- RENDERING ---
    function renderUsers() {
        const tbody = document.getElementById('user-table-body');
        tbody.innerHTML = "";
        const term = document.getElementById('searchUser').value.toLowerCase();

        usersData.forEach(u => {
            if(u.key.toLowerCase().includes(term) || (u.device && u.device.toLowerCase().includes(term))) {
                const isExpired = new Date(u.expiry) < new Date();
                const statusClass = isExpired ? 'expired' : 'active';
                const statusText = isExpired ? 'Expiré' : 'Actif';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><b>${u.key}</b></td>
                    <td style="font-family:monospace; color:#888;">${u.device || "Non connecté"}</td>
                    <td>${u.expiry.split('T')[0]}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <div style="display:flex; gap:5px;">
                            <div class="btn-icon" onclick="resetDevice('${u.key}')" title="Reset Device"><i class="fas fa-mobile-alt"></i></div>
                            <div class="btn-icon" style="background:#c0392b;" onclick="deleteUser('${u.key}')" title="Supprimer"><i class="fas fa-trash"></i></div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        });
    }

    function renderSources() {
        const tbody = document.getElementById('source-table-body');
        tbody.innerHTML = "";
        sourcesData.forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><b>${s.name}</b></td>
                <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:#888;">${s.url}</td>
                <td>
                    <div class="btn-icon" style="background:#c0392b;" onclick="deleteSource('${s.name}')"><i class="fas fa-trash"></i></div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateStats() {
        const total = usersData.length;
        const active = usersData.filter(u => new Date(u.expiry) >= new Date()).length;
        document.getElementById('stat-total').innerText = total;
        document.getElementById('stat-active').innerText = active;
        document.getElementById('stat-expired').innerText = total - active;
    }

    // --- ACTIONS USER ---
    async function submitNewUser() {
        const key = document.getElementById('new-key').value || "USER-"+Math.floor(Math.random()*100000);
        const days = document.getElementById('new-duration').value;
        
        showToast("Création en cours...");
        try {
            await fetch(`${API_URL}?action=admin_add_user&key=${encodeURIComponent(key)}&days=${days}`, {method: 'POST'});
            closeModal();
            refreshData();
            showToast("Utilisateur créé !");
        } catch(e) { showToast("Erreur création"); }
    }

    async function deleteUser(key) {
        if(!confirm("Supprimer l'utilisateur " + key + " ?")) return;
        try {
            await fetch(`${API_URL}?action=admin_delete_user&key=${encodeURIComponent(key)}`, {method: 'POST'});
            refreshData();
        } catch(e) { showToast("Erreur suppression"); }
    }

    async function resetDevice(key) {
        if(!confirm("Réinitialiser l'appareil pour " + key + " ?")) return;
        try {
            await fetch(`${API_URL}?action=admin_reset_device&key=${encodeURIComponent(key)}`, {method: 'POST'});
            showToast("Appareil réinitialisé");
            refreshData();
        } catch(e) { showToast("Erreur reset"); }
    }

    // --- ACTIONS SOURCE ---
    async function submitNewSource() {
        const name = document.getElementById('src-name').value;
        const url = document.getElementById('src-url').value;
        if(!name || !url) return alert("Remplir tout");

        try {
            await fetch(`${API_URL}?action=admin_add_source&name=${encodeURIComponent(name)}&url=${encodeURIComponent(url)}`, {method: 'POST'});
            closeModal();
            refreshData();
        } catch(e) { showToast("Erreur ajout source"); }
    }

    async function deleteSource(name) {
        if(!confirm("Supprimer la source " + name + " ?")) return;
        try {
            await fetch(`${API_URL}?action=admin_delete_source&name=${encodeURIComponent(name)}`, {method: 'POST'});
            refreshData();
        } catch(e) { showToast("Erreur suppression source"); }
    }

    // --- MESSAGING ---
    async function sendMessage() {
        const msg = document.getElementById('global-msg').value;
        await fetch(`${API_URL}?action=admin_set_message&msg=${encodeURIComponent("MSG:"+msg)}`, {method: 'POST'});
        showToast("Message envoyé");
    }
    
    async function clearMessage() {
        document.getElementById('global-msg').value = "";
        await fetch(`${API_URL}?action=admin_set_message&msg=`, {method: 'POST'});
        showToast("Message effacé");
    }

    // --- UI UTILS ---
    function showSection(id) {
        document.querySelectorAll('[id^="sec-"]').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('sec-' + id).style.display = 'block';
        // Highlight active nav item (simplifié)
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal() { document.querySelectorAll('.modal').forEach(el => el.style.display = 'none'); }
    
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    function filterUsers() { renderUsers(); }

</script>
</body>
</html>
