<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Box TV - V122 Smart Start</title>
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- DESIGN ORIGINAL V121 (CONSERVÃ‰) --- */
        :root { --primary: #e50914; --glass: rgba(15, 15, 15, 0.95); --text: #fff; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #000; color: var(--text); height: 100vh; overflow: hidden; }

        #video-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: #000; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        /* Ã‰CRAN D'ACCUEIL TV (NOUVEAU) */
        #home-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #1a1a1a 0%, #000 100%); z-index: 5; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; transition: opacity 0.8s; }
        #home-screen img { width: 150px; margin-bottom: 20px; filter: drop-shadow(0 0 10px rgba(229,9,20,0.5)); animation: pulse-logo 3s infinite; }
        @keyframes pulse-logo { 0%, 100% { opacity: 0.7; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } }

        /* STATUS PILL & SIGNAL */
        #status-pill { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); padding: 8px 15px; border-radius: 20px; border: 1px solid #444; font-size: 12px; color: #fff; z-index: 60; display: flex; align-items: center; gap: 10px; pointer-events: none; }
        #led { width: 8px; height: 8px; background: red; border-radius: 50%; transition: 0.3s; box-shadow: 0 0 5px red; }
        #led.green { background: #0f0; box-shadow: 0 0 5px #0f0; }
        #led.orange { background: orange; box-shadow: 0 0 5px orange; }
        .signal-container { display: flex; align-items: flex-end; gap: 3px; height: 14px; }
        .sig-bar { width: 4px; background: #444; border-radius: 1px; }
        .sig-bar.b1 { height: 25%; } .sig-bar.b2 { height: 50%; } .sig-bar.b3 { height: 75%; } .sig-bar.b4 { height: 100%; }
        .sig-lvl-4 .sig-bar { background: #00ff00; }

        /* MENU LATERAL */
        #channel-menu { position: fixed; top: 0; left: 0; width: 350px; height: 100%; background: var(--glass); backdrop-filter: blur(15px); transform: translateX(-100%); transition: transform 0.3s; display: flex; flex-direction: column; z-index: 100; pointer-events: auto; border-right: 1px solid #333; }
        body.menu-open #channel-menu { transform: translateX(0); }
        .menu-header { padding: 15px; background: #111; border-bottom: 2px solid var(--primary); display: flex; flex-direction:column; align-items: center; gap:5px;}
        #searchInput { width: 95%; margin: 5px auto; padding: 10px; border-radius: 5px; background: #333; border: none; color: white; display: block; font-size: 14px; }
        .filter-bar { display: flex; gap: 5px; padding: 5px 10px; border-bottom: 1px solid #333; background: #1a1a1a; }
        .btn-mini { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #2a2a2a; color: #ccc; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-weight: 600; }
        .btn-mini.active { background: #333; color: white; border-color: #666; }
        
        #channel-list { flex: 1; overflow-y: auto; padding: 0; width:100%; }
        .channel-row { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #222; cursor: pointer; }
        .channel-row.active { background: rgba(229,9,20,0.2); border-left: 3px solid var(--primary); }
        .ch-logo { width: 35px; height: 35px; object-fit: contain; background: #fff; padding: 2px; border-radius: 3px; margin-right: 10px; }

        /* VUE GRILLE */
        .grid-view { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 10px; }
        .grid-card { background: #222; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #333; aspect-ratio: 1/1; cursor: pointer; }
        .grid-card.active { border-color: var(--primary); background: #330000; }
        .grid-img { width: 40px; height: 40px; object-fit: contain; background: #fff; padding: 2px; border-radius: 5px; margin-bottom: 5px; }
        .grid-title { font-size: 9px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }

        /* BARRE DU BAS */
        #bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); padding: 8px 15px; border-radius: 40px; border: 1px solid #333; display: flex; gap: 10px; align-items: center; z-index: 90; pointer-events: auto; }
        .btn-ctrl { width: 45px; height: 45px; border-radius: 50%; background: #2a2a2a; color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; }
        .btn-large { width: 55px; height: 55px; font-size: 22px; background: var(--primary); border: 2px solid white; }

        /* MODALS CUSTOM */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center; pointer-events: auto; }
        .modal-box { background: #1a1a1a; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #444; }
        .btn-modal { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 50px; font-weight: bold; cursor: pointer; margin: 10px; min-width: 120px; }
        
        #scan-info { width: 90%; display: none; flex-direction: column; gap: 5px; margin-bottom: 5px; }
        #scan-progress { width: 100%; height: 2px; background: #333; position: relative; overflow: hidden; }
        #scan-bar { position: absolute; left: 0; top: 0; height: 100%; width: 50%; background: #0f0; animation: scanAnim 1s infinite linear; }
        @keyframes scanAnim { 0% {left: -50%;} 100% {left: 100%;} }
    </style>
</head>
<body>

<div id="home-screen">
    <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png">
    <h2 style="font-weight: 800; letter-spacing: 2px;">MY BOX TV</h2>
    <p id="welcome-status" style="color: #888; font-size: 12px; margin-top: 10px;">SystÃ¨me prÃªt</p>
</div>

<div id="resume-modal" class="modal">
    <div class="modal-box" style="border: 1px solid var(--primary);">
        <h3 style="color:var(--primary); margin-bottom: 10px;">REPRISE</h3>
        <p style="color: white; font-size: 14px;">Voulez-vous continuer Ã  regarder ?</p>
        <p id="last-ch-name" style="font-weight: bold; margin: 15px 0; color: lime;"></p>
        <div style="display: flex; justify-content: center;">
            <button class="btn-modal" onclick="resumeLast()">OUI</button>
            <button class="btn-modal" style="background:#444;" onclick="closeResume()">NON</button>
        </div>
    </div>
</div>

<div id="custom-alert" class="modal">
    <div class="modal-box">
        <p id="alert-text"></p>
        <button class="btn-modal" onclick="closeAlert()">OK</button>
    </div>
</div>

<div id="custom-confirm" class="modal">
    <div class="modal-box">
        <p id="confirm-text"></p>
        <div style="display:flex; justify-content:center;">
            <button class="btn-modal" id="confirm-yes">OUI</button>
            <button class="btn-modal" style="background:#444;" onclick="closeConfirm()">NON</button>
        </div>
    </div>
</div>

<div id="login-screen" class="modal" style="display:flex;">
    <div class="modal-box">
        <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" style="width:100px; margin-bottom:20px;">
        <input type="text" id="licenseKey" placeholder="ID ABONNEMENT" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:5px; text-align:center; font-size:18px; margin-bottom:15px;">
        <button onclick="login()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:5px; font-weight:bold;">ENTRER</button>
    </div>
</div>

<div id="video-layer"><video id="video" onclick="toggleMenu()" playsinline crossorigin="anonymous"></video></div>

<div id="ui-layer">
    <div id="status-pill">
        <div id="led"></div>
        <div class="signal-container" id="sig-meter">
            <div class="sig-bar b1"></div><div class="sig-bar b2"></div><div class="sig-bar b3"></div><div class="sig-bar b4"></div>
        </div>
        <span id="status-text">PrÃªt</span>
    </div>
    
    <div id="channel-menu">
        <div class="menu-header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" style="width:100px;">
            <div style="display:flex; align-items:center; width:100%; justify-content:space-between;">
                <div style="text-align:left;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:12px; font-weight:bold;">CHAÃŽNES</span>
                        <i class="fas fa-th" id="view-icon" onclick="toggleView()" style="cursor:pointer; font-size:12px;"></i>
                        <i class="fas fa-sync-alt" onclick="quickScan()" style="cursor:pointer; font-size:12px;"></i>
                    </div>
                    <div id="count-display" style="font-size:9px; color:#888;">0 trouvÃ©es</div>
                    <div id="scan-info"><div id="scan-progress"><div id="scan-bar"></div></div></div>
                </div>
                <i class="fas fa-cog" onclick="openSettings()" style="cursor:pointer; color:#fff; font-size:18px;"></i>
            </div>
        </div>
        <input type="text" id="searchInput" placeholder="ðŸ” Rechercher..." oninput="renderList(true)">
        <div id="channel-list"></div>
    </div>

    <div id="bottom-bar">
        <button class="btn-ctrl" onclick="prevChannel()"><i class="fas fa-step-backward"></i></button>
        <button class="btn-ctrl btn-large" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
        <button class="btn-ctrl" onclick="nextChannel()"><i class="fas fa-step-forward"></i></button>
        <button class="btn-ctrl" onclick="toggleFullScreen()"><i class="fas fa-expand"></i></button>
    </div>
</div>

<script>
    // CONFIGURATION
    const API_URL = "https://script.google.com/macros/s/AKfycbyTVVHd3DGbEtlRfVN5aboerVM1UEbDYTGv4vJxabValUYDAHRxgLoFppjUO8xwv9SsTw/exec";
    const DEFAULT_CHANNEL = { name: "Novelas TV", url: "https://stormcast-telenovelatv-1-fr.samsung.wurl.tv/playlist.m3u8" };
    const DB_NAME = "MyBoxTV_V62_Final";

    let allChannels = [], displayedChannels = [], loadedUrls = new Set();
    let currentChannelIndex = 0;
    let hls = null;
    let deviceId = localStorage.getItem('mybox_device_id') || 'DEV-'+Math.random().toString(36).substr(2,9).toUpperCase();
    localStorage.setItem('mybox_device_id', deviceId);
    
    let isGridMode = localStorage.getItem('mybox_view') === 'grid';
    let appMode = localStorage.getItem('mybox_mode') || 'premium';

    const video = document.getElementById('video');
    const statusText = document.getElementById('status-text');

    // --- CERVEAU DATA (SOUVENIR DE LA CHAÃŽNE) ---
    function saveLastChannel(ch) {
        localStorage.setItem('mybox_last_url', ch.url);
        localStorage.setItem('mybox_last_name', ch.name);
    }

    // --- ALERTS CUSTOM ---
    function myAlert(msg) { document.getElementById('alert-text').innerText = msg; document.getElementById('custom-alert').style.display = 'flex'; }
    function closeAlert() { document.getElementById('custom-alert').style.display = 'none'; }
    function myConfirm(msg, callback) { 
        document.getElementById('confirm-text').innerText = msg; 
        document.getElementById('custom-confirm').style.display = 'flex';
        document.getElementById('confirm-yes').onclick = () => { closeConfirm(); callback(); };
    }
    function closeConfirm() { document.getElementById('custom-confirm').style.display = 'none'; }

    // --- INITIALISATION ---
    if(localStorage.getItem('mybox_auth') === 'OK') {
        document.getElementById('login-screen').style.display = 'none';
        initApp();
    }

    async function initApp() {
        document.getElementById('welcome-status').innerText = "Chargement des chaÃ®nes...";
        
        // Charger la liste selon le mode (Premium ou Transpondeur)
        const action = (appMode === 'premium') ? "get_playlists" : "admin_get_m3u_sources";
        try {
            const res = await fetch(`${API_URL}?action=${action}`);
            const data = await res.json();
            
            if(appMode === 'premium') {
                allChannels = [DEFAULT_CHANNEL, ...data];
            } else {
                // Pour le mode transpondeur brut (on commence avec le cache ou novelas)
                allChannels = [DEFAULT_CHANNEL];
            }
            renderList(true);
            
            // --- LOGIQUE SMART START ---
            const lastUrl = localStorage.getItem('mybox_last_url');
            const lastName = localStorage.getItem('mybox_last_name');

            if (lastUrl) {
                document.getElementById('last-ch-name').innerText = lastName;
                document.getElementById('resume-modal').style.display = 'flex';
            } else {
                document.getElementById('welcome-status').innerText = "SystÃ¨me prÃªt. Ouvrez le menu.";
            }
        } catch(e) { 
            myAlert("Erreur de connexion au serveur.");
        }
    }

    function resumeLast() {
        const lastUrl = localStorage.getItem('mybox_last_url');
        const idx = allChannels.findIndex(c => c.url === lastUrl);
        closeResume();
        playChannel(idx >= 0 ? idx : 0);
    }

    function closeResume() {
        document.getElementById('resume-modal').style.display = 'none';
        document.getElementById('welcome-status').innerText = "Mode Veille - Menu requis";
    }

    function playChannel(index) {
        if(!allChannels[index]) return;
        const ch = allChannels[index];
        currentChannelIndex = index;
        
        // Sauvegarder dans le cerveau
        saveLastChannel(ch);

        // Effet TV : Retirer l'Ã©cran d'accueil
        document.getElementById('home-screen').style.opacity = "0";
        setTimeout(() => document.getElementById('home-screen').style.display = "none", 800);

        document.body.classList.remove('menu-open');
        statusText.innerText = ch.name;
        document.getElementById('led').className = "green";

        if(Hls.isSupported()) {
            if(hls) hls.destroy();
            hls = new Hls();
            hls.loadSource(ch.url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else {
            video.src = ch.url;
            video.play();
        }
        renderList(true);
    }

    // --- FONCTIONS EXISTANTES (GRILLE / RECHERCHE / LOGIN) ---
    function toggleView() { isGridMode = !isGridMode; localStorage.setItem('mybox_view', isGridMode?'grid':'list'); renderList(true); }

    function renderList(reset = false) {
        const list = document.getElementById('channel-list');
        const term = document.getElementById('searchInput').value.toLowerCase();
        displayedChannels = allChannels.filter(c => c.name.toLowerCase().includes(term));
        
        list.innerHTML = "";
        list.className = isGridMode ? "grid-view" : "";
        
        displayedChannels.forEach((ch, i) => {
            const isPlaying = (ch.url === localStorage.getItem('mybox_last_url'));
            const div = document.createElement('div');
            div.className = (isGridMode ? 'grid-card ' : 'channel-row ') + (isPlaying ? 'active' : '');
            
            if(isGridMode) {
                div.innerHTML = `<img src="https://via.placeholder.com/40?text=TV" class="grid-img"><div class="grid-title">${ch.name}</div>`;
            } else {
                div.innerHTML = `<img src="https://via.placeholder.com/40?text=TV" class="ch-logo"><div><div style="font-weight:600; font-size:13px;">${ch.name}</div></div>`;
            }
            
            div.onclick = () => playChannel(allChannels.indexOf(ch));
            list.appendChild(div);
        });
        document.getElementById('count-display').innerText = allChannels.length + " ChaÃ®nes";
    }

    async function login() {
        const key = document.getElementById('licenseKey').value.trim();
        const res = await fetch(`${API_URL}?action=login&key=${encodeURIComponent(key)}&device=${encodeURIComponent(deviceId)}`);
        const text = await res.text();
        if(text.includes("SUCCESS")) {
            localStorage.setItem('mybox_auth', 'OK');
            localStorage.setItem('mybox_key', key);
            document.getElementById('login-screen').style.display = 'none';
            initApp();
        } else { myAlert("ID Invalide ou expirÃ©."); }
    }

    function toggleMenu() { document.body.classList.toggle('menu-open'); }
    function nextChannel() { playChannel((currentChannelIndex + 1) % allChannels.length); }
    function prevChannel() { playChannel((currentChannelIndex - 1 + allChannels.length) % allChannels.length); }
    function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
</script>
</body>
</html>
