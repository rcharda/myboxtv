<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cha√Ænes Locales & Monde</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #0f0f0f; color: white; font-family: 'Montserrat', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* HEADER */
        .header { background: #1a1a1a; padding: 15px; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #e50914; box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 10; }
        .back-btn { background: #333; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size:16px;}
        .search-bar { flex: 1; padding: 12px; border-radius: 30px; border: 1px solid #444; background: #222; color: white; font-size: 14px; padding-left: 20px; }
        
        /* GRILLE DE CONTENU */
        .content-area { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; align-content: flex-start; }
        
        /* CARTE CHAINE */
        .card { 
            background: #1e1e1e; border-radius: 8px; height: 110px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; border: 1px solid #333; position: relative; overflow: hidden;
        }
        .card:active { background: #e50914; border-color: white; transform: scale(0.98); }
        .card-img { width: 45px; height: 45px; object-fit: contain; margin-bottom: 8px; border-radius: 5px; background: #fff; padding: 2px; }
        .card-title { font-size: 10px; text-align: center; font-weight: 600; padding: 0 5px; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-cat { font-size: 8px; color: #aaa; margin-top: 2px; }
        
        /* LOADING */
        .loader-bar { width: 100%; height: 3px; background: #222; position: fixed; top: 0; left: 0; z-index: 20; }
        .progress { height: 100%; background: #e50914; width: 0%; transition: width 0.3s; box-shadow: 0 0 10px #e50914; }
        .status-pill { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 8px 20px; border-radius: 20px; font-size: 11px; border: 1px solid #444; z-index: 50; display:flex; gap:10px;}

        /* LECTEUR PLEIN ECRAN */
        #player-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 100; display: none; flex-direction: column; }
        video { width: 100%; height: 100%; object-fit: contain; flex: 1; }
        .player-controls { padding: 10px; background: rgba(20,20,20,0.9); display: flex; justify-content: space-between; align-items: center; }
        .close-player { background: #e50914; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="loader-bar"><div class="progress" id="scan-prog"></div></div>

    <div class="header">
        <button class="back-btn" onclick="window.location.href='index.html'">
            <i class="fas fa-home"></i>
        </button>
        <input type="text" class="search-bar" id="searchInput" placeholder="üîç Rechercher une cha√Æne...">
    </div>

    <div class="content-area" id="grid"></div>

    <div class="status-pill">
        <span id="status-text">Connexion...</span>
        <span id="count" style="color:#e50914; font-weight:bold;">0</span>
    </div>

    <div id="player-overlay">
        <div class="player-controls">
            <span id="playing-title" style="font-weight:bold; font-size:14px;">Lecture...</span>
            <button class="close-player" onclick="closePlayer()">FERMER</button>
        </div>
        <video id="video" controls autoplay playsinline></video>
    </div>

<script>
    // --- M√äME CONFIGURATION QUE V79 ---
    const API_URL = "https://script.google.com/macros/s/AKfycbwg49-A8a5q72hnhcf99865CBqAErbxAMUX4TDDsR47anl4ELo6iZhDzS2hH4yMMJ1CcQ/exec";
    const PROXY = "https://corsproxy.io/?";
    
    let allChannels = [];
    let hls = null;
    const video = document.getElementById('video');

    window.onload = fetchTransponders;

    // 1. R√©cup√©rer la liste des liens (Transponders) depuis Excel
    async function fetchTransponders() {
        document.getElementById('status-text').innerText = "R√©cup√©ration sources...";
        try {
            const res = await fetch(`${API_URL}?action=get_playlists`);
            const sources = await res.json();
            
            let completed = 0;
            // Scan en parall√®le (Ultra Rapide)
            sources.forEach(src => {
                fetchStream(src.url, src.name, () => {
                    completed++;
                    document.getElementById('scan-prog').style.width = (completed / sources.length * 100) + "%";
                    if(completed === sources.length) document.getElementById('status-text').innerText = "Termin√©.";
                });
            });
        } catch(e) {
            document.getElementById('status-text').innerText = "Erreur connexion";
        }
    }

    // 2. Moteur de lecture de flux (Compatible 20k chaines)
    async function fetchStream(url, sourceName, onComplete) {
        document.getElementById('status-text').innerText = "Scan: " + sourceName;
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), 60000);

        try {
            const response = await fetch(PROXY + encodeURIComponent(url), { signal: controller.signal });
            clearTimeout(id);
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";
            let batch = [];

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                let lines = buffer.split("\n");
                buffer = lines.pop();
                processChunk(lines, batch);
                if(batch.length > 20) flushGrid(batch);
            }
            processChunk([buffer], batch);
            flushGrid(batch);
        } catch(e) { console.log("Skip " + url); }
        onComplete();
    }

    let currentInfo = null;
    function processChunk(lines, batch) {
        for(let line of lines) {
            line = line.trim();
            if(!line) continue;
            if(line.startsWith('#EXTINF')) {
                let name = line.split(',')[1] || "Cha√Æne";
                let logo = (line.match(/tvg-logo=["']?([^"']*)["']?/) || [])[1];
                let cat = "Autres";
                // D√©tection intelligente du dossier
                let grp = line.match(/group-title=["']?([^"']*)["']?/);
                if(grp) cat = grp[1].replace(/;/g, " ").trim();
                
                currentInfo = { name: name, logo: logo, cat: cat };
            } else if(line.startsWith('http')) {
                if(currentInfo) {
                    batch.push({...currentInfo, url: line});
                    currentInfo = null;
                }
            }
        }
    }

    function flushGrid(batch) {
        if(batch.length === 0) return;
        const grid = document.getElementById('grid');
        const frag = document.createDocumentFragment();
        
        batch.forEach(ch => {
            allChannels.push(ch);
            const div = document.createElement('div');
            div.className = "card";
            div.innerHTML = `
                <img src="${ch.logo || 'https://via.placeholder.com/40'}" class="card-img" loading="lazy" onerror="this.src='https://via.placeholder.com/40'">
                <div class="card-title">${ch.name}</div>
                <div class="card-cat">${ch.cat}</div>
            `;
            div.onclick = () => openPlayer(ch);
            frag.appendChild(div);
        });
        
        grid.appendChild(frag);
        document.getElementById('count').innerText = allChannels.length;
    }

    // --- RECHERCHE INSTANTAN√âE ---
    document.getElementById('searchInput').addEventListener('input', function(e) {
        const term = e.target.value.toLowerCase();
        const cards = document.querySelectorAll('.card');
        
        // Mode optimis√© : on masque/affiche via CSS
        cards.forEach(card => {
            if(card.innerText.toLowerCase().includes(term)) card.style.display = "flex";
            else card.style.display = "none";
        });
    });

    // --- LECTEUR AVEC AUTO-REPARATION ---
    function openPlayer(ch) {
        document.getElementById('player-overlay').style.display = "flex";
        document.getElementById('playing-title').innerText = ch.name;
        
        if(Hls.isSupported()) {
            if(hls) hls.destroy();
            hls = new Hls();
            hls.loadSource(ch.url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            
            // Si erreur, on tente le proxy de r√©paration
            hls.on(Hls.Events.ERROR, (e,d) => {
                if(d.fatal) {
                    hls.destroy(); hls = new Hls();
                    hls.loadSource(PROXY + encodeURIComponent(ch.url));
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                }
            });
        } else if(video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = ch.url;
            video.play();
        }
    }

    function closePlayer() {
        document.getElementById('player-overlay').style.display = "none";
        video.pause(); video.src = "";
        if(hls) hls.destroy();
    }
</script>
</body>
</html>
