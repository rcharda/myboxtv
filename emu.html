<!DOCTYPE html>

<html lang="fr">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta name="theme-color" content="#000000">

    <title>Chaînes Locales & Monde</title>

    

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

    

    <style>

        :root { --primary: #e50914; --bg: #000000; --card-bg: #1a1a1a; --text: #ffffff; }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }

        

        body { 

            margin: 0; 

            background: var(--bg); 

            color: var(--text); 

            font-family: 'Montserrat', sans-serif; 

            display: flex; 

            flex-direction: column; 

            height: 100vh; 

            overflow: hidden; 

        }

        

        /* HEADER STYLE MY BOX TV */

        .header { 

            background: rgba(20, 20, 20, 0.95); 

            padding: 15px; 

            display: flex; 

            align-items: center; 

            gap: 15px; 

            border-bottom: 2px solid var(--primary); 

            box-shadow: 0 5px 20px rgba(229, 9, 20, 0.2); 

            z-index: 10; 

        }

        

        .back-btn { 

            background: #2a2a2a; 

            color: white; 

            border: 1px solid #444; 

            width: 40px; 

            height: 40px; 

            border-radius: 50%; 

            cursor: pointer; 

            display: flex; 

            align-items: center; 

            justify-content: center;

            font-size: 18px;

            transition: 0.2s;

        }

        .back-btn:active { transform: scale(0.9); background: var(--primary); border-color: var(--primary); }

        

        .search-container { flex: 1; position: relative; }

        .search-bar { 

            width: 100%; 

            padding: 12px 15px 12px 40px; 

            border-radius: 30px; 

            border: 1px solid #333; 

            background: #222; 

            color: white; 

            font-size: 14px; 

            font-family: 'Montserrat', sans-serif;

        }

        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #888; }

        

        /* GRILLE DE CONTENU */

        .content-area { 

            flex: 1; 

            overflow-y: auto; 

            padding: 15px; 

            display: grid; 

            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); 

            gap: 12px; 

            align-content: flex-start; 

        }

        

        /* CARTE CHAINE (STYLE PREMIUM) */

        .card { 

            background: var(--card-bg); 

            border-radius: 10px; 

            height: 120px;

            display: flex; 

            flex-direction: column; 

            align-items: center; 

            justify-content: center; 

            cursor: pointer; 

            border: 1px solid #333; 

            position: relative; 

            overflow: hidden;

            transition: 0.2s;

        }

        .card:active { border-color: var(--primary); background: #222; transform: scale(0.95); }

        

        .card-img { 

            width: 50px; 

            height: 50px; 

            object-fit: contain; 

            margin-bottom: 10px; 

            border-radius: 8px; 

            background: #fff; 

            padding: 3px; 

            box-shadow: 0 0 10px rgba(0,0,0,0.5);

        }

        

        .card-title { 

            font-size: 11px; 

            text-align: center; 

            font-weight: 700; 

            padding: 0 5px; 

            width: 100%; 

            white-space: nowrap; 

            overflow: hidden; 

            text-overflow: ellipsis; 

        }

        .card-cat { font-size: 9px; color: var(--primary); margin-top: 3px; text-transform: uppercase; font-weight: bold; }

        

        /* BARRE DE CHARGEMENT */

        .loader-container { position: fixed; top: 68px; left: 0; width: 100%; height: 2px; background: transparent; z-index: 20; }

        .progress { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; box-shadow: 0 0 10px var(--primary); }

        

        /* STATUS PILL (DESIGN APP) */

        .status-pill { 

            position: fixed; 

            bottom: 20px; 

            left: 50%; 

            transform: translateX(-50%); 

            background: rgba(20, 20, 20, 0.9); 

            backdrop-filter: blur(10px);

            padding: 8px 20px; 

            border-radius: 30px; 

            font-size: 11px; 

            border: 1px solid #444; 

            z-index: 50; 

            display: flex; 

            align-items: center;

            gap: 10px;

            box-shadow: 0 5px 20px rgba(0,0,0,0.5);

        }

        .led { width: 8px; height: 8px; background: #444; border-radius: 50%; }

        .led.active { background: #0f0; box-shadow: 0 0 5px #0f0; }

        .led.busy { background: orange; box-shadow: 0 0 5px orange; }



        /* LECTEUR VIDEO OVERLAY */

        #player-overlay { 

            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 

            background: #000; z-index: 200; display: none; 

            flex-direction: column; 

        }

        video { width: 100%; height: 100%; object-fit: contain; flex: 1; }

        

        .player-header {

            padding: 15px;

            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);

            position: absolute; top: 0; left: 0; width: 100%;

            display: flex; justify-content: space-between; align-items: center;

            z-index: 210;

        }

        .close-btn {

            background: rgba(255,255,255,0.2); color: white; border: none;

            width: 35px; height: 35px; border-radius: 50%;

            display: flex; align-items: center; justify-content: center;

            font-size: 16px; cursor: pointer; backdrop-filter: blur(5px);

        }

    </style>

</head>

<body>



    <div class="header">

        <button class="back-btn" onclick="window.location.href='index.html'">

            <i class="fas fa-arrow-left"></i>

        </button>

        <div class="search-container">

            <i class="fas fa-search search-icon"></i>

            <input type="text" class="search-bar" id="searchInput" placeholder="Chercher une chaîne..." oninput="filterGrid()">

        </div>

    </div>



    <div class="loader-container"><div class="progress" id="scan-prog"></div></div>



    <div class="content-area" id="grid">

        <div style="text-align:center; color:#666; grid-column: 1/-1; margin-top:50px;">

            <i class="fas fa-satellite-dish" style="font-size:30px; margin-bottom:10px;"></i><br>

            Chargement des flux...

        </div>

    </div>



    <div class="status-pill">

        <div class="led" id="status-led"></div>

        <span id="status-text">Initialisation...</span>

        <span id="count" style="color:var(--primary); font-weight:bold;">0</span>

    </div>



    <div id="player-overlay">

        <div class="player-header">

            <span id="playing-title" style="font-weight:bold; font-size:14px; text-shadow:0 2px 5px black;">Lecture...</span>

            <button class="close-btn" onclick="closePlayer()">✕</button>

        </div>

        <video id="video" controls autoplay playsinline></video>

    </div>



<script>

    const API_URL = "https://script.google.com/macros/s/AKfycbwg49-A8a5q72hnhcf99865CBqAErbxAMUX4TDDsR47anl4ELo6iZhDzS2hH4yMMJ1CcQ/exec";

    const PROXY = "https://corsproxy.io/?";

    

    let allChannels = []; // Stocke TOUTES les chaînes en mémoire

    let hls = null;

    const video = document.getElementById('video');

    const led = document.getElementById('status-led');



    window.onload = startApp;



    async function startApp() {

        led.className = "led busy";

        document.getElementById('status-text').innerText = "Récupération...";

        

        try {

            // 1. Récupérer la liste des M3U

            const res = await fetch(`${API_URL}?action=get_playlists`);

            const sources = await res.json();

            

            // 2. Scanner UN PAR UN pour éviter le crash (Sequential Loading)

            document.getElementById('grid').innerHTML = ""; // Vider le loader

            

            for (let i = 0; i < sources.length; i++) {

                const src = sources[i];

                document.getElementById('status-text').innerText = `Chargement: ${src.name}`;

                document.getElementById('scan-prog').style.width = ((i + 1) / sources.length * 100) + "%";

                

                // On attend que le fichier soit traité avant de passer au suivant

                await fetchStream(src.url, src.name);

            }



            document.getElementById('status-text').innerText = "Terminé";

            led.className = "led active";

            document.getElementById('scan-prog').style.width = "0%";

            

            // 3. Afficher seulement les 50 premiers pour fluidité

            renderGrid(allChannels.slice(0, 50));



        } catch(e) {

            document.getElementById('status-text').innerText = "Erreur Réseau";

            led.style.background = "red";

        }

    }



    async function fetchStream(url, sourceName) {

        try {

            const response = await fetch(PROXY + encodeURIComponent(url));

            if(!response.ok) return;



            const text = await response.text();

            const lines = text.split('\n');

            

            let currentInfo = null;

            

            for(let line of lines) {

                line = line.trim();

                if(!line) continue;



                if(line.startsWith('#EXTINF')) {

                    // Extraction des infos

                    let name = line.split(',')[1] || "Chaîne Sans Nom";

                    let logo = (line.match(/tvg-logo=["']?([^"']*)["']?/) || [])[1];

                    let cat = "Autres";

                    

                    // Tentative de trouver la catégorie

                    let grp = line.match(/group-title=["']?([^"']*)["']?/);

                    if(grp) cat = grp[1].replace(/;/g, " ").trim();

                    else cat = sourceName; // Si pas de groupe, on met le nom du fichier M3U



                    currentInfo = { name: name, logo: logo, cat: cat };

                } 

                else if(line.startsWith('http')) {

                    if(currentInfo) {

                        // On ajoute à la mémoire globale sans toucher au DOM (Anti-Crash)

                        allChannels.push({...currentInfo, url: line});

                        currentInfo = null;

                    }

                }

            }

            // Mise à jour du compteur

            document.getElementById('count').innerText = allChannels.length;



        } catch(e) { console.log("Skip " + url); }

    }



    // Fonction d'affichage optimisée

    function renderGrid(channels) {

        const grid = document.getElementById('grid');

        grid.innerHTML = "";

        

        const frag = document.createDocumentFragment();

        

        channels.forEach(ch => {

            const div = document.createElement('div');

            div.className = "card";

            div.innerHTML = `

                <img src="${ch.logo || 'https://via.placeholder.com/40?text=TV'}" class="card-img" loading="lazy" onerror="this.src='https://via.placeholder.com/40?text=TV'">

                <div class="card-title">${ch.name}</div>

                <div class="card-cat">${ch.cat}</div>

            `;

            div.onclick = () => openPlayer(ch);

            frag.appendChild(div);

        });

        

        grid.appendChild(frag);

    }



    // Fonction de recherche ultra-rapide (filtre la mémoire)

    function filterGrid() {

        const term = document.getElementById('searchInput').value.toLowerCase();

        

        // Si vide, on remet les 50 premiers

        if(term.length < 2) {

            renderGrid(allChannels.slice(0, 50));

            return;

        }



        // Sinon on filtre tout le tableau (rapide en JS pur)

        const results = allChannels.filter(ch => ch.name.toLowerCase().includes(term));

        

        // On affiche max 100 résultats pour ne pas crash

        renderGrid(results.slice(0, 100));

    }



    // --- LECTEUR VIDEO ---

    function openPlayer(ch) {

        document.getElementById('player-overlay').style.display = "flex";

        document.getElementById('playing-title').innerText = ch.name;

        

        if(Hls.isSupported()) {

            if(hls) hls.destroy();

            hls = new Hls();

            hls.loadSource(ch.url);

            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());

            

            // Tentative de réparation avec Proxy si échec

            hls.on(Hls.Events.ERROR, (e,d) => {

                if(d.fatal) {

                    console.log("Erreur flux, tentative proxy...");

                    hls.destroy(); 

                    hls = new Hls();

                    hls.loadSource(PROXY + encodeURIComponent(ch.url));

                    hls.attachMedia(video);

                    hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());

                }

            });

        } else if(video.canPlayType('application/vnd.apple.mpegurl')) {

            video.src = ch.url;

            video.play();

        }

    }



    function closePlayer() {

        document.getElementById('player-overlay').style.display = "none";

        video.pause(); 

        video.src = "";

        if(hls) hls.destroy();

    }

</script>

</body>

</html>
