<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>TITAN CLEANER V118 - PLAYER & SEARCH</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #0a0a0a; color: #fff; font-family: 'Segoe UI', sans-serif; padding: 20px; display: flex; gap: 20px; height: 100vh; margin: 0; box-sizing: border-box; }
        
        .panel { 
            background: #141414; 
            border: 1px solid #333; 
            padding: 20px; 
            border-radius: 8px; 
            flex: 1; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        .panel-full { flex: 2; }
        
        h2 { 
            margin-top: 0; 
            color: #e50914; 
            border-bottom: 2px solid #333; 
            padding-bottom: 15px; 
            font-size: 18px; 
            display:flex; 
            justify-content:space-between;
            align-items: center;
        }
        
        .btn { 
            width: 100%; 
            padding: 12px; 
            border: none; 
            cursor: pointer; 
            color: white; 
            font-weight: bold; 
            border-radius: 5px; 
            margin-bottom: 10px; 
            font-size: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            transition: 0.2s; 
            text-transform: uppercase;
        }
        .btn:hover { filter: brightness(1.2); }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .btn-orange { background: #d35400; } 
        .btn-blue { background: #2980b9; } 
        .btn-green { background: #27ae60; } 
        .btn-grey { background: #444; }
        .btn-red { background: #c0392b; }
        
        /* BARRE DE RECHERCHE */
        .search-box {
            width: 100%;
            padding: 10px;
            background: #222;
            border: 1px solid #444;
            color: white;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: monospace;
        }

        .list-box { 
            flex: 1; 
            overflow-y: auto; 
            border: 1px solid #333; 
            background: #000; 
            font-family: monospace; 
            font-size: 11px; 
            padding: 5px; 
        }
        
        .item { padding: 8px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .item:hover { background: #222; }
        .item.ok { color: #2ecc71; border-left: 3px solid #2ecc71; background: rgba(46, 204, 113, 0.05); } 
        .item.dead { color: #555; text-decoration: line-through; }
        .item.retry { color: #f1c40f; background: rgba(241, 196, 15, 0.05); }

        .progress-container { background: #333; height: 10px; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: #e50914; width: 0%; transition: width 0.3s; }
        
        .log-area { height: 100px; overflow-y: auto; color: #888; font-size: 11px; border-top: 1px solid #333; padding-top: 10px; font-family: monospace; margin-top: auto; }
        
        /* PLAYER OVERLAY */
        #preview-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        #preview-video { width: 80%; height: 60vh; background: #000; border: 2px solid #333; }
        .player-controls {
            width: 80%; display: flex; justify-content: space-between; align-items: center;
            margin-top: 10px; background: #222; padding: 10px; border-radius: 5px;
        }
        .player-info { color: #e50914; font-weight: bold; font-size: 16px; }

        .badge { padding: 3px 6px; border-radius: 4px; font-size: 9px; color: #000; font-weight: bold; }
        .badge-live { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
    </style>
</head>
<body>

    <div id="preview-layer">
        <div class="player-info" id="player-title">Nom de la cha√Æne</div>
        <video id="preview-video" controls autoplay></video>
        <div class="player-controls">
            <button class="btn btn-grey" style="width:auto;" onclick="prevChannel()"><i class="fas fa-step-backward"></i> PR√âC√âDENT</button>
            <button class="btn btn-red" style="width:auto;" onclick="closePlayer()"><i class="fas fa-times"></i> FERMER</button>
            <button class="btn btn-grey" style="width:auto;" onclick="nextChannel()"><i class="fas fa-step-forward"></i> SUIVANT</button>
        </div>
    </div>

    <div class="panel">
        <h2>1. SOURCES <i class="fas fa-server"></i></h2>
        
        <button class="btn btn-orange" onclick="fetchSourcesFromGoogle()" id="btn-import">
            <i class="fas fa-cloud-download-alt"></i> IMPORTER (COL B)
        </button>

        <p style="text-align:center; color:#555; font-size:10px;">OU</p>

        <input type="file" id="localFileInput" accept=".m3u,.m3u8" style="display:none;" onchange="handleLocalFile(this)">
        <button class="btn btn-grey" onclick="document.getElementById('localFileInput').click()">
            <i class="fas fa-folder-open"></i> FICHIER LOCAL
        </button>
        <div id="fileName" style="text-align:center; font-size:11px; color:#e50914; margin-bottom:10px;"></div>

        <button class="btn btn-blue" onclick="processLocalFile()" id="btn-extract" disabled>
            <i class="fas fa-file-import"></i> EXTRAIRE
        </button>

        <div class="log-area" id="log">Pr√™t...</div>
    </div>

    <div class="panel panel-full">
        <h2>
            2. CERVEAU & VISUALISATION
            <span style="font-size:12px; color:#aaa;">Clic sur une cha√Æne pour tester</span>
        </h2>
        
        <input type="text" id="search-input" class="search-box" placeholder="üîç Filtrer les cha√Ænes..." oninput="filterList()">

        <div class="progress-container"><div class="progress-bar" id="p-bar"></div></div>
        
        <div style="display:flex; gap:10px;">
            <button class="btn btn-blue" onclick="startDirectScan()" id="btn-scan" disabled>
                <i class="fas fa-stethoscope"></i> SCAN AUTO (PING)
            </button>
            <button class="btn btn-green" onclick="sendToGoogle()" id="btn-save" disabled>
                <i class="fas fa-save"></i> SAUVEGARDER (D/E)
            </button>
        </div>
        
        <div class="list-box" id="result-list"></div>
        <div style="text-align:right; font-size:10px; color:#666; margin-top:5px;" id="total-lbl">0 cha√Ænes</div>
    </div>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbyTVVHd3DGbEtlRfVN5aboerVM1UEbDYTGv4vJxabValUYDAHRxgLoFppjUO8xwv9SsTw/exec";
    const PROXY = "https://corsproxy.io/?";

    let extractedChannels = []; 
    let displayList = []; // Liste filtr√©e affich√©e
    let validChannels = [];
    let uniqueUrls = new Set(); 
    let selectedLocalFile = null;
    
    // PLAYER VARS
    let hls = null;
    let currentPreviewIndex = -1; // Index dans displayList

    // ==========================================
    // 1. IMPORTATION
    // ==========================================

    async function fetchSourcesFromGoogle() {
        log("Connexion au serveur Google (Colonne B)...");
        try {
            const res = await fetch(`${API_URL}?action=admin_get_m3u_sources`);
            const data = await res.json();
            
            if(data.length === 0) return log("ERREUR: La colonne B est vide.");
            
            log(`${data.length} fichiers M3U trouv√©s. D√©marrage...`);
            extractedChannels = []; uniqueUrls.clear();

            for(let item of data) {
                let url = item.url || item; 
                try {
                    const txtRes = await fetch(PROXY + encodeURIComponent(url));
                    if(txtRes.ok) {
                        const text = await txtRes.text();
                        processM3UText(text);
                    }
                } catch(err) { log("Erreur lien."); }
            }
            finishExtraction();
        } catch(e) { log("Erreur Critique API: " + e); }
    }

    function handleLocalFile(input) {
        if(input.files && input.files[0]) {
            selectedLocalFile = input.files[0];
            document.getElementById('fileName').innerText = selectedLocalFile.name;
            document.getElementById('btn-extract').disabled = false;
        }
    }

    function processLocalFile() {
        if(!selectedLocalFile) return;
        extractedChannels = []; uniqueUrls.clear();
        const reader = new FileReader();
        reader.onload = function(e) {
            processM3UText(e.target.result);
            finishExtraction();
        };
        reader.readAsText(selectedLocalFile);
    }

    // --- MOTEUR D'EXTRACTION ---
    function processM3UText(text) {
        const lines = text.split('\n');
        let currentName = "Sans Nom";
        let count = 0;

        for(let i=0; i<lines.length; i++) {
            let line = lines[i].trim();
            if(line.startsWith("#EXTINF")) {
                let parts = line.split(',');
                currentName = parts[parts.length - 1].trim();
            } 
            else if(line.startsWith("http")) {
                // FILTRE STRICT : Uniquement les formats web-friendly
                const isCompatible = !line.includes('.ts') && !line.includes('.mkv') && !line.includes('.avi') && !line.includes('.m3u');
                
                if (isCompatible && !uniqueUrls.has(line)) {
                    extractedChannels.push({ name: currentName, url: line, status: 'waiting' });
                    uniqueUrls.add(line);
                    count++;
                }
            }
        }
        log(`+ ${count} cha√Ænes ajout√©es.`);
    }

    function finishExtraction() {
        log(`EXTRACTION TERMIN√âE.`);
        displayList = [...extractedChannels]; // Copie pour affichage
        document.getElementById('btn-scan').disabled = false;
        renderList();
    }

    // ==========================================
    // 2. GESTION DE LISTE & RECHERCHE
    // ==========================================
    
    function filterList() {
        const term = document.getElementById('search-input').value.toLowerCase();
        if(term.length < 2) {
            displayList = extractedChannels;
        } else {
            displayList = extractedChannels.filter(ch => ch.name.toLowerCase().includes(term));
        }
        renderList();
    }

    function renderList() {
        const container = document.getElementById('result-list');
        let html = "";
        let max = Math.min(displayList.length, 500); // Limite affichage pour perf
        
        for(let i=0; i<max; i++) {
            let c = displayList[i];
            let icon = '<i class="fas fa-play"></i>'; // Icone lecture par d√©faut
            
            if(c.status === 'ok') icon = '‚úÖ';
            if(c.status === 'dead') icon = '‚ùå';
            if(c.status === 'retry') icon = 'üîÑ';

            // On ajoute un onclick pour lancer le player avec l'index de la liste affich√©e
            html += `<div class="item ${c.status}" id="row-${i}" onclick="playFromList(${i})">
                <span>${c.name}</span>
                <span class="status-icon">${icon}</span>
            </div>`;
        }
        
        document.getElementById('total-lbl').innerText = `${displayList.length} cha√Ænes (Total: ${extractedChannels.length})`;
        container.innerHTML = html;
    }

    function updateRowUI(idx, status) {
        // Cette fonction met √† jour l'√©l√©ment visuel lors du scan
        // Note: Cela marche si l'ordre n'a pas chang√©. Si recherche active, l'index visuel diff√®re.
        // Pour simplifier lors du scan, on peut d√©sactiver la recherche.
    }

    // ==========================================
    // 3. LECTEUR VIDEO (PREVIEW)
    // ==========================================
    
    function playFromList(index) {
        currentPreviewIndex = index;
        const ch = displayList[index];
        openPlayer(ch);
    }

    function openPlayer(ch) {
        if(!ch) return;
        
        const layer = document.getElementById('preview-layer');
        const video = document.getElementById('preview-video');
        const title = document.getElementById('player-title');
        
        layer.style.display = 'flex';
        title.innerText = `${currentPreviewIndex + 1}. ${ch.name}`;

        if(Hls.isSupported()) {
            if(hls) hls.destroy();
            hls = new Hls();
            hls.loadSource(ch.url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            hls.on(Hls.Events.ERROR, () => {
                title.innerText += " (Erreur lecture)";
            });
        } else if(video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = ch.url;
            video.play();
        }
    }

    function closePlayer() {
        const video = document.getElementById('preview-video');
        video.pause();
        video.src = "";
        if(hls) hls.destroy();
        document.getElementById('preview-layer').style.display = 'none';
    }

    function nextChannel() {
        if(currentPreviewIndex < displayList.length - 1) {
            currentPreviewIndex++;
            openPlayer(displayList[currentPreviewIndex]);
        }
    }

    function prevChannel() {
        if(currentPreviewIndex > 0) {
            currentPreviewIndex--;
            openPlayer(displayList[currentPreviewIndex]);
        }
    }

    // ==========================================
    // 4. ANALYSE AUTOMATIQUE
    // ==========================================

    async function startDirectScan() {
        const btnScan = document.getElementById('btn-scan');
        btnScan.disabled = true;
        btnScan.innerText = 'SCAN EN COURS...';
        
        // On scanne TOUTE la liste extraite, pas juste celle affich√©e
        validChannels = [];
        let ok = 0;
        
        for(let i=0; i<extractedChannels.length; i+=20) {
            let chunk = extractedChannels.slice(i, i+20);
            
            await Promise.all(chunk.map(async (item) => {
                const isLive = await checkDirectLink(item.url);
                if(isLive) {
                    item.status = 'ok';
                    ok++;
                    validChannels.push([item.name, item.url]);
                } else {
                    item.status = 'dead';
                }
            }));
            
            // Mise √† jour barre progression
            let pct = Math.round(((i+20)/extractedChannels.length)*100);
            document.getElementById('p-bar').style.width = pct + "%";
            document.getElementById('s-ok').innerText = ok;
            
            // Rafraichir la liste visuelle de temps en temps
            if(i % 100 === 0) renderList();
        }
        
        renderList(); // Final refresh
        log(`SCAN TERMIN√â. ${ok} valides.`);
        btnScan.innerText = 'SCAN TERMIN√â';
        
        if(ok > 0) {
            document.getElementById('btn-save').disabled = false;
            document.getElementById('btn-save').innerText = `ENVOYER ${ok} CHAINES`;
        }
    }

    async function checkDirectLink(url) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), 4000); 
        try {
            const res = await fetch(PROXY + encodeURIComponent(url), { method: 'HEAD', signal: controller.signal });
            clearTimeout(id);
            return res.ok;
        } catch(e) { return false; }
    }

    // ==========================================
    // 5. SAUVEGARDE
    // ==========================================

    async function sendToGoogle() {
        const btn = document.getElementById('btn-save');
        btn.disabled = true;
        btn.innerText = "ENVOI...";
        
        for(let i=0; i<validChannels.length; i+=500) {
            let chunk = validChannels.slice(i, i+500);
            try {
                await fetch(`${API_URL}?action=admin_save_extracted`, {
                    method: 'POST',
                    body: JSON.stringify(chunk)
                });
                log(`Paquet ${i} envoy√©.`);
            } catch(e) {
                alert("Erreur d'envoi.");
                btn.disabled = false;
                return;
            }
        }
        alert("Succ√®s !");
        btn.innerText = "TERMINE";
    }

    function log(msg) {
        const div = document.getElementById('log');
        div.innerHTML += `<div>> ${msg}</div>`;
        div.scrollTop = div.scrollHeight;
    }
</script>
</body>
</html>
