<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>TITAN CLEANER - CERVEAU V117</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #0a0a0a; color: #fff; font-family: 'Segoe UI', sans-serif; padding: 20px; display: flex; gap: 20px; height: 100vh; margin: 0; box-sizing: border-box; }
        
        .panel { 
            background: #141414; 
            border: 1px solid #333; 
            padding: 20px; 
            border-radius: 8px; 
            flex: 1; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        .panel-full { flex: 2; }
        
        h2 { 
            margin-top: 0; 
            color: #e50914; 
            border-bottom: 2px solid #333; 
            padding-bottom: 15px; 
            font-size: 18px; 
            display:flex; 
            justify-content:space-between;
            align-items: center;
        }
        
        .btn { 
            width: 100%; 
            padding: 15px; 
            border: none; 
            cursor: pointer; 
            color: white; 
            font-weight: bold; 
            border-radius: 5px; 
            margin-bottom: 10px; 
            font-size: 13px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            transition: 0.2s; 
            text-transform: uppercase;
        }
        .btn:hover { filter: brightness(1.2); }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .btn-orange { background: linear-gradient(45deg, #d35400, #e67e22); } 
        .btn-blue { background: linear-gradient(45deg, #2980b9, #3498db); } 
        .btn-green { background: linear-gradient(45deg, #27ae60, #2ecc71); } 
        .btn-grey { background: #444; }
        
        .list-box { 
            flex: 1; 
            overflow-y: auto; 
            border: 1px solid #333; 
            background: #000; 
            font-family: monospace; 
            font-size: 11px; 
            padding: 5px; 
        }
        
        .item { padding: 8px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .item:hover { background: #111; }
        .item.ok { color: #2ecc71; border-left: 3px solid #2ecc71; background: rgba(46, 204, 113, 0.05); } 
        .item.dead { color: #555; text-decoration: line-through; }
        .item.retry { color: #f1c40f; background: rgba(241, 196, 15, 0.05); }

        .progress-container { background: #333; height: 10px; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: #e50914; width: 0%; transition: width 0.3s; }
        
        .log-area { height: 120px; overflow-y: auto; color: #888; font-size: 11px; border-top: 1px solid #333; padding-top: 10px; font-family: monospace; margin-top: auto; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #222; padding: 10px; border-radius: 5px; text-align: center; }
        .stat-val { font-size: 18px; font-weight: bold; display: block; }
        .stat-lbl { font-size: 10px; color: #aaa; text-transform: uppercase; }

        .badge { padding: 3px 6px; border-radius: 4px; font-size: 9px; color: #000; font-weight: bold; }
        .badge-live { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
    </style>
</head>
<body>

    <div class="panel">
        <h2>1. SOURCES <i class="fas fa-server"></i></h2>
        
        <div style="padding:10px; background:#222; border-radius:5px; margin-bottom:15px; font-size:12px; color:#ccc;">
            <i class="fas fa-info-circle"></i> Le script va lire tous les liens M3U pr√©sents dans la <b>Colonne B</b> de ton fichier Excel, extraire les cha√Ænes, et retirer les doublons.
        </div>

        <button class="btn btn-orange" onclick="fetchSourcesFromGoogle()" id="btn-import">
            <i class="fas fa-cloud-download-alt"></i> IMPORTER DEPUIS EXCEL
        </button>

        <p style="text-align:center; color:#555; font-size:10px;">OU</p>

        <input type="file" id="localFileInput" accept=".m3u,.m3u8" style="display:none;" onchange="handleLocalFile(this)">
        <button class="btn btn-grey" onclick="document.getElementById('localFileInput').click()">
            <i class="fas fa-folder-open"></i> FICHIER LOCAL
        </button>
        <div id="fileName" style="text-align:center; font-size:11px; color:#e50914; margin-bottom:10px;"></div>

        <button class="btn btn-blue" onclick="processLocalFile()" id="btn-extract" disabled>
            <i class="fas fa-file-import"></i> 1. EXTRAIRE LES DONN√âES
        </button>

        <div class="log-area" id="log">Pr√™t. En attente d'action...</div>
    </div>

    <div class="panel panel-full">
        <h2>2. LE CERVEAU (TEST & EXPORT) <i class="fas fa-microchip"></i></h2>
        
        <div class="stats-grid">
            <div class="stat-box">
                <span class="stat-val" id="s-total" style="color:#fff">0</span>
                <span class="stat-lbl">Candidats</span>
            </div>
            <div class="stat-box">
                <span class="stat-val" id="s-ok" style="color:#2ecc71">0</span>
                <span class="stat-lbl">Valid√©s (En ligne)</span>
            </div>
            <div class="stat-box">
                <span class="stat-val" id="s-dead" style="color:#e74c3c">0</span>
                <span class="stat-lbl">Morts / Rejet√©s</span>
            </div>
        </div>

        <div class="progress-container"><div class="progress-bar" id="p-bar"></div></div>
        
        <div style="display:flex; gap:10px;">
            <button class="btn btn-blue" onclick="startDirectScan()" id="btn-scan" disabled>
                <i class="fas fa-stethoscope"></i> 2. LANCER LE TEST (PING)
            </button>
            <button class="btn btn-green" onclick="sendToGoogle()" id="btn-save" disabled>
                <i class="fas fa-save"></i> 3. ENVOYER VERS EXCEL (D/E)
            </button>
        </div>
        
        <div class="list-box" id="result-list"></div>
    </div>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbyTVVHd3DGbEtlRfVN5aboerVM1UEbDYTGv4vJxabValUYDAHRxgLoFppjUO8xwv9SsTw/exec";
    const PROXY = "https://corsproxy.io/?";

    let extractedChannels = []; 
    let validChannels = [];
    let uniqueUrls = new Set(); // Anti-doublon
    let selectedLocalFile = null;

    // ==========================================
    // 1. IMPORTATION & EXTRACTION (Colonne B)
    // ==========================================

    async function fetchSourcesFromGoogle() {
        log("Connexion au serveur Google (Colonne B)...");
        try {
            const res = await fetch(`${API_URL}?action=admin_get_m3u_sources`);
            const data = await res.json();
            
            if(data.length === 0) return log("ERREUR: La colonne B est vide.");
            
            log(`${data.length} fichiers M3U trouv√©s. D√©marrage de l'extraction...`);
            extractedChannels = []; uniqueUrls.clear();

            // On boucle sur chaque lien M3U
            for(let item of data) {
                let url = item.url || item; // G√®re si c'est un objet ou une string
                log(`Traitement: ${url.substring(0, 40)}...`);
                try {
                    const txtRes = await fetch(PROXY + encodeURIComponent(url));
                    if(txtRes.ok) {
                        const text = await txtRes.text();
                        processM3UText(text);
                    } else {
                        log("Erreur t√©l√©chargement playlist.");
                    }
                } catch(err) { log("Erreur lien: " + err.message); }
            }
            finishExtraction();
        } catch(e) { log("Erreur Critique API: " + e); }
    }

    function handleLocalFile(input) {
        if(input.files && input.files[0]) {
            selectedLocalFile = input.files[0];
            document.getElementById('fileName').innerText = selectedLocalFile.name;
            document.getElementById('btn-extract').disabled = false;
        }
    }

    function processLocalFile() {
        if(!selectedLocalFile) return;
        extractedChannels = []; uniqueUrls.clear();
        log(`Extraction fichier local...`);
        const reader = new FileReader();
        reader.onload = function(e) {
            processM3UText(e.target.result);
            finishExtraction();
        };
        reader.readAsText(selectedLocalFile);
    }

    // --- MOTEUR D'EXTRACTION INTELLIGENT ---
    function processM3UText(text) {
        const lines = text.split('\n');
        let currentName = "Sans Nom";
        let count = 0;

        for(let i=0; i<lines.length; i++) {
            let line = lines[i].trim();
            if(line.startsWith("#EXTINF")) {
                let parts = line.split(',');
                currentName = parts[parts.length - 1].trim();
            } 
            else if(line.startsWith("http")) {
                // FILTRE 1 : Anti-Doublon + Anti-Playlist imbriqu√©e
                if (!uniqueUrls.has(line) && !line.includes(".m3u")) {
                    
                    // FILTRE 2 : Format Compatible (Optionnel mais recommand√©)
                    // On peut laisser passer tout pour laisser le "Cerveau" tester,
                    // mais retirer les .ts/.mkv optimise la vitesse.
                    const isCompatible = !line.includes('.ts') && !line.includes('.mkv') && !line.includes('.avi');
                    
                    if(isCompatible) {
                        extractedChannels.push({ name: currentName, url: line, status: 'waiting' });
                        uniqueUrls.add(line);
                        count++;
                    }
                }
            }
        }
        log(`+ ${count} cha√Ænes uniques ajout√©es.`);
    }

    function finishExtraction() {
        log(`EXTRACTION TERMIN√âE.`);
        document.getElementById('s-total').innerText = extractedChannels.length;
        document.getElementById('btn-scan').disabled = false;
        renderList();
    }

    // ==========================================
    // 2. LE CERVEAU (SCAN DE VIE)
    // ==========================================

    async function startDirectScan() {
        const btnScan = document.getElementById('btn-scan');
        btnScan.disabled = true;
        btnScan.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SCAN EN COURS...';
        
        validChannels = [];
        let ok = 0, dead = 0;
        
        // Scan par paquets de 20 (Pour la vitesse)
        for(let i=0; i<extractedChannels.length; i+=20) {
            let chunk = extractedChannels.slice(i, i+20);
            
            await Promise.all(chunk.map(async (item, idx) => {
                const globalIdx = i + idx;
                updateRowUI(globalIdx, 'retry'); // Jaune = En cours

                // LE TEST DE VIE
                const isLive = await checkDirectLink(item.url);
                
                if(isLive) {
                    item.status = 'ok';
                    ok++;
                    // On pr√©pare le paquet pour Excel : [Nom, Url]
                    validChannels.push([item.name, item.url]);
                } else {
                    item.status = 'dead';
                    dead++;
                }
                updateRowUI(globalIdx, item.status);
            }));
            
            // Stats
            let pct = Math.round(((i+20)/extractedChannels.length)*100);
            document.getElementById('p-bar').style.width = pct + "%";
            document.getElementById('s-ok').innerText = ok;
            document.getElementById('s-dead').innerText = dead;
        }
        
        log(`SCAN TERMIN√â. ${ok} cha√Ænes valides.`);
        btnScan.innerHTML = '<i class="fas fa-check"></i> SCAN TERMIN√â';
        btnScan.className = "btn btn-grey"; // D√©sactiv√© visuellement
        
        if(ok > 0) {
            document.getElementById('btn-save').disabled = false;
            document.getElementById('btn-save').innerText = `ENVOYER ${ok} CHA√éNES VERS EXCEL`;
            alert("Scan termin√© ! Vous pouvez maintenant envoyer les r√©sultats vers Excel.");
        } else {
            alert("Aucune cha√Æne valide trouv√©e.");
        }
    }

    // FONCTION DE TEST (PING)
    async function checkDirectLink(url) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), 5000); // 5 sec timeout
        try {
            // On utilise HEAD pour ne pas t√©l√©charger la vid√©o, juste v√©rifier si elle existe
            const res = await fetch(PROXY + encodeURIComponent(url), { 
                method: 'HEAD', 
                signal: controller.signal 
            });
            clearTimeout(id);
            return res.ok; // Renvoie TRUE si 200 OK
        } catch(e) {
            return false;
        }
    }

    // ==========================================
    // 3. ENVOI VERS EXCEL (Colonnes D/E)
    // ==========================================

    async function sendToGoogle() {
        const btn = document.getElementById('btn-save');
        btn.disabled = true;
        btn.innerText = "ENVOI EN COURS...";
        
        log("D√©but de l'envoi vers Excel (Colonnes D et E)...");
        
        // Envoi par gros paquets (1000 cha√Ænes max par requ√™te pour √©viter timeout Google)
        const CHUNK_SIZE = 1000;
        
        for(let i=0; i<validChannels.length; i+=CHUNK_SIZE) {
            let chunk = validChannels.slice(i, i+CHUNK_SIZE);
            try {
                // Appel API sp√©cifique pour sauvegarder
                const res = await fetch(`${API_URL}?action=admin_save_extracted`, {
                    method: 'POST',
                    body: JSON.stringify(chunk)
                });
                const txt = await res.text();
                log(`Paquet ${i/CHUNK_SIZE + 1} : ${txt}`);
            } catch(e) {
                alert("Erreur lors de l'envoi. V√©rifiez votre connexion.");
                btn.disabled = false;
                btn.innerText = "R√âESSAYER ENVOI";
                return;
            }
        }
        
        log("‚úÖ BASE DE DONN√âES MISE √Ä JOUR !");
        alert("Succ√®s ! Toutes les cha√Ænes valides sont maintenant dans votre Excel.");
        btn.innerText = "TERMINE";
        btn.className = "btn btn-grey";
    }

    // --- FONCTIONS D'AFFICHAGE ---
    function renderList() {
        const container = document.getElementById('result-list');
        let html = "";
        // Limite visuelle pour ne pas faire laguer le navigateur pendant le scan
        let max = Math.min(extractedChannels.length, 300);
        
        for(let i=0; i<max; i++) {
            let c = extractedChannels[i];
            html += `<div class="item ${c.status}" id="row-${i}">
                <span>${c.name}</span>
                <span class="status-icon">‚è≥</span>
            </div>`;
        }
        if(extractedChannels.length > 300) html += `<div style="text-align:center; padding:10px; color:#444;">... et ${extractedChannels.length - 300} autres cha√Ænes ...</div>`;
        container.innerHTML = html;
    }

    function updateRowUI(idx, status) {
        let el = document.getElementById(`row-${idx}`);
        if(el) {
            el.className = `item ${status}`;
            let icon = '‚è≥';
            if(status === 'ok') icon = '‚úÖ <span class="badge badge-live">LIVE</span>';
            if(status === 'dead') icon = '‚ùå';
            if(status === 'retry') icon = 'üîÑ';
            el.querySelector('.status-icon').innerHTML = icon;
        }
    }

    function log(msg) {
        const div = document.getElementById('log');
        div.innerHTML += `<div>> ${msg}</div>`;
        div.scrollTop = div.scrollHeight;
    }
</script>
</body>
</html>
