<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>TITAN HYBRID EXTRACTOR V110</title>
    <style>
        body { background: #050505; color: #fff; font-family: 'Segoe UI', sans-serif; padding: 20px; display: flex; gap: 20px; height: 100vh; margin: 0; box-sizing: border-box; }
        .panel { background: #111; border: 1px solid #333; padding: 20px; border-radius: 8px; flex: 1; display: flex; flex-direction: column; }
        .panel-full { flex: 2; }
        h2 { margin-top: 0; color: #e50914; border-bottom: 1px solid #333; padding-bottom: 10px; font-size: 16px; margin-top: 0; }
        
        .btn { width: 100%; padding: 12px; border: none; cursor: pointer; color: white; font-weight: bold; border-radius: 4px; margin-bottom: 10px; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-orange { background: #d35400; } .btn-blue { background: #007bff; } .btn-green { background: #27ae60; } .btn-grey { background: #444; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
        
        .list-box { flex: 1; overflow-y: auto; border: 1px solid #333; background: #000; font-family: monospace; font-size: 11px; padding: 5px; }
        .item { padding: 5px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .item.ok { color: #2ecc71; border-left: 3px solid #2ecc71; background: rgba(46, 204, 113, 0.1); } 
        .item.dead { color: #555; text-decoration: line-through; }
        .item.retry { color: #f1c40f; }

        .progress-bar { height: 5px; background: #e50914; width: 0%; margin: 10px 0; transition: width 0.2s; }
        .log-area { height: 150px; overflow-y: auto; color: #888; font-size: 10px; border-top: 1px solid #333; padding-top: 10px; font-family: monospace; }
        .stats { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 10px; font-weight: bold; }
        
        .badge { padding: 2px 5px; border-radius: 3px; font-size: 9px; color: #000; font-weight: bold; margin-left: 5px; }
        .badge-fast { background: #3498db; } .badge-deep { background: #9b59b6; } .badge-rescue { background: #e67e22; }

        .input-file-zone { border: 1px dashed #444; padding: 10px; margin-bottom: 10px; text-align: center; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="panel">
        <h2>1. CHOIX DE LA SOURCE</h2>
        
        <p style="color:#e50914; font-weight:bold; margin-bottom:5px;">OPTION A : SERVEUR</p>
        <p style="font-size:10px; color:#aaa; margin-top:0;">Lire les liens M3U de la colonne B.</p>
        <button class="btn btn-orange" onclick="fetchSourcesFromGoogle()">
            <i class="fas fa-cloud-download-alt"></i> IMPORTER DEPUIS COLONNE B
        </button>

        <hr style="border:0; border-top:1px solid #333; width:100%; margin: 15px 0;">

        <p style="color:#3498db; font-weight:bold; margin-bottom:5px;">OPTION B : FICHIER LOCAL</p>
        <div class="input-file-zone">
            <input type="file" id="localFileInput" accept=".m3u,.m3u8" style="display:none;" onchange="handleLocalFile(this)">
            <label for="localFileInput" style="cursor:pointer; color:#aaa; font-size:12px;">
                <i class="fas fa-folder-open"></i> Cliquez pour choisir un fichier .m3u
            </label>
            <div id="fileName" style="font-size:10px; color:#fff; margin-top:5px;"></div>
        </div>
        <button class="btn btn-grey" onclick="processLocalFile()" id="btn-local-start" disabled>
            <i class="fas fa-file-import"></i> EXTRAIRE LE FICHIER
        </button>

        <div class="log-area" id="log">En attente de source...</div>
    </div>

    <div class="panel panel-full">
        <h2>2. ANALYSE & SAUVEGARDE (ANTI-DOUBLON)</h2>
        
        <div class="stats">
            <span style="color:#fff">Extraites: <span id="s-total">0</span></span>
            <span style="color:#2ecc71">Valid√©es: <span id="s-ok">0</span></span>
            <span style="color:#e74c3c">Mortes: <span id="s-dead">0</span></span>
        </div>

        <div style="background:#333"><div class="progress-bar" id="p-bar"></div></div>
        
        <div style="display:flex; gap:10px;">
            <button class="btn btn-blue" onclick="startDeepScan()" id="btn-test" disabled>2. SCANNER (INTELLIGENT)</button>
            <button class="btn btn-green" onclick="sendToGoogle()" id="btn-save" disabled>3. SAUVEGARDER (D/E)</button>
        </div>
        
        <div class="list-box" id="result-list"></div>
    </div>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbwdcIs7VDEbulPSPnV6RwvHJjYUN7FNizLd3GWdqtvAZOeQaVsX6-PyCDtHGMbX7eJVRg/exec";
    
    // MOTEURS
    const PROXY_MAIN = "https://corsproxy.io/?";
    const PROXY_BACKUP = "https://api.allorigins.win/raw?url=";

    let extractedChannels = []; 
    let validChannels = [];
    let selectedLocalFile = null;

    // ==========================================
    // 1. GESTION DES SOURCES
    // ==========================================

    // OPTION A : SERVEUR GOOGLE
    async function fetchSourcesFromGoogle() {
        log("Connexion au serveur (Colonne B)...");
        extractedChannels = []; // Reset
        try {
            const res = await fetch(`${API_URL}?action=admin_get_m3u_sources`);
            const m3uLinks = await res.json();
            
            if(m3uLinks.length === 0) return log("Aucun lien M3U trouv√© en Colonne B.");
            
            log(`${m3uLinks.length} playlists trouv√©es. Extraction...`);
            
            for(let url of m3uLinks) {
                log(`T√©l√©chargement: ${url.substring(0, 30)}...`);
                try {
                    const txtRes = await fetch(PROXY_MAIN + encodeURIComponent(url));
                    const text = await txtRes.text();
                    processM3UText(text);
                } catch(err) { log("Erreur lien: " + err.message); }
            }
            finishExtraction();
        } catch(e) { log("Erreur API: " + e); }
    }

    // OPTION B : FICHIER LOCAL
    function handleLocalFile(input) {
        if(input.files && input.files[0]) {
            selectedLocalFile = input.files[0];
            document.getElementById('fileName').innerText = selectedLocalFile.name;
            document.getElementById('btn-local-start').disabled = false;
            document.getElementById('btn-local-start').className = "btn btn-blue";
        }
    }

    function processLocalFile() {
        if(!selectedLocalFile) return;
        extractedChannels = []; // Reset
        log(`Lecture du fichier local : ${selectedLocalFile.name}...`);
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            processM3UText(content);
            finishExtraction();
        };
        reader.readAsText(selectedLocalFile);
    }

    // --- MOTEUR D'EXTRACTION COMMUN ---
    function processM3UText(text) {
        const lines = text.split('\n');
        let currentName = "Sans Nom";
        let count = 0;

        for(let i=0; i<lines.length; i++) {
            let line = lines[i].trim();
            if(line.startsWith("#EXTINF")) {
                let parts = line.split(',');
                currentName = parts[parts.length - 1].trim().replace(/[\r\n]+/gm, ""); 
            } 
            else if(line.startsWith("http")) {
                // Ignore les playlists imbriqu√©es pour √©viter les boucles
                if (!line.endsWith(".m3u") && !line.includes("type=m3u")) {
                    extractedChannels.push({ name: currentName, url: line, status: 'waiting', method: '' });
                    count++;
                }
            }
        }
        log(`+ ${count} cha√Ænes extraites.`);
    }

    function finishExtraction() {
        log(`TOTAL : ${extractedChannels.length} cha√Ænes pr√™tes.`);
        renderList();
        document.getElementById('btn-test').disabled = false;
    }

    // ==========================================
    // 2. ANALYSE (DEEP SCAN)
    // ==========================================

    async function startDeepScan() {
        document.getElementById('btn-test').disabled = true;
        document.getElementById('btn-local-start').disabled = true;
        validChannels = [];
        let ok = 0, dead = 0;
        log("D√©marrage de l'analyse intelligente...");
        
        // Paquets de 10
        for(let i=0; i<extractedChannels.length; i+=10) {
            let chunk = extractedChannels.slice(i, i+10);
            
            await Promise.all(chunk.map(async (item, idx) => {
                const globalIdx = i + idx;
                updateRow(globalIdx, 'retry', '...'); // Visuel "En cours"

                let result = await deepAnalyzeUrl(item.url);
                
                if(result.working) {
                    item.status = 'ok';
                    item.method = result.method;
                    ok++;
                    // Format [Nom, Url] pour l'envoi
                    validChannels.push([item.name, item.url]);
                } else {
                    item.status = 'dead';
                    dead++;
                }
                updateRow(globalIdx, item.status, item.method); // Visuel Final
            }));
            
            // Progress Bar
            let pct = Math.round(((i+10)/extractedChannels.length)*100);
            document.getElementById('p-bar').style.width = pct + "%";
            document.getElementById('s-ok').innerText = ok;
            document.getElementById('s-dead').innerText = dead;
            
            await new Promise(r => setTimeout(r, 50)); // Pause CPU
        }
        
        log(`Analyse termin√©e. ${ok} cha√Ænes valides.`);
        if(ok > 0) {
            document.getElementById('btn-save').disabled = false;
            document.getElementById('btn-save').innerText = `ENREGISTRER ${ok} CHA√éNES (ANTI-DOUBLON)`;
        }
    }

    // ALGORITHME TRIPLE CHECK
    async function deepAnalyzeUrl(url) {
        // 1. FAST HEAD
        try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 3000);
            const res = await fetch(PROXY_MAIN + encodeURIComponent(url), { method: 'HEAD', signal: controller.signal });
            clearTimeout(id);
            if(res.ok) return { working: true, method: 'badge-fast' };
        } catch(e) {}

        // 2. DEEP GET (Range request)
        try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 5000);
            const res = await fetch(PROXY_MAIN + encodeURIComponent(url), { 
                method: 'GET', 
                headers: { 'Range': 'bytes=0-100' }, 
                signal: controller.signal 
            });
            clearTimeout(id);
            if(res.ok || res.status === 206) return { working: true, method: 'badge-deep' };
        } catch(e) {}

        // 3. RESCUE (Backup Proxy)
        try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 8000);
            const res = await fetch(PROXY_BACKUP + encodeURIComponent(url), { method: 'GET', signal: controller.signal });
            clearTimeout(id);
            if(res.ok) return { working: true, method: 'badge-rescue' };
        } catch(e) {}

        return { working: false };
    }

    // ==========================================
    // 3. SAUVEGARDE & UI
    // ==========================================

    async function sendToGoogle() {
        const btn = document.getElementById('btn-save');
        btn.disabled = true;
        btn.innerText = "ENVOI EN COURS...";
        log("Envoi au serveur (Mode Incr√©mentiel)...");
        
        // Envoi par paquets de 500
        for(let i=0; i<validChannels.length; i+=500) {
            let chunk = validChannels.slice(i, i+500);
            try {
                const rawRes = await fetch(`${API_URL}?action=admin_save_extracted`, {
                    method: 'POST',
                    body: JSON.stringify(chunk)
                });
                const txt = await rawRes.text();
                log(`Paquet ${i}: ${txt}`);
            } catch(e) {
                alert("Erreur r√©seau");
                return;
            }
        }
        log("‚úÖ TERMINE ! Base de donn√©es mise √† jour.");
        alert("Op√©ration termin√©e avec succ√®s.");
        btn.innerText = "TERMINE";
    }

    function renderList() {
        document.getElementById('s-total').innerText = extractedChannels.length;
        const container = document.getElementById('result-list');
        let html = "";
        let max = Math.min(extractedChannels.length, 500);
        
        for(let i=0; i<max; i++) {
            let c = extractedChannels[i];
            let icon = '‚è≥';
            if(c.status === 'ok') icon = '‚úÖ';
            if(c.status === 'dead') icon = '‚ùå';
            html += `<div class="item ${c.status}" id="row-${i}"><span>${c.name}</span><span>${icon}</span></div>`;
        }
        if(extractedChannels.length > 500) html += `<div style="text-align:center; padding:10px;">... et ${extractedChannels.length - 500} autres ...</div>`;
        container.innerHTML = html;
    }

    function updateRow(idx, status, method) {
        let el = document.getElementById(`row-${idx}`);
        if(el) {
            el.className = `item ${status}`;
            let icon = '‚è≥';
            if(status === 'ok') icon = `‚úÖ <span class="badge ${method}">${method.replace('badge-', '')}</span>`;
            if(status === 'dead') icon = '‚ùå';
            if(status === 'retry') icon = 'üîÑ';
            el.querySelector('span:last-child').innerHTML = icon;
        }
    }

    function log(msg) {
        const div = document.getElementById('log');
        div.innerHTML += `<div>> ${msg}</div>`;
        div.scrollTop = div.scrollHeight;
    }
</script>
</body>
</html>
