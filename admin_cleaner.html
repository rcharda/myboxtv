<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN EXTRACTOR V1</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #050505; color: #fff; font-family: sans-serif; padding: 20px; display: flex; gap: 20px; height: 100vh; margin: 0; box-sizing: border-box; }
        
        .panel { background: #111; border: 1px solid #333; padding: 20px; border-radius: 8px; flex: 1; display: flex; flex-direction: column; }
        .panel-full { flex: 2; }
        
        h2 { margin-top: 0; color: #e50914; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        input, select { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; margin-bottom: 10px; border-radius: 4px; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 12px; border: none; cursor: pointer; color: white; font-weight: bold; border-radius: 4px; margin-bottom: 5px; }
        .btn-blue { background: #007bff; } .btn-green { background: #27ae60; } .btn-red { background: #c0392b; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .list-box { flex: 1; overflow-y: auto; border: 1px solid #333; background: #000; font-family: monospace; font-size: 11px; padding: 5px; }
        .item { padding: 5px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; }
        .item.ok { color: #2ecc71; }
        .item.dead { color: #e74c3c; text-decoration: line-through; }
        .item.waiting { color: #888; }

        .progress-container { height: 20px; background: #333; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: #e50914; width: 0%; transition: width 0.1s; }
        
        .stats { display: flex; gap: 10px; font-size: 12px; margin-bottom: 10px; }
        .stat { background: #222; padding: 5px 10px; border-radius: 4px; flex: 1; text-align: center; }
    </style>
</head>
<body>

    <div class="panel">
        <h2>1. SOURCE</h2>
        <p style="font-size:12px; color:#aaa;">Collez un lien M3U global ou choisissez un fichier.</p>
        
        <input type="text" id="urlInput" placeholder="https://exemple.com/playlist.m3u">
        <button class="btn btn-blue" onclick="loadFromUrl()">CHARGER URL</button>
        
        <div style="text-align:center; margin: 10px 0;">OU</div>
        
        <input type="file" id="fileInput" onchange="loadFromFile()">
        
        <div id="log" style="margin-top:20px; font-size:11px; color:#aaa; height:150px; overflow:auto; border:1px solid #333; padding:5px;">
            > En attente...
        </div>
    </div>

    <div class="panel panel-full">
        <h2>2. ANALYSE & FILTRAGE</h2>
        
        <div class="stats">
            <div class="stat">Total: <span id="s-total">0</span></div>
            <div class="stat" style="color:#2ecc71">Valides: <span id="s-ok">0</span></div>
            <div class="stat" style="color:#e74c3c">Morts: <span id="s-dead">0</span></div>
        </div>

        <div class="progress-container">
            <div class="progress-bar" id="p-bar"></div>
        </div>

        <button class="btn btn-blue" onclick="startScan()" id="btn-scan" disabled>LANCER L'ANALYSE (TESTER LES LIENS)</button>
        <button class="btn btn-green" onclick="sendToServer()" id="btn-save" disabled>ENREGISTRER LES VALIDES SUR LE SERVEUR</button>

        <div class="list-box" id="result-list">
            </div>
    </div>

<script>
    // --- CONFIG ---
    // METS TON LIEN DE SCRIPT GOOGLE ICI üëá
    const API_URL = "https://script.google.com/macros/s/AKfycbzDIUoEc36v52egABKNnar_kXsHZ2Pb65RKrQlCRnrSZ0OO2y222Vf2IREBGM17VudM/exec";
    const PROXY = "https://corsproxy.io/?";

    let rawList = []; // Liste brute
    let cleanList = []; // Liste valid√©e

    // --- 1. CHARGEMENT ---
    
    async function loadFromUrl() {
        const url = document.getElementById('urlInput').value;
        if(!url) return;
        log("T√©l√©chargement du fichier M3U...");
        try {
            const res = await fetch(PROXY + encodeURIComponent(url));
            const text = await res.text();
            parseM3U(text);
        } catch(e) { log("Erreur t√©l√©chargement: " + e); }
    }

    function loadFromFile() {
        const file = document.getElementById('fileInput').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => parseM3U(e.target.result);
        reader.readAsText(file);
    }

    function parseM3U(content) {
        log("Analyse du fichier M3U...");
        rawList = [];
        const lines = content.split('\n');
        let currentName = "Sans Nom";

        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();
            if (line.startsWith("#EXTINF")) {
                // Extraction du nom (tout ce qui est apr√®s la derni√®re virgule)
                let parts = line.split(',');
                currentName = parts[parts.length - 1] || "Sans Nom";
            } else if (line.startsWith("http")) {
                // C'est un lien
                rawList.push({ name: currentName, url: line, status: 'waiting' });
            }
        }

        log(`Extraction termin√©e. ${rawList.length} cha√Ænes trouv√©es.`);
        renderList();
        
        if(rawList.length > 0) {
            document.getElementById('btn-scan').disabled = false;
            document.getElementById('s-total').innerText = rawList.length;
        }
    }

    // --- 2. AFFICHAGE ---

    function renderList() {
        const container = document.getElementById('result-list');
        // Pour ne pas faire ramer le navigateur, on affiche que les 500 premiers si la liste est √©norme lors du scan
        // Mais ici on fait simple
        let html = "";
        // On limite l'affichage HTML √† 2000 items pour la performance, mais le traitement se fera sur tout
        const displayLimit = Math.min(rawList.length, 2000); 
        
        for(let i=0; i<displayLimit; i++) {
            const item = rawList[i];
            let colorClass = item.status; // waiting, ok, dead
            let icon = item.status === 'ok' ? '‚úî' : (item.status === 'dead' ? '‚úñ' : '‚è≥');
            html += `<div class="item ${colorClass}" id="item-${i}">
                <span>${i+1}. ${item.name}</span>
                <span>${icon}</span>
            </div>`;
        }
        if(rawList.length > 2000) html += `<div style="padding:10px; text-align:center">... et ${rawList.length - 2000} autres (masqu√©s pour performance) ...</div>`;
        container.innerHTML = html;
    }

    // --- 3. ANALYSE (SCANNER) ---

    async function startScan() {
        document.getElementById('btn-scan').disabled = true;
        log("D√©marrage du test des liens...");
        
        cleanList = [];
        let okCount = 0;
        let deadCount = 0;
        const BATCH_SIZE = 10; // Tester 10 liens en m√™me temps (Vitesse vs Stabilit√©)

        for (let i = 0; i < rawList.length; i += BATCH_SIZE) {
            const chunk = rawList.slice(i, i + BATCH_SIZE);
            
            await Promise.all(chunk.map(async (item, idx) => {
                const globalIndex = i + idx;
                const isWorking = await checkUrl(item.url);
                
                if (isWorking) {
                    item.status = 'ok';
                    okCount++;
                    cleanList.push([item.name, item.url]); // Format pour Google Sheet [Nom, Url]
                } else {
                    item.status = 'dead';
                    deadCount++;
                }
                
                // Mise √† jour visuelle l√©g√®re (seulement si l'√©l√©ment est dans le DOM)
                const el = document.getElementById(`item-${globalIndex}`);
                if(el) {
                    el.className = `item ${item.status}`;
                    el.innerHTML = `<span>${globalIndex+1}. ${item.name}</span><span>${item.status === 'ok' ? '‚úî' : '‚úñ'}</span>`;
                }
            }));

            // Barre de progression
            let pct = Math.round(((i + chunk.length) / rawList.length) * 100);
            document.getElementById('p-bar').style.width = pct + "%";
            document.getElementById('s-ok').innerText = okCount;
            document.getElementById('s-dead').innerText = deadCount;
            
            // Petite pause pour ne pas figer le navigateur
            if(i % 50 === 0) await new Promise(r => setTimeout(r, 10));
        }

        log(`Analyse termin√©e. ${okCount} cha√Ænes valides pr√™tes √† l'envoi.`);
        document.getElementById('btn-save').disabled = false;
        document.getElementById('btn-save').innerText = `ENVOYER ${okCount} CHA√éNES AU SERVEUR`;
    }

    async function checkUrl(url) {
        try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 3000); // 3 secondes timeout
            // On utilise le proxy pour le test HEAD (rapide)
            const res = await fetch(PROXY + encodeURIComponent(url), { method: 'HEAD', signal: controller.signal });
            clearTimeout(id);
            return res.ok;
        } catch(e) {
            return false;
        }
    }

    // --- 4. SAUVEGARDE SUR GOOGLE SHEET ---

    async function sendToServer() {
        if(cleanList.length === 0) return alert("Aucune cha√Æne valide √† envoyer !");
        
        const btn = document.getElementById('btn-save');
        btn.disabled = true;
        btn.innerText = "ENVOI EN COURS...";
        log("Envoi des donn√©es vers Google Sheets...");

        // On envoie par paquets de 500 pour ne pas d√©passer la limite de Google
        const CHUNK_SIZE = 500;
        for (let i = 0; i < cleanList.length; i += CHUNK_SIZE) {
            const chunk = cleanList.slice(i, i + CHUNK_SIZE);
            log(`Envoi du paquet ${i} √† ${i + chunk.length}...`);
            
            try {
                await fetch(`${API_URL}?action=admin_import_bulk`, {
                    method: 'POST',
                    body: JSON.stringify(chunk)
                });
            } catch(e) {
                log("Erreur d'envoi: " + e);
                alert("Erreur lors de l'envoi d'un paquet. V√©rifiez la console.");
                btn.disabled = false;
                return;
            }
        }

        log("‚úÖ TOUT EST SAUVEGARD√â !");
        alert("Succ√®s ! Les cha√Ænes valides sont maintenant dans votre application.");
        btn.innerText = "TERMINE";
    }

    function log(msg) {
        const div = document.getElementById('log');
        div.innerHTML += `<div>${msg}</div>`;
        div.scrollTop = div.scrollHeight;
    }

</script>
</body>
</html>
