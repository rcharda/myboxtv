<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Box TV - V71 Ultimate</title>
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #e50914; --glass: rgba(15, 15, 15, 0.95); --text: #fff; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #000; color: var(--text); height: 100vh; overflow: hidden; }

        /* --- MOTEUR HYBRIDE V71 --- */
        #video-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: #000; display: flex; align-items: center; justify-content: center; }
        
        /* Lecteur Vid√©o (HLS) */
        video { width: 100%; height: 100%; object-fit: contain; display: block; }
        
        /* Lecteur Web (Iframe) - Cach√© par d√©faut */
        iframe { width: 100%; height: 100%; border: none; display: none; background: #000; position: absolute; top:0; left:0; z-index: 1; }
        
        /* Bouclier tactile pour contr√¥ler le menu m√™me sur une Iframe */
        #touch-shield { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; background: transparent; display: none; }
        /* -------------------------- */

        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        #status-pill { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); padding: 8px 15px; border-radius: 20px; border: 1px solid #444; font-size: 12px; color: #fff; z-index: 60; display: flex; align-items: center; gap: 8px; pointer-events: none; }
        #led { width: 8px; height: 8px; background: red; border-radius: 50%; transition: 0.3s; }
        #led.green { background: #0f0; box-shadow: 0 0 5px #0f0; }
        #led.orange { background: orange; box-shadow: 0 0 5px orange; }

        #channel-menu { position: fixed; top: 0; left: 0; width: 350px; height: 100%; background: var(--glass); backdrop-filter: blur(15px); transform: translateX(-100%); transition: transform 0.3s; display: flex; flex-direction: column; z-index: 100; pointer-events: auto; border-right: 1px solid #333; }
        body.menu-open #channel-menu { transform: translateX(0); }

        .menu-header { padding: 15px; background: #111; border-bottom: 2px solid var(--primary); display: flex; flex-direction:column; align-items: center; gap:5px;}
        #searchInput { width: 95%; margin: 5px auto; padding: 10px; border-radius: 5px; background: #333; border: none; color: white; display: block; font-size: 14px; }
        
        .filter-bar { display: flex; gap: 5px; padding: 5px 10px; border-bottom: 1px solid #333; background: #1a1a1a; }
        .btn-mini { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #2a2a2a; color: #ccc; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-weight: 600; }
        .btn-mini.active { background: #333; color: white; border-color: #666; }
        .btn-local { background: linear-gradient(45deg, #e50914, #900); color: white; border: none; }

        #channel-list { flex: 1; overflow-y: auto; padding: 0; width:100%; }
        .channel-row { display: flex; align-items: center; padding: 10px 15px; margin: 0; border-bottom: 1px solid #222; cursor: pointer; contain: content; }
        .channel-row:hover { background: #222; }
        .channel-row.active { background: rgba(229,9,20,0.2); border-left: 3px solid var(--primary); }
        .ch-logo { width: 35px; height: 35px; object-fit: contain; background: #fff; padding: 2px; border-radius: 3px; margin-right: 10px; }
        
        /* Badges pour voir le type de flux */
        .tag { font-size: 9px; padding: 2px 5px; border-radius: 3px; margin-left: auto; font-weight: bold; }
        .tag-web { background: #007bff; color: white; }
        .tag-tv { background: #28a745; color: white; }

        #bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); padding: 8px 15px; border-radius: 40px; border: 1px solid #333; display: flex; gap: 10px; align-items: center; z-index: 90; pointer-events: auto; width: auto; max-width: 98%; justify-content: space-between; flex-wrap: nowrap; overflow-x: auto; }
        .btn-ctrl { width: 45px; height: 45px; border-radius: 50%; background: #2a2a2a; color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; flex-shrink: 0; transition: 0.2s; }
        .btn-ctrl:active { background: var(--primary); transform: scale(0.95); }
        .btn-large { width: 55px; height: 55px; font-size: 22px; background: var(--primary); border: 2px solid white; box-shadow: 0 0 10px rgba(229,9,20,0.5); }
        .desktop-only { display: flex; }
        @media (max-width: 600px) { .desktop-only { display: none; } #bottom-bar { gap: 5px; padding: 5px 10px; bottom: 10px; } .btn-large { width: 48px; height: 48px; font-size: 20px; } #channel-menu { width: 85%; } }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center; pointer-events: auto; }
        .modal-box { background: #1a1a1a; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #444; }
        .app-logo { max-width: 150px; margin-bottom: 20px; }
        
        /* Bouton "Activer le son" pour les iframes */
        #unlock-btn {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(229, 9, 20, 0.9); color: white; padding: 15px 30px; 
            border-radius: 50px; font-weight: bold; z-index: 20; display: none; 
            border: 2px solid white; animation: pulse 2s infinite; cursor: pointer;
        }
        @keyframes pulse { 0% {transform: translate(-50%, -50%) scale(1);} 50% {transform: translate(-50%, -50%) scale(1.05);} 100% {transform: translate(-50%, -50%) scale(1);} }
    </style>
</head>
<body>

<div id="login-screen" class="modal" style="display:flex;">
    <div class="modal-box">
        <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" class="app-logo">
        <input type="text" id="licenseKey" placeholder="ID ABONNEMENT" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:5px; text-align:center; font-size:18px; margin-bottom:15px;">
        <button onclick="login()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:5px; font-weight:bold;">ENTRER</button>
        <div id="login-msg" style="color:#ff4444; margin-top:10px;"></div>
    </div>
</div>

<div id="video-layer">
    <video id="video" onclick="toggleMenu()" playsinline crossorigin="anonymous"></video>
    
    <iframe id="web-player" allow="autoplay; encrypted-media; fullscreen; picture-in-picture" sandbox="allow-forms allow-scripts allow-same-origin allow-presentation allow-popups"></iframe>
    
    <div id="touch-shield" onclick="toggleMenu()"></div>
    <div id="unlock-btn" onclick="unlockIframe()"><i class="fas fa-hand-pointer"></i> CLIQUER ICI</div>
</div>

<div id="ui-layer">
    <div id="status-pill"><div id="led"></div><span id="status-text">Pr√™t</span></div>
    
    <div id="channel-menu">
        <div class="menu-header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" style="width:100px;">
            <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
                <div style="text-align:left; width:100%;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:14px; font-weight:bold;">CHA√éNES</span>
                        <i class="fas fa-sync-alt" onclick="initApp()" style="cursor:pointer; font-size:12px; color:#aaa;" title="Recharger"></i>
                    </div>
                    <div style="font-size:10px; color:#888;" id="count-display">0 trouv√©es</div>
                </div>
                <i class="fas fa-cog" style="cursor:pointer; color:#fff; font-size:20px;"></i>
            </div>
        </div>
        
        <input type="text" id="searchInput" placeholder="üîç Rechercher...">
        
        <div class="filter-bar">
            <button onclick="toggleOnlyFavorites()" class="btn-mini" id="btn-fav-filter">
                <i class="fas fa-star" style="color:gold;"></i> Favoris
            </button>
            <button onclick="window.location.href='en_direct.html'" class="btn-mini btn-local">
                <i class="fas fa-th"></i> Mode Grille
            </button>
        </div>

        <div id="channel-list"></div>
    </div>

    <div id="bottom-bar">
        <button class="btn-ctrl" onclick="prevChannel()"><i class="fas fa-step-backward"></i></button>
        <button class="btn-ctrl desktop-only" onclick="adjustVol(-0.1)"><i class="fas fa-minus"></i></button>
        <button class="btn-ctrl btn-large" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
        <button class="btn-ctrl desktop-only" onclick="adjustVol(0.1)"><i class="fas fa-plus"></i></button>
        <button class="btn-ctrl" onclick="nextChannel()"><i class="fas fa-step-forward"></i></button>
        <button class="btn-ctrl" onclick="toggleFullScreen()"><i class="fas fa-expand"></i></button>
    </div>
</div>

<script>
    // =======================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbwg49-A8a5q72hnhcf99865CBqAErbxAMUX4TDDsR47anl4ELo6iZhDzS2hH4yMMJ1CcQ/exec";
    // =======================================================

    // LE C≈íUR DE LA V71 : LES OUTILS PUISSANTS
    const PROXY_FETCH = "https://api.allorigins.win/raw?url="; // Pour t√©l√©charger la liste
    const PROXY_VIDEO = "https://corsproxy.io/?"; // Pour r√©parer la vid√©o
    const DEFAULT_CHANNEL = { name: "Novelas TV", url: "https://stormcast-telenovelatv-1-fr.samsung.wurl.tv/playlist.m3u8", logo: "https://upload.wikimedia.org/wikipedia/commons/2/29/Novelas_TV_Logo.png" };

    let allChannels = [], displayedChannels = [], currentChannelIndex = 0;
    let favorites = JSON.parse(localStorage.getItem('mybox_favs') || '[]');
    let deviceId = localStorage.getItem('mybox_device_id') || 'DEV-'+Math.random().toString(36).substr(2,9).toUpperCase();
    localStorage.setItem('mybox_device_id', deviceId);
    let isFavFilter = false, hls = null;

    const video = document.getElementById('video');
    const iframe = document.getElementById('web-player');
    const shield = document.getElementById('touch-shield');
    const unlockBtn = document.getElementById('unlock-btn');
    const statusText = document.getElementById('status-text');
    const led = document.getElementById('led');

    if(localStorage.getItem('mybox_auth') === 'OK') { document.getElementById('login-screen').style.display = 'none'; initApp(); }

    async function login() {
        const key = document.getElementById('licenseKey').value.trim();
        try {
            const res = await fetch(`${API_URL}?action=login&key=${encodeURIComponent(key)}&device=${encodeURIComponent(deviceId)}`);
            if((await res.text()).includes("SUCCESS")) {
                localStorage.setItem('mybox_auth', 'OK'); localStorage.setItem('mybox_key', key);
                document.getElementById('login-screen').style.display = 'none'; initApp();
            } else alert("Erreur Compte");
        } catch(e) { alert("Erreur Internet"); }
    }

    async function initApp() {
        fetchTranspondersList();
    }

    async function fetchTranspondersList() {
        try {
            // 1. On r√©cup√®re la liste des transpondeurs (Excel)
            const res = await fetch(`${API_URL}?action=get_playlists`);
            const json = await res.json();
            
            allChannels = []; // Reset
            
            // 2. On charge chaque playlist avec le "BULLDOZER" (Proxy)
            for(let tp of json) {
                await fetchPlaylistRobust(tp.url);
            }
        } catch(e) { console.log("Erreur Init", e); }
    }

    async function fetchPlaylistRobust(url) {
        statusText.innerText = "Chargement...";
        try {
            // ESSAI 1 : Via le Proxy Puissant (Comme html_test)
            let finalUrl = PROXY_FETCH + encodeURIComponent(url) + "&t=" + Date.now();
            let response = await fetch(finalUrl);
            if(!response.ok) throw new Error("Erreur Proxy");
            let text = await response.text();
            processM3U(text);
        } catch(e) {
            console.log("Echec chargement liste");
        }
    }

    function processM3U(data) {
        const lines = data.split('\n');
        let currentInfo = null;

        for (let line of lines) {
            line = line.trim();
            if (line.startsWith('#EXTINF:')) {
                const parts = line.split(',');
                let name = parts[1] || "Cha√Æne";
                let logo = (line.match(/tvg-logo=["']?([^"']*)["']?/) || [])[1];
                currentInfo = { name: name, logo: logo };
            } else if (line.startsWith('http')) {
                if (currentInfo) {
                    // D√âTECTION INTELLIGENTE (V71)
                    // Si pas m3u8/ts/mp4 -> C'est du WEB
                    let isWeb = true;
                    if (line.includes('.m3u8') || line.includes('.ts') || line.includes('.mp4')) {
                        isWeb = false;
                    }
                    
                    // On accepte TOUT maintenant (Web + Video)
                    allChannels.push({ ...currentInfo, url: line, isWeb: isWeb });
                    currentInfo = null;
                }
            }
        }
        renderList();
        document.getElementById('count-display').innerText = allChannels.length + " cha√Ænes";
        if(allChannels.length > 0 && video.paused && iframe.style.display === "none") playChannel(0);
    }

    function renderList() {
        const list = document.getElementById('channel-list');
        list.innerHTML = "";
        const term = document.getElementById('searchInput').value.toLowerCase();
        
        const filtered = allChannels.filter(ch => {
            return ch.name.toLowerCase().includes(term) && (isFavFilter ? favorites.includes(ch.url) : true);
        });

        filtered.slice(0, 200).forEach((ch) => { // Limite affichage pour performance
            const isPlaying = (ch.url === allChannels[currentChannelIndex]?.url);
            const div = document.createElement('div');
            div.className = 'channel-row ' + (isPlaying ? 'active' : '');
            
            let tag = ch.isWeb ? '<span class="tag tag-web">WEB</span>' : '<span class="tag tag-tv">TV</span>';
            
            div.innerHTML = `<img src="${ch.logo || 'https://via.placeholder.com/40'}" class="ch-logo">
                             <div style="font-weight:600; font-size:14px;">${ch.name}</div>
                             ${tag}`;
            div.onclick = () => { currentChannelIndex = allChannels.indexOf(ch); playChannel(currentChannelIndex); };
            list.appendChild(div);
        });
    }
    
    document.getElementById('searchInput').addEventListener('input', renderList);
    function toggleOnlyFavorites() { isFavFilter = !isFavFilter; document.getElementById('btn-fav-filter').style.background = isFavFilter ? '#e50914' : '#2a2a2a'; renderList(); }

    // --- LE MOTEUR DE LECTURE V71 (HYBRIDE + AUTO-REPAIR) ---
    function playChannel(index) {
        if(!allChannels[index]) return;
        const ch = allChannels[index];
        if(window.innerWidth < 900) document.body.classList.remove('menu-open');
        renderList(); 
        statusText.innerText = ch.name; led.className = "orange";

        // CAS 1 : CHAINE WEB (Iframe)
        if (ch.isWeb) {
            video.style.display = "none";
            video.pause();
            if(hls) hls.destroy();
            
            let sep = ch.url.includes('?') ? '&' : '?';
            iframe.src = ch.url + sep + "autoplay=1&muted=1&playsinline=1"; // Autoplay forc√©
            iframe.style.display = "block";
            
            // Activation du bouclier pour g√©rer le menu
            shield.style.display = "block";
            unlockBtn.style.display = "block"; // Bouton pour interagir avec le site
            led.className = "green";
            return;
        }

        // CAS 2 : CHAINE VIDEO (HLS)
        iframe.style.display = "none";
        iframe.src = "";
        shield.style.display = "none";
        unlockBtn.style.display = "none";
        video.style.display = "block";
        
        if(Hls.isSupported()) {
            if(hls) hls.destroy(); 
            hls = new Hls({manifestLoadingMaxRetry: 3, manifestLoadingTimeOut: 10000});
            
            // Essai Direct
            hls.loadSource(ch.url); 
            hls.attachMedia(video);
            
            hls.on(Hls.Events.MANIFEST_PARSED, () => { 
                video.play().catch(()=>{}); 
                led.className = "green"; 
            });
            
            // AUTO-REPAIR : Si erreur, on tente le Proxy (Comme html_test)
            hls.on(Hls.Events.ERROR, (e,d) => { 
                if(d.fatal) { 
                    console.log("Erreur HLS -> Tentative R√©paration...");
                    statusText.innerText = "R√©paration...";
                    hls.destroy();
                    hls = new Hls();
                    // On injecte le proxy correcteur
                    hls.loadSource(PROXY_VIDEO + encodeURIComponent(ch.url));
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => { 
                        video.play(); 
                        led.className = "green"; 
                        statusText.innerText = ch.name + " (R)";
                    });
                } 
            });
        } else if(video.canPlayType('application/vnd.apple.mpegurl')) { 
            video.src = ch.url; video.play(); 
        }
    }

    // Gestion Iframe (Cliquer pour enlever le bouclier)
    function unlockIframe() {
        shield.style.display = "none";
        unlockBtn.style.display = "none";
        // L'utilisateur peut maintenant cliquer sur le site (Volume, etc.)
        // Le menu ne s'ouvrira plus au clic, il faut utiliser le bouton du bas
    }

    function toggleMenu() { document.body.classList.toggle('menu-open'); }
    function nextChannel() { let n = currentChannelIndex + 1; if(n >= allChannels.length) n = 0; currentChannelIndex = n; playChannel(n); }
    function prevChannel() { let n = currentChannelIndex - 1; if(n < 0) n = allChannels.length - 1; currentChannelIndex = n; playChannel(n); }
    function adjustVol(d) { video.volume = Math.min(1, Math.max(0, video.volume + d)); }
    function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else if (document.exitFullscreen) document.exitFullscreen(); }
</script>
</body>
</html>
