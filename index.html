<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Box TV - V39 Ultimate</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #e50914; --glass: rgba(15, 15, 15, 0.95); --text: #fff; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #000; color: var(--text); height: 100vh; overflow: hidden; }

        /* VIDEO LAYER */
        #video-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: #000; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* UI LAYER */
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        /* STATUS PILL (BULLE INFO) */
        #status-pill {
            position: absolute; top: 20px; right: 20px; 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            padding: 8px 15px; border-radius: 20px; border: 1px solid #444;
            font-size: 12px; color: #fff; z-index: 60; 
            display: flex; align-items: center; gap: 8px; pointer-events: none;
        }
        #led { width: 8px; height: 8px; background: red; border-radius: 50%; transition: 0.3s; }
        #led.green { background: #0f0; box-shadow: 0 0 5px #0f0; }
        #led.orange { background: orange; box-shadow: 0 0 5px orange; }

        /* MENU LATERAL */
        #channel-menu {
            position: fixed; top: 0; left: 0; width: 350px; height: 100%; 
            background: var(--glass); backdrop-filter: blur(15px);
            transform: translateX(-100%); transition: transform 0.3s;
            display: flex; flex-direction: column; z-index: 100; pointer-events: auto;
            border-right: 1px solid #333;
        }
        body.menu-open #channel-menu { transform: translateX(0); }

        .menu-header { padding: 20px; background: #111; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center;}
        #searchInput { width: 90%; margin: 10px auto; padding: 12px; border-radius: 20px; background: #333; border: none; color: white; display: block; }
        
        #channel-list { flex: 1; overflow-y: auto; padding: 5px; }
        .channel-row { display: flex; align-items: center; padding: 10px; margin: 2px 0; border-radius: 8px; cursor: pointer; }
        .channel-row:hover { background: #222; }
        .channel-row.active { background: rgba(229,9,20,0.3); border-left: 3px solid var(--primary); }
        .ch-logo { width: 40px; height: 40px; object-fit: contain; background: #fff; padding: 2px; border-radius: 4px; margin-right: 10px; }
        .fav-icon { color: #444; padding: 5px; margin-right: 5px; font-size: 14px; }
        .fav-icon.active { color: #ffd700; text-shadow: 0 0 5px gold; } 

        /* BARRE DE CONTROLE */
        #bottom-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px);
            padding: 8px 15px; border-radius: 40px; border: 1px solid #333;
            display: flex; gap: 10px; align-items: center; z-index: 90;
            pointer-events: auto; width: auto; max-width: 98%;
            justify-content: space-between; flex-wrap: nowrap; overflow-x: auto;
        }
        .btn-ctrl {
            width: 45px; height: 45px; border-radius: 50%; background: #2a2a2a; color: white;
            border: none; display: flex; align-items: center; justify-content: center;
            font-size: 18px; cursor: pointer; flex-shrink: 0; transition: 0.2s;
        }
        .btn-ctrl:active { background: var(--primary); transform: scale(0.95); }
        .btn-ctrl.active-mode { background: var(--primary); color: white; box-shadow: 0 0 10px var(--primary); animation: pulse 2s infinite; }
        .btn-large { width: 55px; height: 55px; font-size: 22px; background: var(--primary); border: 2px solid white; box-shadow: 0 0 10px rgba(229,9,20,0.5); }

        /* ELEMENTS CACHÃ‰S SUR MOBILE */
        .desktop-only { display: flex; }
        @media (max-width: 600px) {
            .desktop-only { display: none; }
            #bottom-bar { gap: 5px; padding: 5px 10px; bottom: 10px; }
            .btn-ctrl { width: 40px; height: 40px; font-size: 16px; }
            .btn-large { width: 48px; height: 48px; font-size: 20px; }
            #channel-menu { width: 85%; }
        }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center; pointer-events: auto; }
        .modal-box { background: #1a1a1a; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #444; }
        .pin-input { font-size: 30px; letter-spacing: 10px; width: 150px; text-align: center; background: #333; color: white; border: none; padding: 10px; border-radius: 5px; margin: 20px 0; }

        /* SETTINGS STYLE */
        .settings-panel { background: #1a1a1a; width: 90%; max-width: 800px; height: 80vh; border-radius: 15px; border: 1px solid #444; display: flex; overflow: hidden; }
        .settings-sidebar { width: 200px; background: #111; padding: 20px; border-right: 1px solid #333; }
        .settings-tab { padding: 15px; cursor: pointer; color: #888; font-weight: 600; border-radius: 8px; margin-bottom: 5px; }
        .settings-tab.active { background: #222; color: white; }
        .settings-content { flex: 1; padding: 20px; overflow-y: auto; }
        .chips-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .chip { padding: 8px 15px; background: #333; border-radius: 20px; font-size: 12px; cursor: pointer; border: 1px solid transparent; }
        .chip.selected { background: var(--primary); color: white; }
        .input-dark { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; }
        @media (max-width: 700px) { .settings-panel { flex-direction: column; } .settings-sidebar { width: 100%; height: auto; display: flex; overflow-x: auto; } }

        /* MESSAGE ADMIN */
        #admin-msg-box { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 15px 30px; border-radius: 30px; z-index: 300; display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.5); font-weight: bold; text-align: center; width: 90%; animation: slideDown 0.5s; }
        @keyframes slideDown { from { top: -50px; } to { top: 10%; } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(229, 9, 20, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(229, 9, 20, 0); } 100% { box-shadow: 0 0 0 0 rgba(229, 9, 20, 0); } }
    </style>
</head>
<body>

<div id="admin-msg-box">Message du serveur...</div>

<div id="pin-modal" class="modal">
    <div class="modal-box">
        <h3 style="color:#e50914;"><i class="fas fa-lock"></i> CONTRÃ”LE PARENTAL</h3>
        <p>Cette chaÃ®ne est restreinte.</p>
        <input type="password" id="pin-code" class="pin-input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢">
        <div style="display:flex; gap:10px; justify-content:center;">
            <button onclick="checkPin()" style="padding:10px 20px; background:#e50914; color:white; border:none; border-radius:5px;">Valider</button>
            <button onclick="closePin()" style="padding:10px 20px; background:#444; color:white; border:none; border-radius:5px;">Annuler</button>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal">
    <div class="settings-panel">
        <div class="settings-sidebar">
            <div style="font-weight:bold; margin-bottom:20px; color:var(--primary)">RÃ‰GLAGES</div>
            <div class="settings-tab active" onclick="showTab('tab-cat')">CatÃ©gories</div>
            <div class="settings-tab" onclick="showTab('tab-source')">Sources</div>
            <div class="settings-tab" onclick="showTab('tab-sub')">Compte</div>
            <div class="settings-tab" onclick="closeSettings()" style="color:#ff4444; margin-top:10px;">Fermer âœ•</div>
        </div>
        <div class="settings-content">
            <div id="tab-cat" class="tab-content">
                <h3>Filtrer les chaÃ®nes</h3>
                <div id="chips-area" class="chips-container"></div>
                <button onclick="applyFilters()" style="margin-top:20px; width:100%; background:var(--primary); border:none; color:white; padding:10px; border-radius:5px;">Appliquer</button>
                <br><br>
                <button onclick="restoreHidden()" style="background:#444; border:none; color:white; padding:10px; border-radius:5px;">Restaurer chaÃ®nes supprimÃ©es</button>
            </div>
            <div id="tab-source" class="tab-content" style="display:none;">
                <h3>Ajouter source</h3>
                <input type="text" id="custom-source" class="input-dark" placeholder="http://...">
                <button onclick="addSource()" style="margin-top:10px; background:#28a745; border:none; color:white; padding:10px; border-radius:5px;">Ajouter</button>
                <button onclick="resetSources()" style="margin-top:10px; background:#444; border:none; color:white; padding:10px; border-radius:5px;">Reset</button>
            </div>
            <div id="tab-sub" class="tab-content" style="display:none;">
                <h3>Mon Abonnement</h3>
                <div style="background:#222; padding:20px; border-radius:10px; margin-bottom:20px;">
                    Statut: <span style="color:#0f0;">Actif</span><br>
                    ID: <span id="sub-id">...</span><br>
                    Infos: <span id="sub-details">...</span>
                </div>
                <button onclick="logout()" style="width:100%; background:#ff4444; color:white; border:none; padding:15px; border-radius:8px; font-weight:bold; cursor:pointer;">SE DÃ‰CONNECTER (LIBÃ‰RER SLOT)</button>
                <br><br>
                <a href="https://wa.me/22963828767?text=Support" target="_blank" style="display:block; background:#25D366; color:white; padding:10px; text-align:center; border-radius:5px; text-decoration:none;">Support WhatsApp</a>
            </div>
        </div>
    </div>
</div>

<div id="login-screen" class="modal" style="display:flex;">
    <div class="modal-box">
        <h2>MY BOX <span style="color:var(--primary)">TV</span></h2>
        <input type="text" id="licenseKey" placeholder="ID ABONNEMENT" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:5px; text-align:center; font-size:18px; margin-bottom:15px;">
        <button onclick="login()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:5px; font-weight:bold;">ENTRER</button>
        <div id="login-msg" style="color:#ff4444; margin-top:10px;"></div>
    </div>
</div>

<div id="video-layer">
    <video id="video" onclick="toggleMenu()" playsinline></video>
</div>

<div id="ui-layer">
    
    <div id="status-pill">
        <div id="led"></div>
        <span id="status-text">PrÃªt</span>
    </div>

    <div id="channel-menu">
        <div class="menu-header">
            <div>
                <span style="font-weight:bold; font-size:18px;">CHAÃŽNES</span>
                <div style="font-size:11px; color:#888;" id="count-display">0 trouvÃ©es</div>
            </div>
            <i class="fas fa-cog" onclick="openSettings()" style="cursor:pointer; color:#fff; font-size:20px;"></i>
        </div>
        <input type="text" id="searchInput" placeholder="ðŸ” Rechercher...">
        <div style="padding:10px; border-bottom:1px solid #333;">
            <button onclick="toggleOnlyFavorites()" id="btn-fav-filter" style="width:100%; background:#222; color:white; border:1px solid #444; padding:8px; border-radius:5px;">
                <i class="fas fa-star" style="color:gold;"></i> Voir mes Favoris
            </button>
        </div>
        <div id="channel-list"></div>
    </div>

    <div id="bottom-bar">
        <button class="btn-ctrl" onclick="prevChannel()"><i class="fas fa-step-backward"></i></button>
        <button class="btn-ctrl desktop-only" onclick="adjustVol(-0.1)"><i class="fas fa-minus"></i></button>
        
        <button class="btn-ctrl btn-large" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
        
        <button class="btn-ctrl desktop-only" onclick="adjustVol(0.1)"><i class="fas fa-plus"></i></button>
        <button class="btn-ctrl" onclick="nextChannel()"><i class="fas fa-step-forward"></i></button>
        
        <button class="btn-ctrl" id="btn-autozap" onclick="toggleAutoZap()"><i class="fas fa-bolt"></i></button>
        
        <button class="btn-ctrl" onclick="hideCurrentChannel()" style="color:#ff4444;"><i class="fas fa-trash"></i></button>

        <button class="btn-ctrl" onclick="toggleFullScreen()"><i class="fas fa-expand"></i></button>
    </div>
</div>

<script>
    // =======================================================
    // TON NOUVEAU LIEN :
    const API_URL = "https://script.google.com/macros/s/AKfycbwQCnmfYQKoRjpkVtShj0JgE7iaDlwdQz0qkXmYNvOaSG7F4MW_qEAXvWs_LAWNMAQK6A/exec";
    // =======================================================

    const DEFAULT_CHANNEL = { name: "Novelas TV", url: "https://stormcast-telenovelatv-1-fr.samsung.wurl.tv/playlist.m3u8", logo: "https://upload.wikimedia.org/wikipedia/commons/2/29/Novelas_TV_Logo.png", category: "Start" };
    const PIN_CODE = "0000"; 

    let allChannels = [];
    let displayedChannels = [];
    let loadedUrls = new Set();
    let favorites = JSON.parse(localStorage.getItem('mybox_favs') || '[]');
    let currentChannelIndex = 0;
    let deviceId = localStorage.getItem('mybox_device_id') || 'DEV-'+Math.random().toString(36).substr(2,9).toUpperCase();
    localStorage.setItem('mybox_device_id', deviceId);
    let isFavFilter = false;
    let hls = null;
    let pendingChannelIndex = -1;
    let isAutoZap = false; 
    let allCategories = new Set(['Favoris']);
    let selectedCategories = JSON.parse(localStorage.getItem('mybox_categories') || '[]');
    let hiddenChannels = JSON.parse(localStorage.getItem('mybox_hidden') || '[]');

    const video = document.getElementById('video');
    const statusText = document.getElementById('status-text');
    const led = document.getElementById('led');

    // --- INIT ---
    if(localStorage.getItem('mybox_auth') === 'OK') {
        document.getElementById('login-screen').style.display = 'none';
        updateAccountDisplay(localStorage.getItem('mybox_key'), localStorage.getItem('mybox_raw_status'));
        initApp();
    }

    async function login() {
        const key = document.getElementById('licenseKey').value.trim();
        if(key.length < 2) return;
        try {
            const res = await fetch(`${API_URL}?action=login&key=${encodeURIComponent(key)}&device=${encodeURIComponent(deviceId)}`);
            const text = await res.text();
            if(text.includes("SUCCESS")) {
                localStorage.setItem('mybox_auth', 'OK');
                localStorage.setItem('mybox_key', key);
                localStorage.setItem('mybox_raw_status', text);
                updateAccountDisplay(key, text);
                document.getElementById('login-screen').style.display = 'none';
                initApp();
            } else {
                let msg = "Erreur Inconnue";
                if(text.includes("EXPIRED")) msg = "ABONNEMENT EXPIRÃ‰";
                if(text.includes("DEVICE")) msg = "TROP D'Ã‰CRANS";
                document.getElementById('login-msg').innerText = msg;
            }
        } catch(e) { alert("Erreur Internet"); }
    }

    function updateAccountDisplay(key, raw) {
        document.getElementById('sub-id').innerText = key;
        if(raw) {
            const parts = raw.split(':');
            if(parts.length >= 3) document.getElementById('sub-details').innerText = "Expire: " + parts[1] + "j | Ecrans: " + parts[2];
        }
    }

    async function logout() {
        if(!confirm("DÃ©connecter cet appareil ?")) return;
        const key = localStorage.getItem('mybox_key');
        try { await fetch(`${API_URL}?action=logout&key=${encodeURIComponent(key)}&device=${encodeURIComponent(deviceId)}`); } catch(e){}
        localStorage.removeItem('mybox_auth');
        location.reload();
    }

    async function initApp() {
        checkAdminMessage();
        loadCache();
        addChannelToFront(DEFAULT_CHANNEL);
        
        if(allChannels.length > 0) playChannel(0);

        try {
            const res = await fetch(`${API_URL}?action=get_playlists`);
            const text = await res.text();
            let sources = text.startsWith("PLAYLISTS:") ? text.replace("PLAYLISTS:","").split(",,,") : ["https://iptv-org.github.io/iptv/index.m3u"];
            sources.sort((a,b) => a.includes("index.m3u") ? 1 : -1);
            
            for(let s of sources) await fetchPlaylist(s);
            
        } catch(e) { console.log("Offline"); }
    }

    function addChannelToFront(ch) {
        if(!loadedUrls.has(ch.url)) {
            allChannels.unshift(ch);
            loadedUrls.add(ch.url);
            renderList();
        }
    }

    async function fetchPlaylist(url) {
        try {
            const res = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(url));
            if(!res.ok) return;
            const text = await res.text();
            const lines = text.split('\n');
            let info = {}, count = 0;
            
            for(let line of lines) {
                line = line.trim();
                if(line.startsWith('#EXTINF:')) {
                    const parts = line.split(',');
                    let cat = (line.match(/group-title="([^"]*)"/) || [])[1] || "Autres";
                    let logo = (line.match(/tvg-logo="([^"]*)"/) || [])[1];
                    info = { name: parts[1] || "TV", logo: logo, category: cat };
                    allCategories.add(cat);
                } else if(line.startsWith('http') && !line.endsWith('.m3u')) {
                    if(info.name) {
                        const ch = { ...info, url: line };
                        // ADDITIVE SCAN: On n'ajoute que si c'est nouveau
                        if(!loadedUrls.has(ch.url) && !hiddenChannels.includes(ch.url)) {
                            allChannels.push(ch);
                            loadedUrls.add(ch.url);
                            count++;
                        }
                        info = {};
                    }
                }
            }
            if(count > 0) {
                updateCategoryChips();
                renderList();
                saveCache();
            }
        } catch(e){}
    }

    async function checkAdminMessage() {
        try {
            const res = await fetch(`${API_URL}?action=get_message`);
            const text = await res.text();
            if(text.startsWith("MSG:") && text.length > 5) {
                const box = document.getElementById('admin-msg-box');
                box.innerText = "ðŸ“¢ " + text.replace("MSG:", "");
                box.style.display = "block";
                setTimeout(() => box.style.display = "none", 8000);
            }
        } catch(e){}
    }

    // --- RENDERING ---
    function toggleFavorite(url, e) {
        e.stopPropagation(); 
        if(favorites.includes(url)) favorites = favorites.filter(u => u !== url);
        else favorites.push(url);
        localStorage.setItem('mybox_favs', JSON.stringify(favorites));
        renderList();
    }

    function toggleOnlyFavorites() {
        isFavFilter = !isFavFilter;
        document.getElementById('btn-fav-filter').style.background = isFavFilter ? '#e50914' : '#222';
        renderList();
    }

    function renderList() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        
        displayedChannels = allChannels.filter(ch => {
            let catOK = true;
            if(selectedCategories.length > 0 && !selectedCategories.includes(ch.category || "Autres")) catOK = false;
            
            const matchSearch = ch.name.toLowerCase().includes(term);
            const matchFav = isFavFilter ? favorites.includes(ch.url) : true;
            return catOK && matchSearch && matchFav;
        });

        displayedChannels.sort((a,b) => {
            const favA = favorites.includes(a.url);
            const favB = favorites.includes(b.url);
            if(favA && !favB) return -1;
            if(!favA && favB) return 1;
            return 0;
        });

        const list = document.getElementById('channel-list');
        list.innerHTML = "";
        const frag = document.createDocumentFragment();
        
        displayedChannels.forEach((ch, idx) => {
            const isFav = favorites.includes(ch.url);
            const div = document.createElement('div');
            div.className = 'channel-row ' + (ch.url === allChannels[currentChannelIndex]?.url ? 'active' : '');
            div.innerHTML = `
                <i class="fas fa-star fav-icon ${isFav ? 'active' : ''}" onclick="toggleFavorite('${ch.url}', event)"></i>
                <img src="${ch.logo || 'https://via.placeholder.com/40'}" class="ch-logo">
                <div style="font-weight:600; font-size:14px;">${ch.name}</div>
            `;
            div.onclick = () => tryPlayChannel(ch);
            frag.appendChild(div);
        });
        list.appendChild(frag);
        document.getElementById('count-display').innerText = displayedChannels.length + " ChaÃ®nes";
    }

    document.getElementById('searchInput').addEventListener('input', renderList);

    // --- PLAYER & SMART ZAP ---
    function tryPlayChannel(ch) {
        const name = ch.name.toLowerCase();
        if(name.includes('adult') || name.includes('xxx') || name.includes('porn')) {
            pendingChannelIndex = allChannels.indexOf(ch);
            document.getElementById('pin-modal').style.display = 'flex';
        } else {
            currentChannelIndex = allChannels.indexOf(ch);
            playChannel(currentChannelIndex);
        }
    }

    function checkPin() {
        if(document.getElementById('pin-code').value === PIN_CODE) {
            closePin(); currentChannelIndex = pendingChannelIndex; playChannel(currentChannelIndex);
        } else alert("Code ErronÃ©");
    }
    function closePin() { document.getElementById('pin-modal').style.display = 'none'; }

    function playChannel(index) {
        if(!allChannels[index]) return;
        const ch = allChannels[index];
        if(window.innerWidth < 900) document.body.classList.remove('menu-open');
        renderList(); 

        statusText.innerText = ch.name;
        led.className = "orange"; // Chargement

        if(Hls.isSupported()) {
            if(hls) hls.destroy();
            hls = new Hls({manifestLoadingMaxRetry: 2});
            hls.loadSource(ch.url);
            hls.attachMedia(video);
            
            // SMART ZAP : Si Ã§a marche, on annule le timer
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                video.play().catch(()=>{});
                led.className = "green";
                clearTimeout(autoZapTimeout);
            });
            hls.on(Hls.Events.ERROR, (e,d) => { if(d.fatal) handleError(); });
        } else if(video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = ch.url;
            video.play();
        }
        
        // SMART ZAP : Timeout 15s
        if(isAutoZap) {
            clearTimeout(autoZapTimeout);
            autoZapTimeout = setTimeout(() => {
                if(video.paused || video.readyState < 2) handleError();
            }, 15000);
        }
    }

    let autoZapTimeout;
    function handleError() {
        led.className = "";
        if(isAutoZap) { 
            statusText.innerText = "Zap Auto..."; 
            setTimeout(nextChannel, 1000); 
        } else { 
            statusText.innerText = "Erreur Flux"; 
        }
    }

    // --- CONTROLS ---
    function toggleMenu() { document.body.classList.toggle('menu-open'); }
    function nextChannel() { 
        let nextIdx = currentChannelIndex + 1;
        if(nextIdx >= allChannels.length) nextIdx = 0;
        tryPlayChannel(allChannels[nextIdx]);
    }
    function prevChannel() { 
        let prevIdx = currentChannelIndex - 1;
        if(prevIdx < 0) prevIdx = allChannels.length - 1;
        tryPlayChannel(allChannels[prevIdx]);
    }
    function adjustVol(d) { video.volume = Math.min(1, Math.max(0, video.volume + d)); }
    function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else if (document.exitFullscreen) document.exitFullscreen(); }

    function toggleAutoZap() {
        isAutoZap = !isAutoZap;
        const btn = document.getElementById('btn-autozap');
        if(isAutoZap) {
            btn.classList.add('active-mode');
            statusText.innerText = "Auto-Zap ON";
        } else {
            btn.classList.remove('active-mode');
            statusText.innerText = "Auto-Zap OFF";
            clearTimeout(autoZapTimeout);
        }
    }
    
    function hideCurrentChannel() {
        if(confirm("Supprimer cette chaÃ®ne ?")) {
            const ch = allChannels[currentChannelIndex];
            hiddenChannels.push(ch.url);
            localStorage.setItem('mybox_hidden', JSON.stringify(hiddenChannels));
            allChannels.splice(currentChannelIndex, 1);
            loadedUrls.delete(ch.url);
            renderList();
            nextChannel();
        }
    }

    // --- SETTINGS ---
    function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; updateCategoryChips(); }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display='none');
        document.querySelectorAll('.settings-tab').forEach(el => el.classList.remove('active'));
        document.getElementById(id).style.display = 'block';
    }
    function updateCategoryChips() {
        const container = document.getElementById('chips-area');
        if(selectedCategories.length === 0) selectedCategories = Array.from(allCategories);
        let cats = Array.from(allCategories).sort();
        let html = '';
        cats.forEach(cat => {
            const active = selectedCategories.includes(cat) ? 'selected' : '';
            html += `<div class="chip ${active}" onclick="toggleCat('${cat}')">${cat}</div>`;
        });
        container.innerHTML = html;
    }
    function toggleCat(cat) {
        if(selectedCategories.includes(cat)) selectedCategories = selectedCategories.filter(c => c !== cat);
        else selectedCategories.push(cat);
        updateCategoryChips();
    }
    function applyFilters() { localStorage.setItem('mybox_categories', JSON.stringify(selectedCategories)); renderList(); closeSettings(); }
    function restoreHidden() { localStorage.removeItem('mybox_hidden'); location.reload(); }
    function addSource() {
        const url = document.getElementById('custom-source').value.trim();
        if(url) {
            const current = JSON.parse(localStorage.getItem('mybox_custom_sources') || '[]');
            current.push(url);
            localStorage.setItem('mybox_custom_sources', JSON.stringify(current));
            alert("AjoutÃ© !"); location.reload();
        }
    }
    function resetSources() { localStorage.removeItem('mybox_custom_sources'); location.reload(); }

    function saveCache() { localStorage.setItem('mybox_cache_v35', JSON.stringify(allChannels.slice(0,1000))); }
    function loadCache() {
        const c = localStorage.getItem('mybox_cache_v35');
        if(c) { allChannels = JSON.parse(c); allChannels.forEach(ch=>loadedUrls.add(ch.url)); renderList(); }
    }
</script>
</body>
</html>
