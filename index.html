<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Box TV - DÃ©codeur V62 ULTIMATE</title>
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #e50914; --glass: rgba(15, 15, 15, 0.95); --text: #fff; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        /* SCROLLBAR GAMER POUR LE MENU */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #000; color: var(--text); height: 100vh; overflow: hidden; }

        #video-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: #000; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        #status-pill { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); padding: 8px 15px; border-radius: 20px; border: 1px solid #444; font-size: 12px; color: #fff; z-index: 60; display: flex; align-items: center; gap: 8px; pointer-events: none; }
        #led { width: 8px; height: 8px; background: red; border-radius: 50%; transition: 0.3s; }
        #led.green { background: #0f0; box-shadow: 0 0 5px #0f0; }
        #led.orange { background: orange; box-shadow: 0 0 5px orange; }

        #channel-menu { position: fixed; top: 0; left: 0; width: 350px; height: 100%; background: var(--glass); backdrop-filter: blur(15px); transform: translateX(-100%); transition: transform 0.3s; display: flex; flex-direction: column; z-index: 100; pointer-events: auto; border-right: 1px solid #333; }
        body.menu-open #channel-menu { transform: translateX(0); }

        .menu-header { padding: 15px; background: #111; border-bottom: 2px solid var(--primary); display: flex; flex-direction:column; align-items: center; gap:5px;}
        #searchInput { width: 95%; margin: 5px auto; padding: 10px; border-radius: 5px; background: #333; border: none; color: white; display: block; font-size: 14px; }
        
        .filter-bar { display: flex; gap: 5px; padding: 5px 10px; border-bottom: 1px solid #333; background: #1a1a1a; }
        .btn-mini { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #2a2a2a; color: #ccc; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-weight: 600; }
        .btn-mini.active { background: #333; color: white; border-color: #666; }
        .btn-local { background: linear-gradient(45deg, #e50914, #900); color: white; border: none; }

        #scan-info { width: 90%; display: none; flex-direction: column; gap: 5px; margin-bottom: 5px; }
        #scan-text { font-size: 10px; color: #0f0; font-family: monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #scan-progress { width: 100%; height: 2px; background: #333; position: relative; overflow: hidden; }
        #scan-bar { position: absolute; left: 0; top: 0; height: 100%; width: 50%; background: #0f0; animation: scanAnim 1s infinite linear; }
        @keyframes scanAnim { 0% {left: -50%;} 100% {left: 100%;} }

        /* --- MOTEUR VIRTUEL (TITAN) INTEGRATION --- */
        #channel-list-viewport { flex: 1; overflow-y: auto; position: relative; width:100%; will-change: transform; contain: strict; }
        #channel-list-content { position: relative; width: 100%; overflow: hidden; }
        
        .channel-row { 
            position: absolute; left: 0; width: 100%; height: 60px; /* HAUTEUR FIXE IMPORTANTE */
            display: flex; align-items: center; padding: 0 15px; 
            border-bottom: 1px solid #222; cursor: pointer; 
            background: transparent;
        }
        .channel-row:hover { background: #222; }
        .channel-row.active { background: rgba(229,9,20,0.2); border-left: 3px solid var(--primary); }
        .ch-logo { width: 35px; height: 35px; object-fit: contain; background: #fff; padding: 2px; border-radius: 3px; margin-right: 10px; }
        .fav-icon { color: #444; padding: 5px; margin-right: 10px; font-size: 12px; }
        .fav-icon.active { color: #ffd700; text-shadow: 0 0 5px gold; } 

        #bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); padding: 8px 15px; border-radius: 40px; border: 1px solid #333; display: flex; gap: 10px; align-items: center; z-index: 90; pointer-events: auto; width: auto; max-width: 98%; justify-content: space-between; flex-wrap: nowrap; overflow-x: auto; }
        .btn-ctrl { width: 45px; height: 45px; border-radius: 50%; background: #2a2a2a; color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; flex-shrink: 0; transition: 0.2s; }
        .btn-ctrl:active { background: var(--primary); transform: scale(0.95); }
        .btn-ctrl.active-mode { background: var(--primary); color: white; box-shadow: 0 0 10px var(--primary); animation: pulse 2s infinite; }
        .btn-large { width: 55px; height: 55px; font-size: 22px; background: var(--primary); border: 2px solid white; box-shadow: 0 0 10px rgba(229,9,20,0.5); }
        .desktop-only { display: flex; }
        @media (max-width: 600px) { .desktop-only { display: none; } #bottom-bar { gap: 5px; padding: 5px 10px; bottom: 10px; } .btn-ctrl { width: 40px; height: 40px; font-size: 16px; } .btn-large { width: 48px; height: 48px; font-size: 20px; } #channel-menu { width: 85%; } }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center; pointer-events: auto; }
        .modal-box { background: #1a1a1a; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #444; }
        .pin-input { font-size: 30px; letter-spacing: 10px; width: 150px; text-align: center; background: #333; color: white; border: none; padding: 10px; border-radius: 5px; margin: 20px 0; }

        .settings-panel { background: #1a1a1a; width: 90%; max-width: 800px; height: 80vh; border-radius: 15px; border: 1px solid #444; display: flex; overflow: hidden; }
        .settings-sidebar { width: 200px; background: #111; padding: 20px; border-right: 1px solid #333; }
        .settings-tab { padding: 15px; cursor: pointer; color: #888; font-weight: 600; border-radius: 8px; margin-bottom: 5px; }
        .settings-tab.active { background: #222; color: white; }
        .settings-content { flex: 1; padding: 20px; overflow-y: auto; }
        .chips-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .chip { padding: 8px 15px; background: #333; border-radius: 20px; font-size: 12px; cursor: pointer; border: 1px solid transparent; }
        .chip.selected { background: var(--primary); color: white; }
        @media (max-width: 700px) { .settings-panel { flex-direction: column; } .settings-sidebar { width: 100%; height: auto; display: flex; overflow-x: auto; } }

        .tp-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #333; margin-bottom: 5px; border-radius: 5px; }
    </style>
</head>
<body>

<div id="maint-screen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#111; z-index:9999; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
    <h1 style="color:#e50914;">MAINTENANCE</h1>
</div>

<div id="pin-modal" class="modal">
    <div class="modal-box">
        <h3 style="color:#e50914;"><i class="fas fa-lock"></i> SÃ‰CURITÃ‰</h3>
        <input type="password" id="pin-code" class="pin-input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢">
        <div style="display:flex; gap:10px; justify-content:center;">
            <button onclick="checkPin()" style="padding:10px 20px; background:#e50914; color:white; border:none; border-radius:5px;">OK</button>
            <button onclick="closePin()" style="padding:10px 20px; background:#444; color:white; border:none; border-radius:5px;">X</button>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal">
    <div class="settings-panel">
        <div class="settings-sidebar">
            <div style="font-weight:bold; margin-bottom:20px; color:var(--primary)">RÃ‰GLAGES</div>
            <div class="settings-tab active" onclick="showTab('tab-inst')">Scanner (Titan)</div>
            <div class="settings-tab" onclick="showTab('tab-cat')">Groupes</div>
            <div class="settings-tab" onclick="showTab('tab-sub')">Compte</div>
            <div class="settings-tab" onclick="forceReload()" style="color:#ff4444; margin-top:20px;">RÃ©initialiser</div>
            <div class="settings-tab" onclick="closeSettings()" style="color:#888; margin-top:10px;">Fermer âœ•</div>
        </div>
        <div class="settings-content">
            <div id="tab-inst" class="tab-content">
                <h3 style="color:#e50914;"><i class="fas fa-server"></i> IMPORTATION MASSIVE</h3>
                <p style="color:#aaa;">Utilisez le mode SCAN DOSSIER pour importer vos fichiers M3U locaux (Server 1000 Terra).</p>
                
                <label style="display:block; padding:15px; background:#333; margin-bottom:10px; border-radius:5px; cursor:pointer;">
                    <i class="fas fa-folder-open"></i> SCANNER DOSSIER COMPLET
                    <input type="file" webkitdirectory directory multiple style="display:none;" onchange="handleTitanScan(this)">
                </label>

                <div id="transponder-list">
                    <p>Sources Online (IPTV-ORG + Custom)</p>
                </div>
                <button onclick="scanSelectedTransponders()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:5px; font-weight:bold; margin-top:10px;">
                    <i class="fas fa-sync"></i> SCANNER SOURCES ONLINE
                </button>
            </div>

            <div id="tab-cat" class="tab-content" style="display:none;">
                <h3>Dossiers</h3>
                <button onclick="resetFilters()" style="width:100%; background:#444; padding:10px; margin-bottom:15px; border:none; color:white; border-radius:5px;">ðŸ”„ TOUT AFFICHER</button>
                <div id="chips-area" class="chips-container"></div>
                <button onclick="applyFilters()" style="margin-top:20px; width:100%; background:var(--primary); border:none; color:white; padding:10px; border-radius:5px;">Valider</button>
            </div>

            <div id="tab-sub" class="tab-content" style="display:none;">
                <h3>Abonnement</h3>
                <div style="background:#222; padding:20px; border-radius:10px; margin-bottom:20px;">
                    ID: <span id="sub-id">...</span><br>
                    Infos: <span id="sub-details">...</span>
                </div>
                <button onclick="logout()" style="width:100%; background:#ff4444; color:white; border:none; padding:15px; border-radius:8px; font-weight:bold;">DÃ‰CONNECTER</button>
            </div>
        </div>
    </div>
</div>

<div id="login-screen" class="modal" style="display:flex;">
    <div class="modal-box">
        <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" class="app-logo" style="max-width:150px; margin-bottom:20px;">
        <input type="text" id="licenseKey" placeholder="ID ABONNEMENT" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:5px; text-align:center; font-size:18px; margin-bottom:15px;">
        <button onclick="login()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:5px; font-weight:bold;">ENTRER</button>
    </div>
</div>

<div id="video-layer"><video id="video" onclick="toggleMenu()" playsinline crossorigin="anonymous"></video></div>

<div id="ui-layer">
    <div id="status-pill"><div id="led"></div><span id="status-text">PrÃªt</span></div>
    
    <div id="channel-menu">
        <div class="menu-header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" style="width:100px;">
            <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
                <div style="text-align:left; width:100%;">
                    <span style="font-size:14px; font-weight:bold;">CHAÃŽNES (TITAN)</span>
                    <div style="font-size:10px; color:#888;" id="count-display">0 trouvÃ©es</div>
                    <div id="scan-info">
                        <div id="scan-text">En attente...</div>
                        <div id="scan-progress"><div id="scan-bar"></div></div>
                    </div>
                </div>
                <i class="fas fa-cog" onclick="openSettings()" style="cursor:pointer; color:#fff; font-size:20px;"></i>
            </div>
        </div>
        
        <input type="text" id="searchInput" placeholder="ðŸ” Rechercher...">
        
        <div class="filter-bar">
            <button onclick="toggleOnlyFavorites()" class="btn-mini" id="btn-fav-filter">
                <i class="fas fa-star" style="color:gold;"></i> Favoris
            </button>
            <button onclick="window.location.reload()" class="btn-mini btn-local">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>

        <div id="channel-list-viewport">
            <div id="channel-list-content"></div>
        </div>
    </div>

    <div id="bottom-bar">
        <button class="btn-ctrl" onclick="prevChannel()"><i class="fas fa-step-backward"></i></button>
        <button class="btn-ctrl desktop-only" onclick="adjustVol(-0.1)"><i class="fas fa-minus"></i></button>
        <button class="btn-ctrl btn-large" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
        <button class="btn-ctrl desktop-only" onclick="adjustVol(0.1)"><i class="fas fa-plus"></i></button>
        <button class="btn-ctrl" onclick="nextChannel()"><i class="fas fa-step-forward"></i></button>
        <button class="btn-ctrl" id="btn-autozap" onclick="toggleAutoZap()"><i class="fas fa-bolt"></i></button>
        <button class="btn-ctrl" onclick="hideCurrentChannel()" style="color:#ff4444;"><i class="fas fa-trash"></i></button>
        <button class="btn-ctrl" onclick="toggleFullScreen()"><i class="fas fa-expand"></i></button>
    </div>
</div>

<script>
    // =======================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbwg49-A8a5q72hnhcf99865CBqAErbxAMUX4TDDsR47anl4ELo6iZhDzS2hH4yMMJ1CcQ/exec";
    const CORS_PROXY = "https://corsproxy.io/?"; // LE SECRET POUR LIRE LES FLUX
    // =======================================================

    const DEFAULT_CHANNEL = { name: "Novelas TV", url: "https://stormcast-telenovelatv-1-fr.samsung.wurl.tv/playlist.m3u8", logo: "", category: "Start" };
    const PIN_CODE = "0000"; 
    const ROW_HEIGHT = 60; // Hauteur d'une ligne pour le scroll virtuel

    let allChannels = [], filteredChannels = [];
    let favorites = JSON.parse(localStorage.getItem('mybox_favs') || '[]');
    let currentChannelIndex = 0;
    let deviceId = localStorage.getItem('mybox_device_id') || 'DEV-'+Math.random().toString(36).substr(2,9).toUpperCase();
    localStorage.setItem('mybox_device_id', deviceId);
    let isFavFilter = false, hls = null, pendingChannelIndex = -1, isAutoZap = false;
    let allCategories = new Set(['Favoris']), selectedCategories = JSON.parse(localStorage.getItem('mybox_categories') || '[]');
    let hiddenChannels = JSON.parse(localStorage.getItem('mybox_hidden') || '[]');
    let availableTransponders = []; 
    let isScanning = false;

    // --- DOM REF POUR VIRTUAL SCROLL ---
    const viewport = document.getElementById('channel-list-viewport');
    const content = document.getElementById('channel-list-content');
    const video = document.getElementById('video');
    const statusText = document.getElementById('status-text');
    const led = document.getElementById('led');

    // --- INITIALISATION ---
    if(localStorage.getItem('mybox_auth') === 'OK') { 
        document.getElementById('login-screen').style.display = 'none'; 
        updateAccountDisplay(localStorage.getItem('mybox_key'), localStorage.getItem('mybox_raw_status')); 
        initApp();
        startRealTimeCheck();
    }

    // --- MOTEUR TITAN : VIRTUAL SCROLL (RENDU INFINI) ---
    // C'est ce bloc qui permet d'afficher 100 000 chaÃ®nes sans lagger
    viewport.addEventListener('scroll', requestRender);
    window.addEventListener('resize', requestRender);

    function requestRender() { window.requestAnimationFrame(renderList); }

    function renderList() {
        // 1. Filtrage (Si le texte de recherche change, on refiltre)
        const term = document.getElementById('searchInput').value.toLowerCase();
        
        // Optimisation : On ne refiltre que si nÃ©cessaire (ici simplifiÃ©, on refiltre Ã  chaque render pour la fluiditÃ©)
        filteredChannels = allChannels.filter(ch => {
            let catOK = true;
            if(selectedCategories.length > 0 && !selectedCategories.includes(ch.category || "Autres")) catOK = false;
            return catOK && ch.name.toLowerCase().includes(term) && (isFavFilter ? favorites.includes(ch.url) : true);
        });

        // Mise Ã  jour compteur
        document.getElementById('count-display').innerText = filteredChannels.length + " ChaÃ®nes";

        // 2. Calcul du Rendu Virtuel
        const scrollTop = viewport.scrollTop;
        const viewportHeight = viewport.clientHeight;
        const startIndex = Math.floor(scrollTop / ROW_HEIGHT);
        const endIndex = Math.min(filteredChannels.length, Math.floor((scrollTop + viewportHeight) / ROW_HEIGHT) + 5);

        // Ajuster hauteur totale pour la scrollbar
        content.style.height = `${filteredChannels.length * ROW_HEIGHT}px`;

        // 3. GÃ©nÃ©ration HTML (Uniquement les Ã©lÃ©ments visibles)
        let html = '';
        for(let i = startIndex; i < endIndex; i++) {
            const ch = filteredChannels[i];
            if(!ch) continue;

            const isFav = favorites.includes(ch.url);
            const isPlaying = (ch.url === allChannels[currentChannelIndex]?.url);
            const logoSrc = ch.logo || 'https://via.placeholder.com/40?text=TV';
            const rowClass = isPlaying ? 'channel-row active' : 'channel-row';
            const favClass = isFav ? 'active' : '';

            // Note: position absolute pour placer l'Ã©lÃ©ment au bon endroit
            html += `
                <div class="${rowClass}" style="transform: translateY(${i * ROW_HEIGHT}px)" onclick="tryPlayChannel(this.dataset.idx)" data-idx="${allChannels.indexOf(ch)}">
                    <i class="fas fa-star fav-icon ${favClass}" onclick="toggleFavorite('${ch.url}', event)"></i>
                    <img src="${logoSrc}" class="ch-logo" onerror="this.src='https://via.placeholder.com/40?text=TV'">
                    <div>
                        <div style="font-weight:600; font-size:14px;">${ch.name}</div>
                        <div style="font-size:10px; color:#888;">${ch.category}</div>
                    </div>
                </div>
            `;
        }
        content.innerHTML = html;
    }

    // --- SCANNER TITAN (FICHIERS LOCAUX MASSIFS) ---
    async function handleTitanScan(input) {
        const files = input.files;
        if(!files.length) return;
        document.getElementById('scan-info').style.display = 'flex';
        document.getElementById('scan-text').innerText = "Initialisation Titan Scan...";
        
        const regex = /(https?:\/\/[^\s"';,<>]+)/gi;
        
        for(let i=0; i<files.length; i++) {
            const file = files[i];
            if(i % 5 === 0) {
                document.getElementById('scan-text').innerText = `Scan: ${file.name} (${i}/${files.length})`;
                await new Promise(r => setTimeout(r, 0)); // Anti-freeze
            }

            if(file.size < 50000000 && (file.name.includes('.') || file.type.includes('text'))) {
                try {
                    let text = await readFile(file);
                    let matches = text.match(regex);
                    if(matches) {
                        let batch = [];
                        matches.forEach(url => {
                            if(url.length > 10 && !url.includes('w3.org')) {
                                let name = url.split('/').pop().split('?')[0];
                                batch.push({ name: name, url: url, category: file.name, logo: "" });
                            }
                        });
                        // Ajout direct sans tout redessiner
                        if(batch.length > 0) {
                            allChannels = allChannels.concat(batch);
                            renderList(); // Mise Ã  jour temps rÃ©el
                        }
                    }
                } catch(e){}
            }
        }
        document.getElementById('scan-info').style.display = 'none';
        alert("Scan Titan terminÃ© ! " + allChannels.length + " chaÃ®nes disponibles.");
    }

    function readFile(file) {
        return new Promise(r => { let fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsText(file); });
    }

    // --- PLAYER AVEC PROXY FALLBACK (CORRECTION ERREUR FLUX) ---
    function playChannel(index) {
        if(!allChannels[index]) return;
        const ch = allChannels[index];
        currentChannelIndex = index;
        
        renderList(); // Update active class
        statusText.innerText = ch.name; 
        led.className = "orange";
        
        if(window.innerWidth < 900) document.body.classList.remove('menu-open');

        if(Hls.isSupported()) {
            if(hls) hls.destroy();
            hls = new Hls();
            
            // Tentative 1 : Direct
            hls.loadSource(ch.url);
            hls.attachMedia(video);
            
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                video.play().catch(()=>{});
                led.className = "green";
            });

            // GESTION ERREUR -> ACTIVATION PROXY
            hls.on(Hls.Events.ERROR, (e, data) => {
                if(data.fatal) {
                    console.log("Erreur flux direct, tentative via Proxy...");
                    statusText.innerText = "DÃ©blocage Proxy...";
                    // Tentative 2 : Via Proxy
                    hls.loadSource(CORS_PROXY + encodeURIComponent(ch.url));
                    hls.startLoad();
                }
            });

        } else if(video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = ch.url; video.play();
        }
    }

    // --- FONCTIONS STANDARD (AUTH, PIN, ETC) ---
    function startRealTimeCheck() {
        setInterval(async () => {
            const key = localStorage.getItem('mybox_key');
            if(!key) return;
            try {
                const res = await fetch(`${API_URL}?action=login&key=${encodeURIComponent(key)}&device=${encodeURIComponent(deviceId)}`);
                const text = await res.text();
                if(!text.includes("SUCCESS")) { localStorage.removeItem('mybox_auth'); location.reload(); }
            } catch(e) {}
        }, 10000);
    }

    async function login() {
        const key = document.getElementById('licenseKey').value.trim();
        try {
            const res = await fetch(`${API_URL}?action=login&key=${encodeURIComponent(key)}&device=${encodeURIComponent(deviceId)}`);
            const text = await res.text();
            if(text.includes("SUCCESS")) { 
                localStorage.setItem('mybox_auth', 'OK'); 
                localStorage.setItem('mybox_key', key); 
                localStorage.setItem('mybox_raw_status', text); 
                updateAccountDisplay(key, text); 
                document.getElementById('login-screen').style.display = 'none'; 
                initApp();
                startRealTimeCheck();
            } else alert("Erreur ID");
        } catch(e) { alert("Erreur RÃ©seau"); }
    }

    function updateAccountDisplay(key, raw) { document.getElementById('sub-id').innerText = key; if(raw && raw.split(':').length >= 3) document.getElementById('sub-details').innerText = "Expire: " + raw.split(':')[1] + "j"; }
    async function logout() { if(confirm("DÃ©connecter ?")) { try{ await fetch(`${API_URL}?action=logout&key=${localStorage.getItem('mybox_key')}&device=${deviceId}`); }catch(e){} localStorage.removeItem('mybox_auth'); location.reload(); } }

    async function initApp() {
        allChannels = [DEFAULT_CHANNEL];
        renderList();
        
        // Charger les transpondeurs
        try {
            const res = await fetch(`${API_URL}?action=get_playlists`);
            availableTransponders = await res.json();
            renderTranspondersUI();
        } catch(e){}
    }

    function renderTranspondersUI() {
        const container = document.getElementById('transponder-list');
        container.innerHTML = "";
        availableTransponders.forEach((tp, idx) => {
            const div = document.createElement('div');
            div.className = "tp-item";
            div.innerHTML = `<span class="tp-name">${tp.name}</span><input type="checkbox" class="tp-checkbox" value="${tp.url}" checked>`;
            container.appendChild(div);
        });
    }

    async function scanSelectedTransponders() {
        const checkboxes = document.querySelectorAll('.tp-checkbox:checked');
        document.getElementById('settings-modal').style.display = 'none';
        document.getElementById('scan-info').style.display = 'flex';
        
        for(let i=0; i<checkboxes.length; i++) {
            document.getElementById('scan-text').innerText = "Scan Web: " + checkboxes[i].value;
            await fetchPlaylist(checkboxes[i].value);
        }
        document.getElementById('scan-info').style.display = 'none';
        alert("TerminÃ© !");
    }

    async function fetchPlaylist(url) {
        try {
            // Tente via proxy directement pour Ã©viter les erreurs CORS classiques
            const res = await fetch(CORS_PROXY + encodeURIComponent(url));
            const text = await res.text();
            const lines = text.split('\n');
            let batch = [];
            let name = "Inconnu";
            lines.forEach(line => {
                line = line.trim();
                if(line.startsWith('#EXTINF')) {
                    name = line.split(',')[1] || "Sans Nom";
                } else if(line.startsWith('http')) {
                    if(line.includes('.m3u8') || line.includes('.ts') || line.includes('.mkv')) {
                        batch.push({name: name, url: line, category: "Web Scan", logo: ""});
                    }
                    name = "Inconnu";
                }
            });
            if(batch.length > 0) {
                allChannels = allChannels.concat(batch);
                renderList();
            }
        } catch(e) {}
    }

    // --- ACTIONS UI ---
    document.getElementById('searchInput').addEventListener('input', renderList);
    function toggleCat(cat) { if(selectedCategories.includes(cat)) selectedCategories = selectedCategories.filter(c => c !== cat); else selectedCategories.push(cat); updateCategoryChips(); renderList(); }
    function resetFilters() { selectedCategories = []; updateCategoryChips(); renderList(); }
    function applyFilters() { localStorage.setItem('mybox_categories', JSON.stringify(selectedCategories)); renderList(); closeSettings(); }
    function toggleFavorite(url, e) { e.stopPropagation(); if(favorites.includes(url)) favorites = favorites.filter(u => u !== url); else favorites.push(url); localStorage.setItem('mybox_favs', JSON.stringify(favorites)); renderList(); }
    function toggleOnlyFavorites() { isFavFilter = !isFavFilter; document.getElementById('btn-fav-filter').style.background = isFavFilter ? '#e50914' : '#2a2a2a'; renderList(); }

    function tryPlayChannel(idx) {
        const index = parseInt(idx);
        const ch = allChannels[index];
        const name = ch.name.toLowerCase();
        if(name.includes('adult') || name.includes('xxx') || name.includes('porn')) { pendingChannelIndex = index; document.getElementById('pin-modal').style.display = 'flex'; }
        else { playChannel(index); }
    }
    function checkPin() { if(document.getElementById('pin-code').value === PIN_CODE) { closePin(); playChannel(pendingChannelIndex); } else alert("Code ErronÃ©"); }
    function closePin() { document.getElementById('pin-modal').style.display = 'none'; }

    function toggleMenu() { document.body.classList.toggle('menu-open'); }
    function nextChannel() { let nextIdx = currentChannelIndex + 1; if(nextIdx >= allChannels.length) nextIdx = 0; tryPlayChannel(nextIdx); }
    function prevChannel() { let prevIdx = currentChannelIndex - 1; if(prevIdx < 0) prevIdx = allChannels.length - 1; tryPlayChannel(prevIdx); }
    function adjustVol(d) { video.volume = Math.min(1, Math.max(0, video.volume + d)); }
    function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else if (document.exitFullscreen) document.exitFullscreen(); }
    function toggleAutoZap() { isAutoZap = !isAutoZap; const btn = document.getElementById('btn-autozap'); if(isAutoZap) { btn.classList.add('active-mode'); statusText.innerText = "Auto-Zap ON"; } else { btn.classList.remove('active-mode'); statusText.innerText = "Auto-Zap OFF"; } }
    function hideCurrentChannel() { if(confirm("Supprimer cette chaÃ®ne ?")) { const ch = allChannels[currentChannelIndex]; hiddenChannels.push(ch.url); localStorage.setItem('mybox_hidden', JSON.stringify(hiddenChannels)); allChannels.splice(currentChannelIndex, 1); renderList(); nextChannel(); } }
    function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; updateCategoryChips(); }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function showTab(id) { document.querySelectorAll('.tab-content').forEach(el => el.style.display='none'); document.querySelectorAll('.settings-tab').forEach(el => el.classList.remove('active')); document.getElementById(id).style.display = 'block'; }
    function updateCategoryChips() { 
        allCategories = new Set(allChannels.map(c => c.category || "Autres"));
        const container = document.getElementById('chips-area');
        let html = '';
        Array.from(allCategories).sort().forEach(cat => {
            const active = selectedCategories.includes(cat) ? 'selected' : '';
            html += `<div class="chip ${active}" onclick="toggleCat('${cat}')">${cat}</div>`;
        });
        container.innerHTML = html;
    }
    function copyLink() { if(allChannels[currentChannelIndex]) { navigator.clipboard.writeText(allChannels[currentChannelIndex].url); alert("CopiÃ©"); } }
    function forceReload() { if(confirm("Reset ?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
