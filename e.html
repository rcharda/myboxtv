<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">

    <title>My Box TV - 50k Edition</title>
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #e50914; --glass: rgba(15, 15, 15, 0.98); --text: #fff; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #000; color: var(--text); height: 100vh; overflow: hidden; }

        #video-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: #000; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        #status-pill { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); padding: 8px 15px; border-radius: 20px; border: 1px solid #444; font-size: 12px; color: #fff; z-index: 60; display: flex; align-items: center; gap: 10px; pointer-events: none; }
        #led { width: 8px; height: 8px; background: red; border-radius: 50%; transition: 0.3s; box-shadow: 0 0 5px red; }
        #led.green { background: #0f0; box-shadow: 0 0 5px #0f0; }

        #channel-menu { position: fixed; top: 0; left: 0; width: 350px; height: 100%; background: var(--glass); backdrop-filter: blur(15px); transform: translateX(-100%); transition: transform 0.3s; display: flex; flex-direction: column; z-index: 100; pointer-events: auto; border-right: 1px solid #333; }
        body.menu-open #channel-menu { transform: translateX(0); }

        .menu-header { padding: 15px; background: #111; border-bottom: 2px solid var(--primary); display: flex; flex-direction:column; align-items: center; gap:5px;}
        #searchInput { width: 95%; margin: 5px auto; padding: 10px; border-radius: 5px; background: #333; border: none; color: white; display: block; font-size: 14px; }
        
        .filter-bar { display: flex; gap: 10px; padding: 10px; border-bottom: 1px solid #333; background: #1a1a1a; align-items: center; justify-content: space-between; }
        
        /* CHECKBOX VIP */
        .vip-toggle { display: flex; align-items: center; gap: 5px; background: #222; padding: 5px 10px; border-radius: 15px; border: 1px solid #444; cursor: pointer; }
        .vip-toggle input { accent-color: gold; }
        .vip-toggle span { font-size: 11px; font-weight: bold; color: gold; }

        #channel-list { flex: 1; overflow-y: auto; padding: 0; width:100%; }
        
        /* STYLE LISTE */
        .channel-row { display: flex; align-items: center; padding: 10px 15px; margin: 0; border-bottom: 1px solid #222; cursor: pointer; contain: content; }
        .channel-row:hover { background: #222; }
        .channel-row.active { background: rgba(229,9,20,0.2); border-left: 3px solid var(--primary); }
        .ch-logo { width: 35px; height: 35px; object-fit: contain; background: #fff; padding: 2px; border-radius: 3px; margin-right: 10px; }

        /* PAGINATION BARRE */
        .pagination-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #111; border-top: 1px solid #333; }
        .page-btn { background: #333; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .page-btn:disabled { opacity: 0.5; cursor: default; }
        .page-info { font-size: 10px; color: #888; }

        #bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); padding: 8px 15px; border-radius: 40px; border: 1px solid #333; display: flex; gap: 10px; align-items: center; z-index: 90; pointer-events: auto; width: auto; max-width: 98%; justify-content: space-between; flex-wrap: nowrap; overflow-x: auto; }
        .btn-ctrl { width: 45px; height: 45px; border-radius: 50%; background: #2a2a2a; color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; flex-shrink: 0; transition: 0.2s; }
        .btn-ctrl:active { background: var(--primary); transform: scale(0.95); }
        .desktop-only { display: flex; }
        @media (max-width: 600px) { .desktop-only { display: none; } #bottom-bar { gap: 5px; padding: 5px 10px; bottom: 10px; } #channel-menu { width: 85%; } }

        /* SCANNING LOADER */
        #bg-scan-indicator { position: absolute; top: 10px; right: 10px; font-size: 10px; color: #0f0; display: none; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div id="video-layer"><video id="video" onclick="toggleMenu()" playsinline crossorigin="anonymous"></video></div>

<div id="ui-layer">
    <div id="status-pill">
        <div id="led"></div>
        <span id="status-text">Pr√™t</span>
    </div>
    
    <div id="channel-menu">
        <div class="menu-header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" style="width:100px;">
            <div id="bg-scan-indicator">üîç Analyse Premium...</div>
            <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                <span style="font-size:12px; font-weight:bold;">LISTE CHA√éNES</span>
                <span id="total-count" style="font-size:10px; color:#888;">0 trouv√©es</span>
            </div>
        </div>
        
        <input type="text" id="searchInput" placeholder="üîç Rechercher..." oninput="resetPaginationAndFilter()">
        
        <div class="filter-bar">
            <label class="vip-toggle">
                <input type="checkbox" id="chk-vip" checked onchange="resetPaginationAndFilter()">
                <span>‚òÖ VIP / DIRECT</span>
            </label>
        </div>

        <div id="channel-list"></div>

        <div class="pagination-bar">
            <button class="page-btn" onclick="changePage(-1)">‚ùÆ Pr√©c.</button>
            <span class="page-info" id="page-indicator">Page 1</span>
            <button class="page-btn" onclick="changePage(1)">Suiv. ‚ùØ</button>
        </div>
    </div>

    <div id="bottom-bar">
        <button class="btn-ctrl" onclick="prevChannel()"><i class="fas fa-step-backward"></i></button>
        <button class="btn-ctrl desktop-only" onclick="adjustVol(-0.1)"><i class="fas fa-minus"></i></button>
        <button class="btn-ctrl btn-large" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
        <button class="btn-ctrl desktop-only" onclick="adjustVol(0.1)"><i class="fas fa-plus"></i></button>
        <button class="btn-ctrl" onclick="nextChannel()"><i class="fas fa-step-forward"></i></button>
        <button class="btn-ctrl" onclick="toggleFullScreen()"><i class="fas fa-expand"></i></button>
    </div>
</div>

<script>
    // =======================================================
    // CONFIGURATION URL
    // =======================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbyTVVHd3DGbEtlRfVN5aboerVM1UEbDYTGv4vJxabValUYDAHRxgLoFppjUO8xwv9SsTw/exec";
    
    // CHAINE PAR DEFAUT : NOVELAS TV
    const DEFAULT_CHANNEL = { 
        name: "Novelas TV", 
        url: "https://stormcast-telenovelatv-1-fr.samsung.wurl.tv/playlist.m3u8", 
        logo: "https://upload.wikimedia.org/wikipedia/commons/2/29/Novelas_TV_Logo.png", 
        category: "Start",
        isVip: true 
    };

    // --- VARIABLES ---
    let allChannels = [DEFAULT_CHANNEL]; // Contient TOUTES les chaines (50k+)
    let filteredChannels = []; // Contient les chaines apr√®s recherche/filtre
    let loadedUrls = new Set([DEFAULT_CHANNEL.url]);
    
    // Pagination
    let currentPage = 1;
    const itemsPerPage = 50; // Nombre de chaines affich√©es √† la fois
    
    let currentChannelIndex = 0;
    let hls = null;
    const video = document.getElementById('video');
    const statusText = document.getElementById('status-text');
    const led = document.getElementById('led');

    // --- DEMARRAGE ---
    window.onload = function() {
        playChannel(0); // Lancer Novelas direct
        renderList();   // Afficher la liste
        fetchData();    // Aller chercher les donn√©es Excel et M3U
    };

    // --- RECUPERATION DONNEES (M3U + PREMIUM EXCEL) ---
    async function fetchData() {
        try {
            // On demande √† l'API Google Script de nous donner les playlists
            // Le script doit renvoyer un JSON combin√© ou tu peux faire 2 appels
            // Ici je simule la r√©cup√©ration intelligente
            
            // 1. D'abord on charge les Transpondeurs (M3U standard)
            // (Simulation d'appel API pour la d√©mo, adapter selon ton script r√©el)
            const res = await fetch(`${API_URL}?action=get_playlists`); // Ton endpoint
            const data = await res.json();
            
            // Supposons que 'data' contienne une liste brute ou des URLs de M3U
            // Pour l'exemple Premium, on va simuler l'extraction des Colonnes D et E
            
            // --- ANALYSE PREMIUM EN ARRIERE PLAN ---
            document.getElementById('bg-scan-indicator').style.display = 'block';
            
            // Imagine que 'data.premium' contient les lignes de ton Excel (Col D=url, E=Nom)
            if(data) {
                // On traite les donn√©es re√ßues
                // Si c'est des URLs M3U classiques
                if(Array.isArray(data)) {
                     data.forEach(src => fetchPlaylistAndParse(src.url, false));
                }
                
                // Si tu as une structure sp√©cifique pour le Premium dans ton JSON
                // Example: data.excelRows = [{link: '...', name: '...', status: 'OK'}]
                if(data.excelRows) {
                    checkAndAddPremium(data.excelRows);
                }
            }

        } catch(e) {
            console.log("Erreur chargement donn√©es", e);
        }
    }

    // --- FONCTION INTELLIGENTE : VERIFIE SI CA MARCHE AVANT D'AJOUTER ---
    async function checkAndAddPremium(rows) {
        // rows est un tableau d'objets {url: '...', name: '...'} venant de l'Excel
        
        // On traite un par un ou par petits paquets pour ne pas tuer le navigateur
        for (let row of rows) {
            if (!row.url) continue;

            // Test de connexion (HEAD request)
            try {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 5000); // 5 sec max pour r√©pondre
                
                const response = await fetch(row.url, { method: 'HEAD', signal: controller.signal });
                clearTimeout(id);

                if (response.ok) {
                    // C'EST BON ! ON AJOUTE
                    const newCh = {
                        name: row.name || "Cha√Æne Premium",
                        url: row.url,
                        logo: "https://via.placeholder.com/40?text=VIP",
                        category: "Premium",
                        isVip: true // Marqueur pour le filtre
                    };
                    
                    if(!loadedUrls.has(newCh.url)) {
                        allChannels.push(newCh);
                        loadedUrls.add(newCh.url);
                        // On rafraichit la liste seulement si on est sur la page concern√©e pour pas faire laguer
                        if(currentPage === Math.ceil(allChannels.length / itemsPerPage)) renderList();
                        
                        // Mise √† jour compteur total
                        document.getElementById('total-count').innerText = allChannels.length + " trouv√©es";
                    }
                }
            } catch (e) {
                // Echec silencieux, on n'ajoute pas la cha√Æne morte
            }
            
            // Petite pause pour laisser respirer le CPU
            await new Promise(r => setTimeout(r, 100)); 
        }
        document.getElementById('bg-scan-indicator').style.display = 'none';
    }

    // --- PARSEUR M3U CLASSIQUE (Pour le mode Transpondeur) ---
    async function fetchPlaylistAndParse(url, isVip) {
        try {
            const res = await fetch("https://corsproxy.io/?" + encodeURIComponent(url));
            const text = await res.text();
            const lines = text.split('\n');
            let info = null;
            
            for(let line of lines) {
                line = line.trim();
                if(line.startsWith('#EXTINF')) {
                    let name = line.split(',')[1];
                    let logo = (line.match(/tvg-logo=["']?([^"']*)["']?/) || [])[1];
                    info = { name: name, logo: logo, isVip: isVip };
                } else if(line.startsWith('http')) {
                    if(info && !loadedUrls.has(line)) {
                        allChannels.push({...info, url: line});
                        loadedUrls.add(line);
                        info = null;
                    }
                }
            }
            resetPaginationAndFilter();
        } catch(e) {}
    }

    // --- GESTION DE LA PAGINATION & FILTRES ---
    function resetPaginationAndFilter() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const vipOnly = document.getElementById('chk-vip').checked;

        // 1. Filtrer
        filteredChannels = allChannels.filter(ch => {
            // Recherche texte
            if (term && !ch.name.toLowerCase().includes(term)) return false;
            // Filtre VIP (Si coch√©, on montre tout, si d√©coch√©, on cache les VIP ? 
            // Ou l'inverse: "Cocher pour voir les VIP dans la liste")
            // Le user a dit: "cocher pour activ√© ou d√©sactiv√© c'est type de chaine directe"
            if (!vipOnly && ch.isVip && ch !== DEFAULT_CHANNEL) return false;
            
            return true;
        });

        document.getElementById('total-count').innerText = filteredChannels.length + " trouv√©es";
        
        // 2. Reset Page
        currentPage = 1;
        renderList();
    }

    function changePage(direction) {
        const totalPages = Math.ceil(filteredChannels.length / itemsPerPage);
        currentPage += direction;
        
        if(currentPage < 1) currentPage = 1;
        if(currentPage > totalPages) currentPage = totalPages;
        
        renderList();
    }

    function renderList() {
        const list = document.getElementById('channel-list');
        list.innerHTML = "";
        
        // Calcul des indices pour la pagination
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = filteredChannels.slice(start, end);
        
        const frag = document.createDocumentFragment();
        
        pageItems.forEach((ch) => {
            const isPlaying = (ch.url === allChannels[currentChannelIndex]?.url);
            const div = document.createElement('div');
            div.className = 'channel-row ' + (isPlaying ? 'active' : '');
            
            // Logo ou Placeholder
            let imgHtml = ch.logo ? `<img src="${ch.logo}" class="ch-logo">` : `<i class="fas fa-tv" style="margin-right:10px;"></i>`;
            
            // Badge VIP
            let vipBadge = ch.isVip ? `<i class="fas fa-star" style="color:gold; margin-left:5px; font-size:10px;"></i>` : ``;

            div.innerHTML = `
                ${imgHtml}
                <div style="flex:1; font-weight:600; font-size:13px;">
                    ${ch.name} ${vipBadge}
                </div>
            `;
            
            // Clic intelligent : Retrouver l'index r√©el dans le grand tableau allChannels
            div.onclick = () => {
                const realIndex = allChannels.indexOf(ch);
                playChannel(realIndex);
            };
            
            frag.appendChild(div);
        });
        
        list.appendChild(frag);
        
        // Mise √† jour info page
        const totalPages = Math.ceil(filteredChannels.length / itemsPerPage);
        document.getElementById('page-indicator').innerText = `Page ${currentPage} / ${totalPages || 1}`;
    }

    // --- LECTEUR VIDEO ---
    function playChannel(index) {
        if(index < 0 || index >= allChannels.length) return;
        currentChannelIndex = index;
        const ch = allChannels[index];
        
        // Mise √† jour UI
        statusText.innerText = ch.name;
        renderList(); // Pour mettre √† jour la surbrillance active
        if(window.innerWidth < 900) document.body.classList.remove('menu-open');

        if(Hls.isSupported()) {
            if(hls) hls.destroy();
            hls = new Hls();
            hls.loadSource(ch.url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                video.play();
                led.className = "green";
            });
            hls.on(Hls.Events.ERROR, () => {
                led.className = ""; // Rouge si erreur
                statusText.innerText = "Erreur Flux";
            });
        } else if(video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = ch.url;
            video.play();
        }
    }
    
    // Commandes
    function toggleMenu() { document.body.classList.toggle('menu-open'); }
    function nextChannel() { playChannel(currentChannelIndex + 1); }
    function prevChannel() { playChannel(currentChannelIndex - 1); }
    function adjustVol(v) { video.volume = Math.min(1, Math.max(0, video.volume + v)); }
    function toggleFullScreen() {
        if(!document.fullscreenElement) document.documentElement.requestFullscreen();
        else if(document.exitFullscreen) document.exitFullscreen();
    }

    // --- EXEMPLE DE DONNEES POUR TESTER LE CHECKER (A supprimer si tu utilises ton Excel) ---
    // Simule ce que ton Excel enverrait
    /*
    setTimeout(() => {
        checkAndAddPremium([
            { name: "Test VIP 1 (Valid)", url: "https://stormcast-telenovelatv-1-fr.samsung.wurl.tv/playlist.m3u8" },
            { name: "Test VIP 2 (Mort)", url: "http://fake.url/stream.m3u8" }
        ]);
    }, 2000);
    */

</script>
</body>
</html>
