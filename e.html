<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <title>My Box TV - Cerveau Edition</title>
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #e50914; --glass: rgba(20, 20, 20, 0.98); --text: #fff; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #000; color: var(--text); height: 100vh; overflow: hidden; }

        #video-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: #000; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        /* STATUS BARRE AVEC SIGNAL */
        #status-pill { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); padding: 8px 15px; border-radius: 20px; border: 1px solid #444; font-size: 12px; color: #fff; z-index: 60; display: flex; align-items: center; gap: 10px; pointer-events: none; }
        #led { width: 8px; height: 8px; background: red; border-radius: 50%; transition: 0.3s; box-shadow: 0 0 5px red; }
        #led.green { background: #0f0; box-shadow: 0 0 5px #0f0; }
        #led.orange { background: orange; box-shadow: 0 0 5px orange; }

        /* SIGNAL BARRES */
        .signal-container { display: flex; align-items: flex-end; gap: 3px; height: 14px; }
        .sig-bar { width: 4px; background: #444; border-radius: 1px; transition: background 0.3s; }
        .sig-bar.b1 { height: 25%; } .sig-bar.b2 { height: 50%; } .sig-bar.b3 { height: 75%; } .sig-bar.b4 { height: 100%; }
        .sig-lvl-1 .b1 { background: #ff4444; } 
        .sig-lvl-2 .b1, .sig-lvl-2 .b2 { background: #ffd700; } 
        .sig-lvl-3 .b1, .sig-lvl-3 .b2, .sig-lvl-3 .b3 { background: #ff8c00; } 
        .sig-lvl-4 .sig-bar { background: #00ff00; } 

        #channel-menu { position: fixed; top: 0; left: 0; width: 350px; height: 100%; background: var(--glass); backdrop-filter: blur(15px); transform: translateX(-100%); transition: transform 0.3s; display: flex; flex-direction: column; z-index: 100; pointer-events: auto; border-right: 1px solid #333; }
        body.menu-open #channel-menu { transform: translateX(0); }

        .menu-header { padding: 15px; background: #111; border-bottom: 2px solid var(--primary); display: flex; flex-direction:column; align-items: center; gap:5px;}
        #searchInput { width: 95%; margin: 5px auto; padding: 10px; border-radius: 5px; background: #333; border: none; color: white; display: block; font-size: 14px; }
        
        .filter-bar { display: flex; gap: 5px; padding: 5px 10px; border-bottom: 1px solid #333; background: #1a1a1a; align-items: center; justify-content: space-between; }
        
        /* CHECKBOX VIP */
        .vip-toggle { display: flex; align-items: center; gap: 5px; background: #222; padding: 5px 10px; border-radius: 15px; border: 1px solid #444; cursor: pointer; }
        .vip-toggle input { accent-color: gold; }
        .vip-toggle span { font-size: 10px; font-weight: bold; color: gold; }

        /* STATUS DU CERVEAU (SCAN) */
        .brain-loader { display: none; font-size: 10px; color: #0f0; margin-top: 5px; width: 100%; text-align: center; }
        .brain-dots { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        #channel-list { flex: 1; overflow-y: auto; padding: 0; width:100%; }

        /* VUE GRILLE/LISTE */
        .channel-row { display: flex; align-items: center; padding: 10px 15px; margin: 0; border-bottom: 1px solid #222; cursor: pointer; contain: content; }
        .channel-row:hover { background: #222; }
        .channel-row.active { background: rgba(229,9,20,0.2); border-left: 3px solid var(--primary); }
        .ch-logo { width: 35px; height: 35px; object-fit: contain; background: #fff; padding: 2px; border-radius: 3px; margin-right: 10px; }
        
        .grid-view { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 10px; }
        .grid-card { background: #222; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #333; aspect-ratio: 1/1; cursor: pointer; position: relative; }
        .grid-card.active { border-color: var(--primary); background: #330000; }
        .grid-img { width: 40px; height: 40px; object-fit: contain; background: #fff; padding: 2px; border-radius: 5px; margin-bottom: 5px; }
        .grid-title { font-size: 9px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; font-weight: bold; }
        .vip-badge { position: absolute; top: 2px; right: 2px; color: gold; font-size: 10px; }

        .fav-icon { color: #444; padding: 5px; margin-right: 10px; font-size: 12px; }
        .fav-icon.active { color: #ffd700; text-shadow: 0 0 5px gold; } 

        #bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); padding: 8px 15px; border-radius: 40px; border: 1px solid #333; display: flex; gap: 10px; align-items: center; z-index: 90; pointer-events: auto; width: auto; max-width: 98%; justify-content: space-between; flex-wrap: nowrap; overflow-x: auto; }
        .btn-ctrl { width: 45px; height: 45px; border-radius: 50%; background: #2a2a2a; color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; flex-shrink: 0; transition: 0.2s; }
        .btn-ctrl:active { background: var(--primary); transform: scale(0.95); }
        .btn-ctrl.active-mode { background: var(--primary); color: white; box-shadow: 0 0 10px var(--primary); animation: pulse 2s infinite; }
        .btn-large { width: 55px; height: 55px; font-size: 22px; background: var(--primary); border: 2px solid white; box-shadow: 0 0 10px rgba(229,9,20,0.5); }
        .desktop-only { display: flex; }
        @media (max-width: 600px) { .desktop-only { display: none; } #bottom-bar { gap: 5px; padding: 5px 10px; bottom: 10px; } .btn-ctrl { width: 40px; height: 40px; font-size: 16px; } .btn-large { width: 48px; height: 48px; font-size: 20px; } #channel-menu { width: 85%; } .grid-view { grid-template-columns: repeat(3, 1fr); } }

        /* PAGINATION */
        .pagination-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #111; border-top: 1px solid #333; }
        .page-btn { background: #333; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .page-info { font-size: 11px; color: #ccc; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; align-items: center; justify-content: center; pointer-events: auto; }
        .modal-box { background: #1a1a1a; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #444; }
        .settings-panel { background: #1a1a1a; width: 90%; max-width: 800px; height: 80vh; border-radius: 15px; border: 1px solid #444; display: flex; overflow: hidden; }
        .settings-sidebar { width: 200px; background: #111; padding: 20px; border-right: 1px solid #333; }
        .settings-tab { padding: 15px; cursor: pointer; color: #888; font-weight: 600; border-radius: 8px; margin-bottom: 5px; }
        .settings-tab.active { background: #222; color: white; }
        .settings-content { flex: 1; padding: 20px; overflow-y: auto; }
        .chips-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .chip { padding: 8px 15px; background: #333; border-radius: 20px; font-size: 12px; cursor: pointer; border: 1px solid transparent; }
        .chip.selected { background: var(--primary); color: white; }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 15px; border-radius: 5px; margin-bottom: 10px; }
        
        /* DATA STATS BOX */
        .data-box { background: #222; padding: 20px; border-radius: 10px; margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center; }
        .data-val { font-size: 18px; font-weight: bold; color: var(--primary); }
        .data-label { font-size: 12px; color: #888; }

        @media (max-width: 700px) { .settings-panel { flex-direction: column; } .settings-sidebar { width: 100%; height: auto; display: flex; overflow-x: auto; } }

        #admin-msg-box { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 15px 30px; border-radius: 30px; z-index: 300; display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.5); font-weight: bold; text-align: center; width: 90%; animation: slideDown 0.5s; }
        @keyframes slideDown { from { top: -50px; } to { top: 10%; } }
    </style>
</head>
<body>

<div id="custom-alert" class="modal" style="z-index: 99999;">
    <div class="modal-box" style="border: 1px solid #e50914; box-shadow: 0 0 20px rgba(229, 9, 20, 0.3); text-align: center;">
        <h3 style="color:#e50914;">Information</h3>
        <p id="custom-alert-text" style="color: white; font-size: 14px;">Message...</p>
        <button onclick="closeCustomAlert()" style="background: #e50914; color: white; border: none; padding: 10px 30px; border-radius: 50px;">OK</button>
    </div>
</div>
<div id="custom-confirm" class="modal" style="z-index: 99999;">
    <div class="modal-box" style="border: 1px solid #e50914; text-align: center;">
        <h3 style="color:#e50914;">Question</h3>
        <p id="custom-confirm-text" style="color: white; font-size: 14px;">Message...</p>
        <div style="display:flex; justify-content:center; gap:15px;">
            <button onclick="closeCustomConfirm(true)" style="background: #e50914; color: white; border: none; padding: 10px 30px; border-radius: 50px;">OUI</button>
            <button onclick="closeCustomConfirm(false)" style="background: #444; color: white; border: none; padding: 10px 30px; border-radius: 50px;">NON</button>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal">
    <div class="settings-panel">
        <div class="settings-sidebar">
            <div style="font-weight:bold; margin-bottom:20px; color:var(--primary)">R√âGLAGES</div>
            <div class="settings-tab active" onclick="showTab('tab-net')">R√©seau</div>
            <div class="settings-tab" onclick="showTab('tab-reset')">R√©initialiser</div>
            <div class="settings-tab" onclick="closeSettings()" style="color:#888; margin-top:10px;">Fermer</div>
        </div>
        <div class="settings-content">
            <div id="tab-net" class="tab-content">
                <h3>Infos R√©seau (Cerveau)</h3>
                <div class="data-box">
                    <div><div class="data-val" id="net-speed">0 Mbps</div><div class="data-label">Vitesse</div></div>
                    <i class="fas fa-tachometer-alt" style="font-size:20px;"></i>
                </div>
                <div class="data-box">
                    <div><div class="data-val" id="net-total">0 Mo</div><div class="data-label">Donn√©es</div></div>
                    <i class="fas fa-database" style="font-size:20px;"></i>
                </div>
            </div>
            <div id="tab-reset" class="tab-content" style="display:none;">
                <h3>Maintenance</h3>
                <p>Relancer l'extraction compl√®te des cha√Ænes depuis le serveur.</p>
                <button onclick="forceReload()" style="width:100%; padding:15px; background:red; color:white; border:none; border-radius:5px;">RESCANNER TOUT</button>
            </div>
        </div>
    </div>
</div>

<div id="video-layer"><video id="video" onclick="toggleMenu()" playsinline crossorigin="anonymous"></video></div>

<div id="ui-layer">
    <div id="status-pill">
        <div id="led"></div>
        <div class="signal-container" id="signal-meter">
            <div class="sig-bar b1"></div><div class="sig-bar b2"></div><div class="sig-bar b3"></div><div class="sig-bar b4"></div>
        </div>
        <span id="status-text" style="margin-left:5px;">Pr√™t</span>
    </div>
    
    <div id="channel-menu">
        <div class="menu-header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" style="width:100px;">
            <div class="brain-loader" id="brain-ui">üß† Le Cerveau analyse... <span id="brain-count">0</span></div>
            <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                <span style="font-size:14px; font-weight:bold;">CHA√éNES</span>
                <i class="fas fa-th" id="btn-view-mode" onclick="toggleViewMode()" style="cursor:pointer; font-size:14px; color:#aaa;" title="Vue"></i>
                <i class="fas fa-cog" onclick="openSettings()" style="cursor:pointer; color:#fff; font-size:20px;"></i>
            </div>
            <span id="total-count" style="font-size:10px; color:#888;">0 trouv√©es</span>
        </div>
        
        <input type="text" id="searchInput" placeholder="üîç Rechercher..." oninput="refreshList()">
        
        <div class="filter-bar">
            <label class="vip-toggle">
                <input type="checkbox" id="chk-vip" checked onchange="refreshList()">
                <span>‚òÖ VIP / DIRECT</span>
            </label>
        </div>

        <div id="channel-list"></div>

        <div class="pagination-bar">
            <button class="page-btn" onclick="changePage(-1)">‚ùÆ</button>
            <span class="page-info" id="page-display">Page 1</span>
            <button class="page-btn" onclick="changePage(1)">‚ùØ</button>
        </div>
    </div>

    <div id="bottom-bar">
        <button class="btn-ctrl" onclick="prevChannel()"><i class="fas fa-step-backward"></i></button>
        <button class="btn-ctrl desktop-only" onclick="adjustVol(-0.1)"><i class="fas fa-minus"></i></button>
        <button class="btn-ctrl btn-large" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
        <button class="btn-ctrl desktop-only" onclick="adjustVol(0.1)"><i class="fas fa-plus"></i></button>
        <button class="btn-ctrl" onclick="nextChannel()"><i class="fas fa-step-forward"></i></button>
        <button class="btn-ctrl" id="btn-autozap" onclick="toggleAutoZap()"><i class="fas fa-bolt"></i></button>
        <button class="btn-ctrl" id="btn-delete" onclick="hideCurrentChannel()" style="color:#ff4444;"><i class="fas fa-trash"></i></button>
        <button class="btn-ctrl" onclick="toggleFullScreen()"><i class="fas fa-expand"></i></button>
    </div>
</div>

<script>
    // =======================================================
    // CONFIGURATION ET BASE DE DONNEES (IndexedDB)
    // =======================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbyTVVHd3DGbEtlRfVN5aboerVM1UEbDYTGv4vJxabValUYDAHRxgLoFppjUO8xwv9SsTw/exec";
    const PROXY_URL = "https://corsproxy.io/?"; 
    const DB_NAME = "MyBoxTV_Brain_DB";
    const DB_VERSION = 2;
    const DEFAULT_CHANNEL = { name: "Novelas TV", url: "https://stormcast-telenovelatv-1-fr.samsung.wurl.tv/playlist.m3u8", logo: "https://upload.wikimedia.org/wikipedia/commons/2/29/Novelas_TV_Logo.png", category: "Start", isVip: true };

    let allChannels = [DEFAULT_CHANNEL];
    let filteredChannels = [];
    let loadedUrls = new Set([DEFAULT_CHANNEL.url]);
    
    // Pagination et UI
    let currentPage = 1;
    const itemsPerPage = 50;
    let isGridMode = localStorage.getItem('mybox_view_mode') === 'grid';
    let currentChannelIndex = 0;
    let hls = null;
    let isAutoZap = false;
    let autoZapTimeout = null;
    let totalBytesUsed = parseInt(localStorage.getItem('mybox_data_bytes')) || 0;

    const video = document.getElementById('video');
    const led = document.getElementById('led');

    // --- INITIALISATION ---
    window.onload = async function() {
        await initDB(); // Ouvrir la m√©moire interne
        playChannel(0); // Lancer Novelas
        updateModeUI();

        // Est-ce que le setup est d√©j√† fait ?
        if (localStorage.getItem('mybox_setup_done') === 'true') {
            console.log("D√©marrage rapide depuis la m√©moire...");
            await loadChannelsFromDB(); // Chargement instantan√©
        } else {
            console.log("Premier d√©marrage : Lancement du Cerveau...");
            startTheBrain(); // Analyse et extraction
        }
    };

    // --- LE CERVEAU : LOGIQUE D'EXTRACTION INTELLIGENTE ---
    async function startTheBrain() {
        const brainUI = document.getElementById('brain-ui');
        const brainCount = document.getElementById('brain-count');
        brainUI.style.display = 'block';

        try {
            // 1. R√©cup√©rer l'Excel via l'API
            const res = await fetch(`${API_URL}?action=get_playlists`);
            const data = await res.json();
            
            // data est un tableau d'objets { transponder: 'url_m3u', direct_url: 'url', name: 'nom' }
            
            for (const row of data) {
                // A. TRAITEMENT COLONNE D (LIEN DIRECT PREMIUM)
                if (row.direct_url && !loadedUrls.has(row.direct_url)) {
                    // Test silencieux
                    const isValid = await checkLinkSilently(row.direct_url);
                    if (isValid) {
                        const ch = {
                            name: row.name || "Cha√Æne Direct",
                            url: row.direct_url,
                            logo: "https://via.placeholder.com/40?text=VIP",
                            category: "Direct",
                            isVip: true
                        };
                        addChannelToSystem(ch);
                        brainCount.innerText = allChannels.length;
                    }
                }

                // B. TRAITEMENT COLONNE B (TRANSPONDEUR M3U)
                if (row.transponder) {
                    await extractM3U(row.transponder, brainCount);
                }
            }

            // Marquer comme termin√© pour les prochains d√©marrages
            localStorage.setItem('mybox_setup_done', 'true');
            brainUI.innerHTML = "‚úì Analyse Termin√©e et Sauvegard√©e";
            setTimeout(() => brainUI.style.display = 'none', 5000);

        } catch(e) { console.log("Erreur Cerveau", e); }
    }

    async function extractM3U(url, counterElem) {
        try {
            const res = await fetch(PROXY_URL + encodeURIComponent(url));
            if(!res.ok) return;
            const text = await res.text();
            const lines = text.split('\n');
            let info = null;

            for(let line of lines) {
                line = line.trim();
                if(!line) continue;
                if(line.startsWith('#EXTINF')) {
                    let name = line.split(',')[1] || "Sans Nom";
                    let logo = (line.match(/tvg-logo=["']?([^"']*)["']?/) || [])[1];
                    info = { name: name, logo: logo };
                } else if(line.startsWith('http')) {
                    if(info && !loadedUrls.has(line)) {
                        // Test lien avant ajout
                        const valid = await checkLinkSilently(line);
                        if(valid) {
                            addChannelToSystem({
                                name: info.name,
                                url: line,
                                logo: info.logo,
                                category: "Scan",
                                isVip: false
                            });
                            counterElem.innerText = allChannels.length;
                        }
                        info = null;
                    }
                }
            }
        } catch(e) {}
    }

    async function checkLinkSilently(url) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), 3000); // 3 sec max
        try {
            const response = await fetch(url, { method: 'HEAD', signal: controller.signal });
            clearTimeout(id);
            return response.ok;
        } catch(e) { return false; }
    }

    function addChannelToSystem(ch) {
        allChannels.push(ch);
        loadedUrls.add(ch.url);
        // Sauvegarde en DB
        saveToDB(ch);
        // Mise √† jour UI si on est sur la bonne page
        refreshList(true);
    }

    // --- BASE DE DONNEES INDEXEDDB (Pour 50 000+ items) ---
    let db;
    function initDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('channels')) {
                    db.createObjectStore('channels', { keyPath: 'url' });
                }
            };
            req.onsuccess = (e) => { db = e.target.result; resolve(); };
            req.onerror = (e) => reject(e);
        });
    }

    function saveToDB(channel) {
        const tx = db.transaction('channels', 'readwrite');
        tx.objectStore('channels').put(channel);
    }

    function loadChannelsFromDB() {
        return new Promise((resolve) => {
            const tx = db.transaction('channels', 'readonly');
            const req = tx.objectStore('channels').getAll();
            req.onsuccess = () => {
                if (req.result.length > 0) {
                    allChannels = req.result;
                    req.result.forEach(ch => loadedUrls.add(ch.url));
                    refreshList();
                } else {
                    // Si DB vide malgr√© le flag, on relance le cerveau
                    startTheBrain();
                }
                resolve();
            };
        });
    }
    
    async function clearDB() {
        const tx = db.transaction('channels', 'readwrite');
        tx.objectStore('channels').clear();
        localStorage.removeItem('mybox_setup_done');
    }

    // --- UI GESTION ---
    function refreshList(keepPage = false) {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const vipOnly = document.getElementById('chk-vip').checked;

        filteredChannels = allChannels.filter(ch => {
            if (term && !ch.name.toLowerCase().includes(term)) return false;
            // Si VIP coch√© : Affiche tout. Si d√©coch√© : Cache les VIP.
            if (!vipOnly && ch.isVip && ch !== DEFAULT_CHANNEL) return false;
            return true;
        });

        document.getElementById('total-count').innerText = filteredChannels.length + " Cha√Ænes";
        if (!keepPage) currentPage = 1;
        renderPagination();
    }

    function renderPagination() {
        const list = document.getElementById('channel-list');
        list.innerHTML = "";
        
        // Mode Grille ou Liste
        if(isGridMode) list.className = "grid-view"; else list.className = "";

        const totalPages = Math.ceil(filteredChannels.length / itemsPerPage) || 1;
        if(currentPage > totalPages) currentPage = totalPages;

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = filteredChannels.slice(start, end);
        const frag = document.createDocumentFragment();

        pageItems.forEach(ch => {
            const isPlaying = (ch.url === allChannels[currentChannelIndex]?.url);
            const div = document.createElement('div');
            
            const logo = ch.logo || "https://via.placeholder.com/40?text=TV";
            const vipMark = ch.isVip ? '<i class="fas fa-star" style="color:gold; font-size:10px;"></i>' : '';

            if (isGridMode) {
                div.className = 'grid-card ' + (isPlaying ? 'active' : '');
                div.innerHTML = `<img src="${logo}" class="grid-img"><div class="grid-title">${ch.name}</div><span class="vip-badge">${vipMark}</span>`;
            } else {
                div.className = 'channel-row ' + (isPlaying ? 'active' : '');
                div.innerHTML = `<img src="${logo}" class="ch-logo"><div class="ch-info"><div class="ch-name">${ch.name} ${vipMark}</div><div class="ch-tag">${ch.category || 'G√©n√©ral'}</div></div>`;
            }
            
            div.onclick = () => {
                const realIndex = allChannels.indexOf(ch);
                playChannel(realIndex);
            };
            frag.appendChild(div);
        });

        list.appendChild(frag);
        document.getElementById('page-display').innerText = `Page ${currentPage} / ${totalPages}`;
    }

    function changePage(d) { currentPage += d; refreshList(true); }
    function toggleViewMode() { isGridMode = !isGridMode; localStorage.setItem('mybox_view_mode', isGridMode ? 'grid' : 'list'); updateModeUI(); refreshList(true); }

    function updateModeUI() {
        const btnView = document.getElementById('btn-view-mode');
        if(isGridMode) { btnView.classList.remove('fa-th'); btnView.classList.add('fa-list'); }
        else { btnView.classList.remove('fa-list'); btnView.classList.add('fa-th'); }
    }

    // --- LECTEUR ---
    function playChannel(index) {
        if(index < 0 || index >= allChannels.length) return;
        currentChannelIndex = index;
        const ch = allChannels[index];
        refreshList(true); // Mise √† jour surbrillance
        
        if(window.innerWidth < 900) document.body.classList.remove('menu-open');
        document.getElementById('status-text').innerText = ch.name;

        if(Hls.isSupported()) {
            if(hls) hls.destroy();
            hls = new Hls();
            hls.loadSource(ch.url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => { video.play(); led.className = "green"; });
            hls.on(Hls.Events.FRAG_LOADED, (e, d) => {
                 if(d.stats) updateNetworkStats(d.stats.total, d.stats.loading.end - d.stats.loading.start);
            });
            hls.on(Hls.Events.ERROR, () => { led.className = ""; if(isAutoZap) nextChannel(); });
        } else if(video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = ch.url; video.play();
        }
    }

    // --- OUTILS SYSTEME ---
    function updateNetworkStats(bytes, duration) {
        totalBytesUsed += bytes;
        localStorage.setItem('mybox_data_bytes', totalBytesUsed);
        if(duration > 0) {
            const mbps = (bytes * 8) / (duration / 1000) / 1000000;
            document.getElementById('net-speed').innerText = mbps.toFixed(2) + " Mbps";
            
            const meter = document.getElementById('signal-meter');
            meter.className = "signal-container";
            if(mbps > 4) meter.classList.add('sig-lvl-4');
            else if(mbps > 2) meter.classList.add('sig-lvl-3');
            else if(mbps > 0.5) meter.classList.add('sig-lvl-2');
            else meter.classList.add('sig-lvl-1');
        }
        let total = totalBytesUsed > 1073741824 ? (totalBytesUsed/1073741824).toFixed(2)+" Go" : (totalBytesUsed/1048576).toFixed(0)+" Mo";
        document.getElementById('net-total').innerText = total;
    }

    // Commandes
    function toggleMenu() { document.body.classList.toggle('menu-open'); }
    function nextChannel() { playChannel(currentChannelIndex + 1); }
    function prevChannel() { playChannel(currentChannelIndex - 1); }
    function adjustVol(v) { video.volume = Math.min(1, Math.max(0, video.volume + v)); }
    function toggleFullScreen() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else if(document.exitFullscreen) document.exitFullscreen(); }
    function toggleAutoZap() { isAutoZap = !isAutoZap; document.getElementById('btn-autozap').classList.toggle('active-mode'); }
    
    // Dialogues
    function closeCustomAlert() { document.getElementById('custom-alert').style.display = 'none'; }
    function showMyAlert(msg) { document.getElementById('custom-alert-text').innerText = msg; document.getElementById('custom-alert').style.display = 'flex'; }
    
    let confirmCallback = null;
    function showMyConfirm(msg, cb) { 
        document.getElementById('custom-confirm-text').innerText = msg; 
        document.getElementById('custom-confirm').style.display = 'flex'; 
        confirmCallback = cb; 
    }
    function closeCustomConfirm(val) { 
        document.getElementById('custom-confirm').style.display = 'none'; 
        if(val && confirmCallback) confirmCallback(); 
    }

    function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function showTab(id) { 
        document.querySelectorAll('.tab-content').forEach(el => el.style.display='none'); 
        document.getElementById(id).style.display='block'; 
    }
    
    function forceReload() {
        showMyConfirm("Tout effacer et relancer le scan ?", async () => {
            await clearDB();
            location.reload();
        });
    }

    function hideCurrentChannel() {
        showMyConfirm("Masquer cette cha√Æne ?", () => {
            const ch = allChannels[currentChannelIndex];
            // Logique de masquage simple (non persistante ici pour simplifier)
            allChannels.splice(currentChannelIndex, 1);
            refreshList(true);
            nextChannel();
        });
    }
</script>
</body>
</html>
