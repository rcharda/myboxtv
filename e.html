<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">

    <title>My Box TV - Smart Brain Edition</title>
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #e50914; --glass: rgba(20, 20, 20, 0.98); --text: #fff; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #000; color: var(--text); height: 100vh; overflow: hidden; }

        #video-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: #000; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        #channel-menu { position: fixed; top: 0; left: 0; width: 350px; height: 100%; background: var(--glass); backdrop-filter: blur(15px); transform: translateX(-100%); transition: transform 0.3s; display: flex; flex-direction: column; z-index: 100; pointer-events: auto; border-right: 1px solid #333; }
        body.menu-open #channel-menu { transform: translateX(0); }

        .menu-header { padding: 15px; background: #111; border-bottom: 2px solid var(--primary); display: flex; flex-direction:column; align-items: center; gap:5px;}
        #searchInput { width: 95%; margin: 5px auto; padding: 10px; border-radius: 5px; background: #333; border: none; color: white; display: block; font-size: 14px; }
        
        /* BARRE DE FILTRES ET INFO CERVEAU */
        .filter-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; background: #1a1a1a; }
        
        /* CHECKBOX VIP STYLE */
        .vip-toggle { display: flex; align-items: center; gap: 6px; background: #222; padding: 6px 12px; border-radius: 20px; border: 1px solid #444; cursor: pointer; transition:0.2s; }
        .vip-toggle input { accent-color: gold; }
        .vip-toggle span { font-size: 11px; font-weight: bold; color: gold; text-transform: uppercase; }
        .vip-toggle:hover { border-color: gold; }

        /* INDICATEUR CERVEAU */
        .brain-status { font-size: 9px; color: #0f0; display: flex; align-items: center; gap: 5px; }
        .brain-dot { width: 6px; height: 6px; background: #0f0; border-radius: 50%; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.3;} 100% {opacity: 1;} }

        #channel-list { flex: 1; overflow-y: auto; padding: 0; width:100%; }
        
        .channel-row { display: flex; align-items: center; padding: 10px 15px; margin: 0; border-bottom: 1px solid #222; cursor: pointer; contain: content; }
        .channel-row:hover { background: #222; }
        .channel-row.active { background: rgba(229,9,20,0.2); border-left: 3px solid var(--primary); }
        .ch-logo { width: 35px; height: 35px; object-fit: contain; background: #fff; padding: 2px; border-radius: 3px; margin-right: 10px; }
        .ch-info { flex: 1; }
        .ch-name { font-weight: 600; font-size: 13px; display:flex; align-items:center; gap:5px; }
        .ch-tag { font-size: 9px; color: #888; }
        .vip-star { color: gold; font-size: 10px; }

        /* BARRE PAGINATION */
        .pagination-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #111; border-top: 1px solid #333; }
        .page-btn { background: #333; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-size: 11px; color: #ccc; }

        #bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); padding: 8px 15px; border-radius: 40px; border: 1px solid #333; display: flex; gap: 10px; align-items: center; z-index: 90; pointer-events: auto; width: auto; max-width: 98%; justify-content: space-between; flex-wrap: nowrap; overflow-x: auto; }
        .btn-ctrl { width: 45px; height: 45px; border-radius: 50%; background: #2a2a2a; color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; flex-shrink: 0; transition: 0.2s; }
        .btn-ctrl:active { background: var(--primary); transform: scale(0.95); }
        .desktop-only { display: flex; }
        @media (max-width: 600px) { .desktop-only { display: none; } #bottom-bar { gap: 5px; padding: 5px 10px; bottom: 10px; } #channel-menu { width: 85%; } }
    </style>
</head>
<body>

<div id="video-layer"><video id="video" onclick="toggleMenu()" playsinline crossorigin="anonymous"></video></div>

<div id="ui-layer">
    <div id="channel-menu">
        <div class="menu-header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" style="width:100px;">
            <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                <div class="brain-status" id="brain-indicator" style="display:none;">
                    <div class="brain-dot"></div> Analyse... <span id="brain-count">0</span>
                </div>
                <span id="total-count" style="font-size:10px; color:#888;">0 Cha√Ænes</span>
            </div>
        </div>
        
        <input type="text" id="searchInput" placeholder="üîç Rechercher..." oninput="refreshList()">
        
        <div class="filter-bar">
            <label class="vip-toggle">
                <input type="checkbox" id="chk-vip" checked onchange="refreshList()">
                <span>VIP / DIRECT</span>
            </label>
        </div>

        <div id="channel-list">
            </div>

        <div class="pagination-bar">
            <button class="page-btn" onclick="changePage(-1)">‚ùÆ</button>
            <span class="page-info" id="page-display">Page 1</span>
            <button class="page-btn" onclick="changePage(1)">‚ùØ</button>
        </div>
    </div>

    <div id="bottom-bar">
        <button class="btn-ctrl" onclick="prevChannel()"><i class="fas fa-step-backward"></i></button>
        <button class="btn-ctrl desktop-only" onclick="adjustVol(-0.1)"><i class="fas fa-minus"></i></button>
        <button class="btn-ctrl btn-large" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
        <button class="btn-ctrl desktop-only" onclick="adjustVol(0.1)"><i class="fas fa-plus"></i></button>
        <button class="btn-ctrl" onclick="nextChannel()"><i class="fas fa-step-forward"></i></button>
        <button class="btn-ctrl" onclick="toggleFullScreen()"><i class="fas fa-expand"></i></button>
    </div>
</div>

<script>
    // URL DE TON SCRIPT GOOGLE (A REMPLACER PAR LE TIEN)
    const API_URL = "https://script.google.com/macros/s/AKfycbyTVVHd3DGbEtlRfVN5aboerVM1UEbDYTGv4vJxabValUYDAHRxgLoFppjUO8xwv9SsTw/exec";

    // NOVELAS PAR DEFAUT
    const DEFAULT_CHANNEL = { 
        name: "Novelas TV", 
        url: "https://stormcast-telenovelatv-1-fr.samsung.wurl.tv/playlist.m3u8", 
        logo: "https://upload.wikimedia.org/wikipedia/commons/2/29/Novelas_TV_Logo.png", 
        category: "Start",
        isVip: true 
    };

    // --- VARIABLES ---
    let allChannels = [DEFAULT_CHANNEL]; // Liste principale
    let filteredChannels = [];           // Liste filtr√©e pour affichage
    let loadedUrls = new Set([DEFAULT_CHANNEL.url]); // Anti-doublons
    
    // Pagination
    let currentPage = 1;
    const itemsPerPage = 50; // Affiche 50 cha√Ænes par page (Super fluide)

    let currentChannelIndex = 0;
    let hls = null;
    const video = document.getElementById('video');

    window.onload = function() {
        playChannel(0); // Lancer Novelas
        refreshList();  // Afficher la liste
        startTheBrain(); // Lancer l'analyseur
    };

    // --- LE CERVEAU (BACKEND ANALYZER) ---
    async function startTheBrain() {
        const brainUI = document.getElementById('brain-indicator');
        const brainCount = document.getElementById('brain-count');
        brainUI.style.display = 'flex';

        try {
            // 1. R√©cup√©ration de la liste brute (Transpondeurs + Premium Excel)
            const res = await fetch(`${API_URL}?action=get_playlists`);
            const data = await res.json();
            
            let candidates = [];

            // A. Traitement des Transpondeurs (M3U Classique) -> Ajout Direct
            if(data.transponders) {
                // ... Code pour scanner les M3U classiques ...
                // Pour l'exemple, on suppose que data contient tout
            }

            // B. Traitement Colonnes Excel (D=Lien, E=Nom)
            // Supposons que l'API renvoie un tableau 'premiumCandidates'
            // [ {name: "TF1", url: "..."}, {name: "A+", url: "..."} ]
            if (data) {
                // On transforme les donn√©es en liste de candidats
                // (Adaptation selon ton format JSON r√©el)
                candidates = Array.isArray(data) ? data : (data.premium || []);
            }

            // 2. ANALYSE SILENCIEUSE (Boucle intelligente)
            let addedCount = 0;
            
            for (const item of candidates) {
                // Anti-Doublon : On v√©rifie si l'URL est d√©j√† l√†
                if (loadedUrls.has(item.url)) continue;

                // VERIFICATION ARRIERE PLAN (Ping le lien)
                const isValid = await checkLinkSilently(item.url);
                
                if (isValid) {
                    // SI VALIDE : AJOUT MAGIQUE
                    const newCh = {
                        name: item.name || "Cha√Æne D√©tect√©e",
                        url: item.url,
                        logo: item.logo || "https://via.placeholder.com/40?text=TV",
                        category: "Premium",
                        isVip: true // Marque comme VIP
                    };

                    allChannels.push(newCh);
                    loadedUrls.add(newCh.url);
                    addedCount++;
                    brainCount.innerText = addedCount;
                    
                    // Mise √† jour discr√®te de l'interface si on est sur la bonne page
                    refreshList(true); // true = garde la position
                }
                // Si lien mort : on l'ignore, il n'appara√Æt jamais.
            }

        } catch(e) { console.log("Cerveau en pause..."); }
        
        brainUI.style.display = 'none'; // Analyse termin√©e
    }

    // Fonction de test lien (HEAD Request avec Timeout court)
    async function checkLinkSilently(url) {
        if(!url) return false;
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), 4000); // 4 sec max par lien
        try {
            const response = await fetch(url, { method: 'HEAD', signal: controller.signal });
            clearTimeout(id);
            return response.ok;
        } catch(e) {
            return false; 
        }
    }

    // --- GESTION LISTE & PAGINATION ---
    function refreshList(keepPage = false) {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const vipOnly = document.getElementById('chk-vip').checked;

        // 1. Filtrage
        filteredChannels = allChannels.filter(ch => {
            // Recherche par nom
            if (term && !ch.name.toLowerCase().includes(term)) return false;
            
            // Logique Checkbox VIP :
            // Si coch√© : On affiche TOUT (y compris VIP)
            // Si d√©coch√© : On cache les VIP (on garde que les Transpondeurs)
            if (!vipOnly && ch.isVip && ch !== DEFAULT_CHANNEL) return false;

            return true;
        });

        // 2. Mise √† jour compteur
        document.getElementById('total-count').innerText = filteredChannels.length + " Cha√Ænes";

        // 3. Reset Page sauf si demand√©
        if (!keepPage) currentPage = 1;
        
        renderPagination();
    }

    function renderPagination() {
        const list = document.getElementById('channel-list');
        list.innerHTML = "";
        
        const totalPages = Math.ceil(filteredChannels.length / itemsPerPage) || 1;
        if(currentPage > totalPages) currentPage = totalPages;

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = filteredChannels.slice(start, end);

        const frag = document.createDocumentFragment();

        pageItems.forEach(ch => {
            const isPlaying = (ch.url === allChannels[currentChannelIndex]?.url);
            const div = document.createElement('div');
            div.className = 'channel-row ' + (isPlaying ? 'active' : '');
            
            // Affiche une √©toile si VIP
            const vipIcon = ch.isVip ? '<i class="fas fa-star vip-star"></i>' : '';

            div.innerHTML = `
                <img src="${ch.logo}" class="ch-logo" onerror="this.src='https://via.placeholder.com/35?text=TV'">
                <div class="ch-info">
                    <div class="ch-name">${ch.name} ${vipIcon}</div>
                    <div class="ch-tag">${ch.category || 'G√©n√©ral'}</div>
                </div>
            `;
            
            div.onclick = () => {
                // Trouver l'index r√©el dans la liste globale
                const realIndex = allChannels.indexOf(ch);
                playChannel(realIndex);
            };
            
            frag.appendChild(div);
        });

        list.appendChild(frag);
        document.getElementById('page-display').innerText = `Page ${currentPage} / ${totalPages}`;
    }

    function changePage(direction) {
        currentPage += direction;
        refreshList(true); // true = ne pas reset la page, juste rafraichir
    }

    // --- LECTEUR ---
    function playChannel(index) {
        if(index < 0 || index >= allChannels.length) return;
        currentChannelIndex = index;
        const ch = allChannels[index];
        
        // Mise √† jour visuelle (seulement si la cha√Æne est visible sur la page courante)
        refreshList(true); 

        if(window.innerWidth < 900) document.body.classList.remove('menu-open');

        if(Hls.isSupported()) {
            if(hls) hls.destroy();
            hls = new Hls();
            hls.loadSource(ch.url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                video.play();
                document.getElementById('led').className = "green";
                document.getElementById('status-text').innerText = ch.name;
            });
            hls.on(Hls.Events.ERROR, () => {
                document.getElementById('led').className = "";
                document.getElementById('status-text').innerText = "Erreur Flux";
            });
        } else if(video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = ch.url;
            video.play();
        }
    }

    function toggleMenu() { document.body.classList.toggle('menu-open'); }
    function nextChannel() { playChannel(currentChannelIndex + 1); }
    function prevChannel() { playChannel(currentChannelIndex - 1); }
    function adjustVol(v) { video.volume = Math.min(1, Math.max(0, video.volume + v)); }
    function toggleFullScreen() {
        if(!document.fullscreenElement) document.documentElement.requestFullscreen();
        else if(document.exitFullscreen) document.exitFullscreen();
    }
</script>
</body>
</html>
