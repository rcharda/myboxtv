<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">

    <title>My Box TV - Smart Ultimate</title>
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #e50914; --glass: rgba(15, 15, 15, 0.95); --text: #fff; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #000; color: var(--text); height: 100vh; overflow: hidden; }

        #video-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: #000; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        #status-pill { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); padding: 8px 15px; border-radius: 20px; border: 1px solid #444; font-size: 12px; color: #fff; z-index: 60; display: flex; align-items: center; gap: 10px; pointer-events: none; }
        #led { width: 8px; height: 8px; background: red; border-radius: 50%; transition: 0.3s; box-shadow: 0 0 5px red; }
        #led.green { background: #0f0; box-shadow: 0 0 5px #0f0; }
        #led.orange { background: orange; box-shadow: 0 0 5px orange; }
        .signal-container { display: flex; align-items: flex-end; gap: 3px; height: 14px; }
        .sig-bar { width: 4px; background: #444; border-radius: 1px; transition: background 0.3s; }
        .sig-bar.b1 { height: 25%; } .sig-bar.b2 { height: 50%; } .sig-bar.b3 { height: 75%; } .sig-bar.b4 { height: 100%; }
        .sig-lvl-4 .sig-bar { background: #00ff00; } 

        #channel-menu { position: fixed; top: 0; left: 0; width: 350px; height: 100%; background: var(--glass); backdrop-filter: blur(15px); transform: translateX(-100%); transition: transform 0.3s; display: flex; flex-direction: column; z-index: 100; pointer-events: auto; border-right: 1px solid #333; }
        body.menu-open #channel-menu { transform: translateX(0); }

        .menu-header { padding: 15px; background: #111; border-bottom: 2px solid var(--primary); display: flex; flex-direction:column; align-items: center; gap:5px;}
        #searchInput { width: 95%; margin: 5px auto; padding: 10px; border-radius: 5px; background: #333; border: none; color: white; display: block; font-size: 14px; }
        
        /* FILTRE PREMIUM CHECKBOX */
        .filter-bar { display: flex; gap: 10px; padding: 10px; border-bottom: 1px solid #333; background: #1a1a1a; align-items: center; }
        
        /* CHECKBOX PERSONNALISÃ‰E */
        .premium-check { display: flex; align-items: center; gap: 8px; background: #222; padding: 8px 12px; border-radius: 20px; border: 1px solid #444; cursor: pointer; }
        .premium-check input { accent-color: var(--primary); width: 16px; height: 16px; }
        .premium-check span { font-size: 11px; font-weight: bold; color: #fff; }
        .premium-check.active { border-color: var(--primary); background: rgba(229,9,20,0.1); }

        #scan-info { width: 90%; display: none; flex-direction: column; gap: 5px; margin-bottom: 5px; }
        #scan-text { font-size: 10px; color: #0f0; font-family: monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #scan-progress { width: 100%; height: 2px; background: #333; position: relative; overflow: hidden; }
        #scan-bar { position: absolute; left: 0; top: 0; height: 100%; width: 50%; background: #0f0; animation: scanAnim 1s infinite linear; }
        @keyframes scanAnim { 0% {left: -50%;} 100% {left: 100%;} }

        #channel-list { flex: 1; overflow-y: auto; padding: 0; width:100%; }

        /* VUE GRILLE/LISTE */
        .channel-row { display: flex; align-items: center; padding: 10px 15px; margin: 0; border-bottom: 1px solid #222; cursor: pointer; contain: content; }
        .channel-row:hover { background: #222; }
        .channel-row.active { background: rgba(229,9,20,0.2); border-left: 3px solid var(--primary); }
        .ch-logo { width: 35px; height: 35px; object-fit: contain; background: #fff; padding: 2px; border-radius: 3px; margin-right: 10px; }
        
        .grid-view { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 10px; }
        .grid-card { background: #222; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #333; aspect-ratio: 1/1; cursor: pointer; position: relative; }
        .grid-card.active { border-color: var(--primary); background: #330000; }
        .grid-card.vip { border: 1px solid gold; box-shadow: 0 0 5px rgba(255, 215, 0, 0.3); } /* Style pour les chaines VIP */
        .vip-badge { position: absolute; top: 5px; right: 5px; color: gold; font-size: 10px; }
        .grid-img { width: 40px; height: 40px; object-fit: contain; background: #fff; padding: 2px; border-radius: 5px; margin-bottom: 5px; }
        .grid-title { font-size: 9px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; font-weight: bold; }

        .fav-icon { color: #444; padding: 5px; margin-right: 10px; font-size: 12px; }
        .fav-icon.active { color: #ffd700; text-shadow: 0 0 5px gold; } 

        #bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); padding: 8px 15px; border-radius: 40px; border: 1px solid #333; display: flex; gap: 10px; align-items: center; z-index: 90; pointer-events: auto; width: auto; max-width: 98%; justify-content: space-between; flex-wrap: nowrap; overflow-x: auto; }
        .btn-ctrl { width: 45px; height: 45px; border-radius: 50%; background: #2a2a2a; color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; flex-shrink: 0; transition: 0.2s; }
        .btn-ctrl:active { background: var(--primary); transform: scale(0.95); }
        .btn-ctrl.active-mode { background: var(--primary); color: white; box-shadow: 0 0 10px var(--primary); animation: pulse 2s infinite; }
        .btn-large { width: 55px; height: 55px; font-size: 22px; background: var(--primary); border: 2px solid white; box-shadow: 0 0 10px rgba(229,9,20,0.5); }
        .desktop-only { display: flex; }
        @media (max-width: 600px) { .desktop-only { display: none; } #bottom-bar { gap: 5px; padding: 5px 10px; bottom: 10px; } .btn-ctrl { width: 40px; height: 40px; font-size: 16px; } .btn-large { width: 48px; height: 48px; font-size: 20px; } #channel-menu { width: 85%; } .grid-view { grid-template-columns: repeat(3, 1fr); } }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; align-items: center; justify-content: center; pointer-events: auto; }
        .modal-box { background: #1a1a1a; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #444; }
        .settings-panel { background: #1a1a1a; width: 90%; max-width: 800px; height: 80vh; border-radius: 15px; border: 1px solid #444; display: flex; overflow: hidden; }
        .settings-sidebar { width: 200px; background: #111; padding: 20px; border-right: 1px solid #333; }
        .settings-tab { padding: 15px; cursor: pointer; color: #888; font-weight: 600; border-radius: 8px; margin-bottom: 5px; }
        .settings-tab.active { background: #222; color: white; }
        .settings-content { flex: 1; padding: 20px; overflow-y: auto; }
        .chips-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .chip { padding: 8px 15px; background: #333; border-radius: 20px; font-size: 12px; cursor: pointer; border: 1px solid transparent; }
        .chip.selected { background: var(--primary); color: white; }
        
        .toggle-row { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 15px; border-radius: 5px; margin-bottom: 10px; }
        
        .data-box { background: #222; padding: 20px; border-radius: 10px; margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center; }
        .data-val { font-size: 18px; font-weight: bold; color: var(--primary); }
        .data-label { font-size: 12px; color: #888; }

        @media (max-width: 700px) { .settings-panel { flex-direction: column; } .settings-sidebar { width: 100%; height: auto; display: flex; overflow-x: auto; } }

        #admin-msg-box { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 15px 30px; border-radius: 30px; z-index: 300; display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.5); font-weight: bold; text-align: center; width: 90%; animation: slideDown 0.5s; }
        @keyframes slideDown { from { top: -50px; } to { top: 10%; } }
        
        .app-logo { max-width: 150px; margin-bottom: 20px; }
        #maint-screen { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#111; z-index:9999; flex-direction:column; align-items:center; justify-content:center; text-align:center; }
        
        .tp-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #333; margin-bottom: 5px; border-radius: 5px; }
        .tp-name { color: white; font-weight: bold; }
        .tp-checkbox { width: 20px; height: 20px; accent-color: var(--primary); }
    </style>
</head>
<body>

<div id="custom-alert" class="modal" style="z-index: 99999;">
    <div class="modal-box" style="border: 1px solid #e50914; box-shadow: 0 0 20px rgba(229, 9, 20, 0.3); text-align: center;">
        <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" style="width:80px; margin-bottom:10px;">
        <h3 style="color:#e50914; margin: 0 0 15px 0; text-transform: uppercase;">Information</h3>
        <p id="custom-alert-text" style="color: white; font-size: 14px; line-height: 1.5; margin-bottom: 25px;">Message...</p>
        <button onclick="closeCustomAlert()" style="background: #e50914; color: white; border: none; padding: 12px 40px; border-radius: 50px; font-weight: bold; font-size: 14px; cursor: pointer; box-shadow: 0 5px 15px rgba(229,9,20,0.4);">
            COMPRIS
        </button>
    </div>
</div>

<div id="custom-confirm" class="modal" style="z-index: 99999;">
    <div class="modal-box" style="border: 1px solid #e50914; box-shadow: 0 0 20px rgba(229, 9, 20, 0.3); text-align: center;">
        <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" style="width:80px; margin-bottom:10px;">
        <h3 style="color:#e50914; margin: 0 0 15px 0; text-transform: uppercase;">QUESTION</h3>
        <p id="custom-confirm-text" style="color: white; font-size: 14px; line-height: 1.5; margin-bottom: 25px;">Message...</p>
        <div style="display:flex; justify-content:center; gap:15px;">
            <button onclick="closeCustomConfirm(true)" style="background: #e50914; color: white; border: none; padding: 12px 30px; border-radius: 50px; font-weight: bold; font-size: 14px; cursor: pointer;">
                OUI
            </button>
            <button onclick="closeCustomConfirm(false)" style="background: #444; color: white; border: none; padding: 12px 30px; border-radius: 50px; font-weight: bold; font-size: 14px; cursor: pointer;">
                NON
            </button>
        </div>
    </div>
</div>

<div id="maint-screen">
    <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" style="width:120px; margin-bottom:20px;">
    <h1 style="color:#e50914;">MAINTENANCE</h1>
    <p>Optimisation en cours...</p>
</div>

<div id="admin-msg-box">Message...</div>

<div id="pin-modal" class="modal">
    <div class="modal-box">
        <h3 style="color:#e50914;"><i class="fas fa-lock"></i> SÃ‰CURITÃ‰</h3>
        <input type="password" id="pin-code" class="pin-input" maxlength="4" placeholder="â€¢â€¢â€¢â€¢">
        <div style="display:flex; gap:10px; justify-content:center;">
            <button onclick="checkPin()" style="padding:10px 20px; background:#e50914; color:white; border:none; border-radius:5px;">OK</button>
            <button onclick="closePin()" style="padding:10px 20px; background:#444; color:white; border:none; border-radius:5px;">X</button>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal">
    <div class="settings-panel">
        <div class="settings-sidebar">
            <div style="font-weight:bold; margin-bottom:20px; color:var(--primary)">RÃ‰GLAGES</div>
            <div class="settings-tab active" onclick="showTab('tab-general')">Sources</div>
            <div class="settings-tab" onclick="showTab('tab-inst')">Installation</div>
            <div class="settings-tab" onclick="showTab('tab-cat')">Groupes</div>
            <div class="settings-tab" onclick="showTab('tab-net')">RÃ©seau</div>
            <div class="settings-tab" onclick="showTab('tab-sub')">Compte</div>
            <div class="settings-tab" onclick="forceReload()" style="color:#ff4444; margin-top:20px;">RÃ©initialiser TV</div>
            <div class="settings-tab" onclick="closeSettings()" style="color:#888; margin-top:10px;">Fermer âœ•</div>
        </div>
        <div class="settings-content">
            <div id="tab-general" class="tab-content">
                <h3 style="color:#e50914;">MODE DE RÃ‰CEPTION</h3>
                <p style="color:#888; font-size:12px; margin-bottom:20px;">Veuillez choisir votre configuration pour commencer.</p>

                <div class="toggle-row">
                    <div>
                        <div style="font-weight:bold;">Mode Complet (Transpondeurs)</div>
                        <div style="font-size:10px; color:#aaa;">Scan M3U + ChaÃ®nes VIP</div>
                    </div>
                    <input type="radio" name="sourceMode" value="full" onchange="changeSourceMode('full')">
                </div>

                <div class="toggle-row">
                    <div>
                        <div style="font-weight:bold; color:#2ecc71;">Mode Premium (VIP)</div>
                        <div style="font-size:10px; color:#aaa;">Uniquement les chaÃ®nes certifiÃ©es haute qualitÃ©.</div>
                    </div>
                    <input type="radio" name="sourceMode" value="premium" onchange="changeSourceMode('premium')">
                </div>
            </div>

            <div id="tab-inst" class="tab-content" style="display:none;">
                <h3 style="color:#e50914;"><i class="fas fa-satellite-dish"></i> SATELLITE / IPTV</h3>
                <p style="color:#aaa; font-size:12px;">Cochez les transpondeurs Ã  scanner.</p>
                <div id="transponder-list">
                    <div style="text-align:center; padding:20px;">Chargement des sources...</div>
                </div>
                <button onclick="scanSelectedTransponders()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:5px; font-weight:bold; font-size:16px; margin-top:20px;">
                    <i class="fas fa-search"></i> LANCER LE BALAYAGE
                </button>
            </div>

            <div id="tab-cat" class="tab-content" style="display:none;">
                <h3>Dossiers</h3>
                <button onclick="resetFilters()" style="width:100%; background:#444; padding:10px; margin-bottom:15px; border:none; color:white; border-radius:5px;">ðŸ”„ TOUT AFFICHER</button>
                <div id="chips-area" class="chips-container"></div>
                <button onclick="applyFilters()" style="margin-top:20px; width:100%; background:var(--primary); border:none; color:white; padding:10px; border-radius:5px;">Valider</button>
            </div>

            <div id="tab-net" class="tab-content" style="display:none;">
                <h3>Infos RÃ©seau</h3>
                <div class="data-box">
                    <div>
                        <div class="data-val" id="net-speed">0 Mbps</div>
                        <div class="data-label">Vitesse Actuelle</div>
                    </div>
                    <i class="fas fa-tachometer-alt" style="font-size:20px; color:#555;"></i>
                </div>
                <div class="data-box">
                    <div>
                        <div class="data-val" id="net-total">0 Mo</div>
                        <div class="data-label">DonnÃ©es ConsommÃ©es</div>
                    </div>
                    <i class="fas fa-database" style="font-size:20px; color:#555;"></i>
                </div>
                <p style="color:#888; font-size:10px; margin-top:10px;">Les donnÃ©es sont enregistrÃ©es dans la mÃ©moire interne de l'appareil (Le Cerveau).</p>
            </div>

            <div id="tab-sub" class="tab-content" style="display:none;">
                <h3>Abonnement</h3>
                <div style="background:#222; padding:20px; border-radius:10px; margin-bottom:20px;">
                    ID: <span id="sub-id">...</span><br>
                    Infos: <span id="sub-details">...</span>
                </div>
                <button onclick="logout()" style="width:100%; background:#ff4444; color:white; border:none; padding:15px; border-radius:8px; font-weight:bold; cursor:pointer;">DÃ‰CONNECTER</button>
                <a href="https://wa.me/22963828767?text=Support" target="_blank" style="display:block; margin-top:10px; color:#888; text-align:center; text-decoration:none;">Support WhatsApp</a>
            </div>
        </div>
    </div>
</div>

<div id="login-screen" class="modal" style="display:flex;">
    <div class="modal-box">
        <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" class="app-logo">
        <input type="text" id="licenseKey" placeholder="ID ABONNEMENT" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:5px; text-align:center; font-size:18px; margin-bottom:15px;">
        <button onclick="login()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:5px; font-weight:bold;">ENTRER</button>
        <div id="login-msg" style="color:#ff4444; margin-top:10px;"></div>
    </div>
</div>

<div id="video-layer"><video id="video" onclick="toggleMenu()" playsinline crossorigin="anonymous"></video></div>

<div id="ui-layer">
    <div id="status-pill">
        <div id="led"></div>
        <div class="signal-container" id="signal-meter">
            <div class="sig-bar b1"></div>
            <div class="sig-bar b2"></div>
            <div class="sig-bar b3"></div>
            <div class="sig-bar b4"></div>
        </div>
        <span id="status-text" style="margin-left:5px;">PrÃªt</span>
    </div>
    
    <div id="channel-menu">
        <div class="menu-header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" style="width:100px;">
            <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
                <div style="text-align:left; width:100%;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:14px; font-weight:bold;">CHAÃŽNES</span>
                        <i class="fas fa-th" id="btn-view-mode" onclick="toggleViewMode()" style="cursor:pointer; font-size:14px; color:#aaa; margin-right:5px;" title="Basculer Vue"></i>
                        <i class="fas fa-exchange-alt" onclick="toggleModeQuick()" style="cursor:pointer; font-size:12px; color:#aaa; margin-right:5px;" title="Basculer Premium/Transpondeur"></i>
                        <span id="mode-badge" style="font-size:9px; background:#333; padding:2px 5px; border-radius:3px;">AUTO</span>
                        <i class="fas fa-sync-alt" onclick="quickScan()" style="cursor:pointer; font-size:12px; color:#aaa; margin-left:10px;" title="Recherche Rapide"></i>
                    </div>
                    <div style="font-size:10px; color:#888;" id="count-display">0 trouvÃ©es</div>
                    <div id="scan-info">
                        <div id="scan-text">En attente...</div>
                        <div id="scan-progress"><div id="scan-bar"></div></div>
                    </div>
                </div>
                <i class="fas fa-cog" onclick="openSettings()" style="cursor:pointer; color:#fff; font-size:20px;"></i>
            </div>
        </div>
        
        <input type="text" id="searchInput" placeholder="ðŸ” Rechercher..." oninput="renderList()">
        
        <div class="filter-bar">
            <label class="premium-check active" id="chk-premium-label" onclick="togglePremiumFilter()">
                <input type="checkbox" id="chk-premium" checked>
                <span>ðŸ’Ž VIP</span>
            </label>
            
            <button onclick="toggleOnlyFavorites()" class="btn-mini" id="btn-fav-filter">
                <i class="fas fa-star" style="color:gold;"></i> Favoris
            </button>
        </div>

        <div id="channel-list"></div>
    </div>

    <div id="bottom-bar">
        <button class="btn-ctrl" onclick="prevChannel()"><i class="fas fa-step-backward"></i></button>
        <button class="btn-ctrl desktop-only" onclick="adjustVol(-0.1)"><i class="fas fa-minus"></i></button>
        <button class="btn-ctrl btn-large" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
        <button class="btn-ctrl desktop-only" onclick="adjustVol(0.1)"><i class="fas fa-plus"></i></button>
        <button class="btn-ctrl" onclick="nextChannel()"><i class="fas fa-step-forward"></i></button>
        
        <button class="btn-ctrl" id="btn-autozap" onclick="toggleAutoZap()"><i class="fas fa-bolt"></i></button>
        
        <button class="btn-ctrl" id="btn-delete" onclick="hideCurrentChannel()" style="color:#ff4444;"><i class="fas fa-trash"></i></button>
        <button class="btn-ctrl" onclick="toggleFullScreen()"><i class="fas fa-expand"></i></button>
    </div>
</div>

<script>
    // =======================================================
    // CONFIGURATION
    // =======================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbyTVVHd3DGbEtlRfVN5aboerVM1UEbDYTGv4vJxabValUYDAHRxgLoFppjUO8xwv9SsTw/exec";
    const PIN_CODE = "0000"; 
    const DB_NAME = "MyBoxTV_V62_Final"; 
    const DB_VERSION = 1;

    // --- LISTE DES CHAINES PREMIUM (INJECTÃ‰ES AUTOMATIQUEMENT) ---
    const premiumSources = [
        { name: "Novelas TV", logo: "https://upload.wikimedia.org/wikipedia/commons/2/29/Novelas_TV_Logo.png", url: "https://stormcast-telenovelatv-1-fr.samsung.wurl.tv/playlist.m3u8", category: "SÃ©ries", isVip: true },
        { name: "Nollywood TV", logo: "https://upload.wikimedia.org/wikipedia/fr/5/53/Nollywood_TV_Logo.png", url: "https://live20.bozztv.com/trn03/gin-nollywoodtv/index.m3u8", category: "Films", isVip: true },
        { name: "France 24", logo: "https://upload.wikimedia.org/wikipedia/commons/f/f1/France_24_logo.png", url: "https://live.france24.com/hls/live/2037179/F24_FR_HI_HLS/master_5000.m3u8", category: "Infos", isVip: true },
        { name: "TV5 Monde Afrique", logo: "https://upload.wikimedia.org/wikipedia/commons/c/c3/TV5MONDE_Afrique_Logo_2022.png", url: "https://ott.tv5monde.com/Content/HLS/Live/channel(afrique)/variant.m3u8", category: "GÃ©nÃ©raliste", isVip: true },
        { name: "BFM TV", logo: "https://upload.wikimedia.org/wikipedia/commons/2/2b/BFM_TV_2017.svg", url: "https://ncdn-live-bfm.pfd.sfr.net/shls/LIVE$BFM_TV/index.m3u8?start=LIVE&end=END", category: "Infos", isVip: true },
        { name: "ORTB (BÃ©nin)", logo: "https://upload.wikimedia.org/wikipedia/commons/5/59/ORTB_Logo.png", url: "https://edge5.vedge.infomaniak.com/livecast/ortb/playlist.m3u8", category: "Locales", isVip: true },
        { name: "ADO TV", logo: "https://i.imgur.com/3Q8Q9lZ.png", url: "https://stream01.adotv-fm.bj/ado-tv-live/index.m3u8", category: "Locales", isVip: true }
    ];

    // VARIABLES GLOBALES
    let allChannels = [], displayedChannels = [], loadedUrls = new Set();
    let favorites = JSON.parse(localStorage.getItem('mybox_favs') || '[]');
    let currentChannelIndex = 0;
    let deviceId = localStorage.getItem('mybox_device_id') || 'DEV-'+Math.random().toString(36).substr(2,9).toUpperCase();
    localStorage.setItem('mybox_device_id', deviceId);
    
    let isFavFilter = false, hls = null, pendingChannelIndex = -1, isAutoZap = false;
    let allCategories = new Set(['Favoris']), selectedCategories = JSON.parse(localStorage.getItem('mybox_categories') || '[]');
    let hiddenChannels = JSON.parse(localStorage.getItem('mybox_hidden') || '[]');
    let autoZapTimeout = null;

    let availableTransponders = []; 
    let lastActivityTime = Date.now();
    let isScanning = false;
    let appMode = localStorage.getItem('mybox_mode'); 
    
    // VIEW MODE (Grid vs List)
    let isGridMode = localStorage.getItem('mybox_view_mode') === 'grid';
    // VIP FILTER
    let showVip = true; 

    // DATA STATS
    let totalBytesUsed = parseInt(localStorage.getItem('mybox_data_bytes'));
    if(isNaN(totalBytesUsed)) totalBytesUsed = 0;

    const video = document.getElementById('video');
    const statusText = document.getElementById('status-text');
    const led = document.getElementById('led');

    // --- SMART VALIDATOR : VERIFICATION SILENCIEUSE ---
    async function checkStreamValidity(url) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), 8000); // 8s timeout
        try {
            const response = await fetch(url, { method: 'HEAD', signal: controller.signal });
            clearTimeout(id);
            return response.ok;
        } catch(e) {
            return false; 
        }
    }

    async function injectPremiumChannels() {
        // Ajout immÃ©diat pour l'UI, nettoyage plus tard si mort
        premiumSources.forEach(ch => {
            if(!loadedUrls.has(ch.url)) {
                // On les met AU DÃ‰BUT de la liste
                allChannels.unshift(ch);
                loadedUrls.add(ch.url);
            }
        });
        renderList();
        
        // Validation en arriÃ¨re plan (Optionnel : si on veut retirer les morts)
        /*
        for(let ch of premiumSources) {
            const isValid = await checkStreamValidity(ch.url);
            if(!isValid) {
                // Logic to remove if needed, but for now we keep them visible
                //console.log("Stream HS:", ch.name);
            }
        }
        */
    }

    // --- ALERTES & CONFIRMATIONS ---
    let onAlertCloseAction = null;
    let onConfirmAction = null;

    function showMyAlert(message, actionAfter) {
        document.getElementById('custom-alert-text').innerText = message;
        document.getElementById('custom-alert').style.display = 'flex';
        if (actionAfter) { onAlertCloseAction = actionAfter; }
    }
    function closeCustomAlert() {
        document.getElementById('custom-alert').style.display = 'none';
        if (onAlertCloseAction) { onAlertCloseAction(); onAlertCloseAction = null; }
    }
    function showMyConfirm(message, actionYes) {
        document.getElementById('custom-confirm-text').innerText = message;
        document.getElementById('custom-confirm').style.display = 'flex';
        onConfirmAction = actionYes;
    }
    function closeCustomConfirm(choice) {
        document.getElementById('custom-confirm').style.display = 'none';
        if (choice && onConfirmAction) { onConfirmAction(); }
        onConfirmAction = null;
    }

    // --- DATABASE ---
    function openDB() { return new Promise((resolve, reject) => { const r = indexedDB.open(DB_NAME, DB_VERSION); r.onerror=()=>reject("DB Error"); r.onsuccess=e=>resolve(e.target.result); r.onupgradeneeded=e=>{ if(!e.target.result.objectStoreNames.contains("channels")) e.target.result.createObjectStore("channels", { keyPath: "url" }); }; }); }
    async function saveChannelsToDB(channels) { const db=await openDB(); const tx=db.transaction("channels","readwrite"); const store=tx.objectStore("channels"); channels.forEach(ch=>{try{store.put(ch);}catch(e){}}); }
    async function loadChannelsFromDB() { const db=await openDB(); return new Promise(r=>{ const tx=db.transaction("channels","readonly"); const req=tx.objectStore("channels").getAll(); req.onsuccess=()=>r(req.result||[]); req.onerror=()=>r([]); }); }
    async function clearDB() { const db=await openDB(); try{db.transaction("channels","readwrite").objectStore("channels").clear();}catch(e){} }

    function enforceNovelasIntegrity() {
        // Premium channels are now handled by injectPremiumChannels
    }

    // --- SYSTÃˆME RÃ‰SEAU ---
    function refreshNetworkUI(speedMbps) {
        let displayTotal = "";
        if(totalBytesUsed > 1073741824) displayTotal = (totalBytesUsed / 1073741824).toFixed(2) + " Go";
        else displayTotal = (totalBytesUsed / 1048576).toFixed(1) + " Mo";
        
        const elTotal = document.getElementById('net-total');
        if(elTotal) elTotal.innerText = displayTotal;

        const elSpeed = document.getElementById('net-speed');
        if(elSpeed) elSpeed.innerText = speedMbps.toFixed(2) + " Mbps";

        const meter = document.getElementById('signal-meter');
        if(meter) {
            meter.className = "signal-container"; 
            if(speedMbps > 3.5) meter.classList.add('sig-lvl-4');      
            else if(speedMbps > 1.5) meter.classList.add('sig-lvl-3'); 
            else if(speedMbps > 0.5) meter.classList.add('sig-lvl-2'); 
            else meter.classList.add('sig-lvl-1');                     
        }
    }

    function onVideoChunkLoaded(bytes, durationMs) {
        totalBytesUsed += bytes;
        localStorage.setItem('mybox_data_bytes', totalBytesUsed);
        if(durationMs > 0) {
            const bits = bytes * 8;
            const bps = bits / (durationMs / 1000);
            const mbps = bps / 1000000;
            refreshNetworkUI(mbps);
        }
    }

    setInterval(() => {
        let estimatedSpeed = 0;
        if(navigator.onLine) {
            if (navigator.connection && navigator.connection.downlink) {
                estimatedSpeed = navigator.connection.downlink; 
            } else { estimatedSpeed = 2; }
        }
        if(video.paused || !hls) { refreshNetworkUI(estimatedSpeed); }
    }, 2000);

    // --- UI MODE ---
    function updateModeUI() {
        const badge = document.getElementById('mode-badge');
        const btnDelete = document.getElementById('btn-delete');
        const btnAutoZap = document.getElementById('btn-autozap');
        
        if (appMode) {
            if(appMode === 'premium') {
                badge.innerText = "PREMIUM";
                badge.style.color = "#2ecc71";
                btnDelete.style.display = 'none'; 
                btnAutoZap.style.display = 'none'; 
            } else {
                badge.innerText = "TRANS";
                badge.style.color = "#3498db";
                btnDelete.style.display = 'flex'; 
                btnAutoZap.style.display = 'flex'; 
            }
            const radios = document.getElementsByName('sourceMode');
            radios.forEach(r => { if(r.value === appMode) r.checked = true; });
        }
        
        const btnView = document.getElementById('btn-view-mode');
        if(isGridMode) {
            btnView.classList.remove('fa-th');
            btnView.classList.add('fa-list');
        } else {
            btnView.classList.remove('fa-list');
            btnView.classList.add('fa-th');
        }
    }

    function toggleViewMode() {
        isGridMode = !isGridMode;
        localStorage.setItem('mybox_view_mode', isGridMode ? 'grid' : 'list');
        updateModeUI();
        renderList();
    }
    
    function togglePremiumFilter() {
        const chk = document.getElementById('chk-premium');
        showVip = chk.checked;
        const lbl = document.getElementById('chk-premium-label');
        if(showVip) lbl.classList.add('active'); else lbl.classList.remove('active');
        renderList();
    }

    function toggleModeQuick() {
        if(!appMode) return; 
        appMode = (appMode === 'full') ? 'premium' : 'full';
        changeSourceMode(appMode);
    }

    function changeSourceMode(mode) {
        localStorage.setItem('mybox_mode', mode);
        appMode = mode;
        updateModeUI();
        closeSettings();
        showMyAlert("Mode configurÃ© : " + mode.toUpperCase() + ".\nChargement des chaÃ®nes...", function() { initApp(); });
    }

    if(localStorage.getItem('mybox_auth') === 'OK') { 
        document.getElementById('login-screen').style.display = 'none'; 
        updateAccountDisplay(localStorage.getItem('mybox_key'), localStorage.getItem('mybox_raw_status')); 
        initApp();
        startRealTimeCheck();
    }

    function startRealTimeCheck() { setInterval(async () => { const key = localStorage.getItem('mybox_key'); if(!key) return; try { const res = await fetch(`${API_URL}?action=login&key=${encodeURIComponent(key)}&device=${encodeURIComponent(deviceId)}`); const text = await res.text(); if(!text.includes("SUCCESS")) { localStorage.removeItem('mybox_auth'); location.reload(); } else { updateAccountDisplay(key, text); } } catch(e) {} }, 5000); }
    
    async function login() { 
        const key = document.getElementById('licenseKey').value.trim(); 
        try { 
            const res = await fetch(`${API_URL}?action=login&key=${encodeURIComponent(key)}&device=${encodeURIComponent(deviceId)}`); 
            const text = await res.text(); 
            if(text.includes("MAINTENANCE")) { showMyAlert("Maintenance en cours."); return; } 
            if(text.includes("SUCCESS")) { 
                localStorage.setItem('mybox_auth', 'OK'); 
                localStorage.setItem('mybox_key', key); 
                localStorage.setItem('mybox_raw_status', text); 
                updateAccountDisplay(key, text); 
                document.getElementById('login-screen').style.display = 'none'; 
                initApp(); 
                startRealTimeCheck(); 
            } else { showMyAlert("ABONNEMENT EXPIRÃ‰ OU ID INVALIDE"); } 
        } catch(e) { showMyAlert("Erreur de connexion Internet"); } 
    }
    
    function updateAccountDisplay(key, raw) { document.getElementById('sub-id').innerText = key; if(raw && raw.split(':').length >= 3) document.getElementById('sub-details').innerText = "Expire: " + raw.split(':')[1] + "j"; }
    
    async function logout() { 
        showMyConfirm("Voulez-vous vraiment vous dÃ©connecter ?", async function() {
            try{ await fetch(`${API_URL}?action=logout&key=${localStorage.getItem('mybox_key')}&device=${deviceId}`); }catch(e){} 
            localStorage.removeItem('mybox_auth'); 
            location.reload(); 
        });
    }

    async function initApp() {
        if (!appMode) {
            openSettings(); 
            showMyAlert("Bienvenue sur My Box TV !\nVeuillez choisir un Mode de RÃ©ception pour commencer.");
            return; 
        }

        updateModeUI();
        
        // On rÃ©initialise
        allChannels = [];
        loadedUrls = new Set();

        // 1. INJECTION DES CHAINES VIP (TOUJOURS)
        await injectPremiumChannels();

        playChannel(0);
        refreshNetworkUI(0);

        if (appMode === 'premium') {
            // Dans ce mode, on peut juste garder les VIP ou charger une liste externe
            // Ici, pour l'instant, on garde les VIP injectÃ©es.
        } else {
            const cached = await loadChannelsFromDB();
            if(cached.length > 5) {
                // Fusion
                cached.forEach(ch => {
                    if(!loadedUrls.has(ch.url)) {
                        allChannels.push(ch);
                        loadedUrls.add(ch.url);
                        if(ch.category) allCategories.add(ch.category);
                    }
                });
                updateCategoryChips(); renderList();
            }
            fetchTranspondersList();
        }
    }

    async function fetchTranspondersList() {
        if(appMode === 'premium') return; 
        try {
            const res = await fetch(`${API_URL}?action=admin_get_m3u_sources`);
            const json = await res.json();
            availableTransponders = json;
            renderTranspondersUI();
            if(allChannels.length < 5) {
                availableTransponders.forEach((tp, i) => { setTimeout(() => fetchPlaylistWithWatchdog(tp), i * 1000); });
            }
        } catch(e) { console.log("TP Error", e); }
    }

    function renderTranspondersUI() {
        const container = document.getElementById('transponder-list');
        container.innerHTML = "";
        if(availableTransponders.length === 0) { container.innerHTML = "Aucun signal dÃ©tectÃ©."; return; }
        availableTransponders.forEach((tpUrl, idx) => {
            const div = document.createElement('div');
            div.className = "tp-item";
            div.innerHTML = `<span class="tp-name">Source ${idx+1}</span><input type="checkbox" class="tp-checkbox" value="${tpUrl}" checked>`;
            container.appendChild(div);
        });
    }

    async function scanSelectedTransponders() {
        if(appMode === 'premium') return showMyAlert("Impossible en mode Premium. Passez en mode Complet.");
        const checkboxes = document.querySelectorAll('.tp-checkbox:checked');
        if(checkboxes.length === 0) return showMyAlert("SÃ©lectionnez au moins un transpondeur.");
        
        document.getElementById('settings-modal').style.display = 'none'; 
        document.getElementById('scan-info').style.display = "flex";
        isScanning = true;
        for (let i = 0; i < checkboxes.length; i++) {
            const url = checkboxes[i].value;
            document.getElementById('scan-text').innerText = `Balayage TP ${i+1}/${checkboxes.length}...`;
            await fetchPlaylistWithWatchdog(url);
        }
        isScanning = false;
        document.getElementById('scan-info').style.display = "none";
        saveChannelsToDB(allChannels);
        showMyAlert("Balayage terminÃ© !");
    }

    async function quickScan() {
        if(appMode === 'premium') { initApp(); return; } 
        if(isScanning) return;
        showMyConfirm("Rechercher les nouvelles chaÃ®nes maintenant ?", async function() {
            document.getElementById('scan-info').style.display = "flex";
            isScanning = true;
            for(let tpUrl of availableTransponders) {
                document.getElementById('scan-text').innerText = "Recherche Rapide...";
                await fetchPlaylistWithWatchdog(tpUrl);
            }
            isScanning = false;
            document.getElementById('scan-info').style.display = "none";
            saveChannelsToDB(allChannels);
        });
    }

    async function fetchPlaylistWithWatchdog(url) {
        lastActivityTime = Date.now();
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); 
        try {
            const response = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(url), { signal: controller.signal });
            clearTimeout(timeoutId); if (!response.ok) return;
            
            const length = response.headers.get("Content-Length");
            if(length) onVideoChunkLoaded(parseInt(length), 100);

            const reader = response.body.getReader(); const decoder = new TextDecoder("utf-8");
            let buffer = ""; let newBatch = [];
            while (true) {
                const { done, value } = await reader.read(); if (done) break;
                lastActivityTime = Date.now(); buffer += decoder.decode(value, { stream: true });
                let lines = buffer.split("\n"); buffer = lines.pop(); 
                processLines(lines, newBatch);
                if (newBatch.length >= 50) { flushBatch(newBatch); await new Promise(r => setTimeout(r, 10)); }
            }
            processLines([buffer], newBatch); flushBatch(newBatch);
        } catch (e) { console.log("Skip"); }
    }

    function processLines(lines, batch) {
        let currentInfo = null;
        for (let line of lines) {
            line = line.trim(); if(!line) continue;
            if (line.startsWith('#EXTINF:')) {
                const parts = line.split(',');
                let name = parts[1] || "Sans Nom";
                let logo = (line.match(/tvg-logo=["']?([^"']*)["']?/) || [])[1];
                let cat = "Autres";
                const grpMatch = line.match(/group-title=["']?([^"']*)["']?/);
                if(grpMatch) cat = grpMatch[1].replace(/;/g, " ").trim();
                else if(name.includes(":")) cat = name.split(":")[0].trim();
                if(name.includes(">")) cat = name.split(">")[0].trim(); 
                currentInfo = { name: name, logo: logo, category: cat }; allCategories.add(cat);
            } else if (line.startsWith('http') && !line.endsWith('.m3u')) {
                if (currentInfo) {
                    if (line.includes('.m3u8') || line.includes('.ts') || line.includes('.mp4') || line.includes('.mkv')) {
                        const ch = { ...currentInfo, url: line };
                        if (!loadedUrls.has(ch.url) && !hiddenChannels.includes(ch.url)) { 
                            batch.push(ch); loadedUrls.add(ch.url); 
                        }
                    }
                    currentInfo = null;
                }
            }
        }
    }

    function flushBatch(batch) {
        if(batch.length === 0) return;
        allChannels = allChannels.concat(batch); batch.length = 0;
        document.getElementById('count-display').innerText = allChannels.length + " trouvÃ©es";
        enforceNovelasIntegrity();
        if(document.getElementById('searchInput').value === "") renderList(); 
        updateCategoryChips();
    }

    function renderList() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        
        displayedChannels = allChannels.filter(ch => {
            let catOK = true;
            if(selectedCategories.length > 0 && !selectedCategories.includes(ch.category || "Autres")) catOK = false;
            
            // Filtre VIP
            if(!showVip && ch.isVip) return false;

            return catOK && ch.name.toLowerCase().includes(term) && (isFavFilter ? favorites.includes(ch.url) : true);
        });

        const list = document.getElementById('channel-list');
        list.innerHTML = "";
        
        // MODE GRILLE ou LISTE
        if(isGridMode) list.className = "grid-view";
        else list.className = "";

        const frag = document.createDocumentFragment();
        let limit = (term === "" && selectedCategories.length === 0) ? 500 : displayedChannels.length;
        
        displayedChannels.slice(0, limit).forEach((ch) => {
            const isFav = favorites.includes(ch.url);
            const isPlaying = (ch.url === allChannels[currentChannelIndex]?.url);
            const logoSrc = ch.logo || 'https://via.placeholder.com/40?text=TV';
            
            const div = document.createElement('div');
            
            if(isGridMode) {
                // --- RENDU GRILLE ---
                div.className = 'grid-card ' + (isPlaying ? 'active' : '') + (ch.isVip ? ' vip' : '');
                div.innerHTML = `
                    ${ch.isVip ? '<span class="vip-badge">â˜…</span>' : ''}
                    <img src="${logoSrc}" class="grid-img" loading="lazy" onerror="this.src='https://via.placeholder.com/40?text=TV'">
                    <div class="grid-title">${ch.name}</div>
                `;
            } else {
                // --- RENDU LISTE ---
                div.className = 'channel-row ' + (isPlaying ? 'active' : '');
                div.innerHTML = `<i class="fas fa-star fav-icon ${isFav ? 'active' : ''}" onclick="toggleFavorite('${ch.url}', event)"></i>
                                 <img src="${logoSrc}" class="ch-logo" loading="lazy" onerror="this.src='https://via.placeholder.com/40?text=TV'">
                                 <div>
                                    <div style="font-weight:600; font-size:14px;">
                                        ${ch.name} ${ch.isVip ? '<span style="color:gold;font-size:10px;">â˜…</span>' : ''}
                                    </div>
                                    <div style="font-size:10px; color:#888;">${ch.category}</div>
                                 </div>`;
            }
            
            div.onclick = () => tryPlayChannel(ch);
            frag.appendChild(div);
        });
        list.appendChild(frag);
        document.getElementById('count-display').innerText = allChannels.length + " ChaÃ®nes";
    }

    function updateCategoryChips() {
        const container = document.getElementById('chips-area');
        if(!container) return; 
        if(container.childElementCount === allCategories.size) return;
        let html = '';
        Array.from(allCategories).sort().forEach(cat => {
            const active = selectedCategories.includes(cat) ? 'selected' : '';
            html += `<div class="chip ${active}" onclick="toggleCat('${cat}')">${cat}</div>`;
        });
        container.innerHTML = html;
    }
    
    function toggleCat(cat) { if(selectedCategories.includes(cat)) selectedCategories = selectedCategories.filter(c => c !== cat); else selectedCategories.push(cat); updateCategoryChips(); renderList(); }
    function resetFilters() { selectedCategories = []; updateCategoryChips(); renderList(); }
    function applyFilters() { localStorage.setItem('mybox_categories', JSON.stringify(selectedCategories)); renderList(); closeSettings(); }
    function toggleFavorite(url, e) { e.stopPropagation(); if(favorites.includes(url)) favorites = favorites.filter(u => u !== url); else favorites.push(url); localStorage.setItem('mybox_favs', JSON.stringify(favorites)); renderList(); }
    function toggleOnlyFavorites() { isFavFilter = !isFavFilter; document.getElementById('btn-fav-filter').style.background = isFavFilter ? '#e50914' : '#2a2a2a'; renderList(); }

    function tryPlayChannel(ch) {
        let index = -1;
        if(typeof ch === 'object') index = allChannels.indexOf(ch);
        else { index = ch; ch = allChannels[index]; } 

        const name = ch.name.toLowerCase();
        if(name.includes('adult') || name.includes('xxx') || name.includes('porn')) { pendingChannelIndex = index; document.getElementById('pin-modal').style.display = 'flex'; }
        else { currentChannelIndex = index; playChannel(currentChannelIndex); }
    }
    function checkPin() { if(document.getElementById('pin-code').value === PIN_CODE) { closePin(); playChannel(pendingChannelIndex); } else showMyAlert("Code ErronÃ©"); }
    function closePin() { document.getElementById('pin-modal').style.display = 'none'; }

    function playChannel(index) {
        if(!allChannels[index]) return;
        const ch = allChannels[index];
        if(window.innerWidth < 900) document.body.classList.remove('menu-open');
        renderList(); 
        statusText.innerText = ch.name; led.className = "orange";
        
        if(Hls.isSupported()) {
            if(hls) hls.destroy(); 
            hls = new Hls({manifestLoadingMaxRetry: 5, manifestLoadingTimeOut: 10000});
            hls.loadSource(ch.url); 
            hls.attachMedia(video);
            
            hls.on(Hls.Events.FRAG_LOADED, function(event, data) {
                 if(data.stats) {
                     const totalBytes = data.stats.total; 
                     const duration = data.stats.loading.end - data.stats.loading.start; 
                     onVideoChunkLoaded(totalBytes, duration);
                 }
            });

            hls.on(Hls.Events.MANIFEST_PARSED, () => { video.play().catch(()=>{}); led.className = "green"; clearTimeout(autoZapTimeout); });
            hls.on(Hls.Events.ERROR, (e,d) => { if(d.fatal) { if(index===0){ setTimeout(()=>playChannel(0),2000); } else handleError(); } });
        } else if(video.canPlayType('application/vnd.apple.mpegurl')) { 
            video.src = ch.url; video.play(); 
        }
        
        if(isAutoZap && index !== 0) { clearTimeout(autoZapTimeout); autoZapTimeout = setTimeout(() => { if(video.paused || video.readyState < 2) handleError(); }, 15000); }
    }
    
    function handleError() { led.className = ""; if(isAutoZap) { statusText.innerText = "Zap Auto..."; setTimeout(nextChannel, 1000); } else { statusText.innerText = "Erreur Flux"; } }
    function toggleMenu() { document.body.classList.toggle('menu-open'); }
    function nextChannel() { let nextIdx = currentChannelIndex + 1; if(nextIdx >= allChannels.length) nextIdx = 0; tryPlayChannel(nextIdx); }
    function prevChannel() { let prevIdx = currentChannelIndex - 1; if(prevIdx < 0) prevIdx = allChannels.length - 1; tryPlayChannel(prevIdx); }
    function adjustVol(d) { video.volume = Math.min(1, Math.max(0, video.volume + d)); }
    function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else if (document.exitFullscreen) document.exitFullscreen(); }
    
    function toggleAutoZap() { 
        if(appMode === 'premium') return; 
        isAutoZap = !isAutoZap; 
        const btn = document.getElementById('btn-autozap'); 
        if(isAutoZap) { btn.classList.add('active-mode'); statusText.innerText = "Auto-Zap ON"; } 
        else { btn.classList.remove('active-mode'); statusText.innerText = "Auto-Zap OFF"; clearTimeout(autoZapTimeout); } 
    }
    
    function hideCurrentChannel() { 
        showMyConfirm("Supprimer cette chaÃ®ne de la liste ?", function() {
            const ch = allChannels[currentChannelIndex]; 
            hiddenChannels.push(ch.url); 
            localStorage.setItem('mybox_hidden', JSON.stringify(hiddenChannels)); 
            allChannels.splice(currentChannelIndex, 1); 
            loadedUrls.delete(ch.url); 
            renderList(); 
            nextChannel(); 
        });
    }
    
    function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; updateCategoryChips(); }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function showTab(id) { document.querySelectorAll('.tab-content').forEach(el => el.style.display='none'); document.querySelectorAll('.settings-tab').forEach(el => el.classList.remove('active')); document.getElementById(id).style.display = 'block'; }
    
    function addSource() { document.getElementById('localFileInput').click(); }
    
    function handleTitanScan(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const text = e.target.result;
            processLines(text.split('\n'), []); 
            showMyAlert("Fichier chargÃ©.");
        };
        reader.readAsText(file);
    }

    async function forceReload() { 
        showMyConfirm("Voulez-vous rÃ©initialiser et recharger ?", async function() {
            await clearDB(); location.reload(); 
        });
    }
</script>
</body>
</html>
