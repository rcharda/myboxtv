<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <title>My Box TV - Extraction Auto</title>
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #e50914; --glass: rgba(20, 20, 20, 0.98); --text: #fff; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #000; color: var(--text); height: 100vh; overflow: hidden; }

        #video-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: #000; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        #channel-menu { position: fixed; top: 0; left: 0; width: 350px; height: 100%; background: var(--glass); backdrop-filter: blur(15px); transform: translateX(-100%); transition: transform 0.3s; display: flex; flex-direction: column; z-index: 100; pointer-events: auto; border-right: 1px solid #333; }
        body.menu-open #channel-menu { transform: translateX(0); }

        .menu-header { padding: 15px; background: #111; border-bottom: 2px solid var(--primary); display: flex; flex-direction:column; align-items: center; gap:5px;}
        #searchInput { width: 95%; margin: 5px auto; padding: 10px; border-radius: 5px; background: #333; border: none; color: white; display: block; font-size: 14px; }
        
        .filter-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; background: #1a1a1a; }
        
        .vip-toggle { display: flex; align-items: center; gap: 6px; background: #222; padding: 6px 12px; border-radius: 20px; border: 1px solid #444; cursor: pointer; transition:0.2s; }
        .vip-toggle input { accent-color: gold; }
        .vip-toggle span { font-size: 11px; font-weight: bold; color: gold; text-transform: uppercase; }

        /* STATUS DU CERVEAU */
        .brain-status { font-size: 10px; color: #0f0; display: flex; align-items: center; gap: 5px; font-weight: bold; }
        .brain-loader { width: 10px; height: 10px; border: 2px solid #0f0; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #channel-list { flex: 1; overflow-y: auto; padding: 0; width:100%; }
        
        .channel-row { display: flex; align-items: center; padding: 10px 15px; margin: 0; border-bottom: 1px solid #222; cursor: pointer; contain: content; }
        .channel-row:hover { background: #222; }
        .channel-row.active { background: rgba(229,9,20,0.2); border-left: 3px solid var(--primary); }
        .ch-logo { width: 35px; height: 35px; object-fit: contain; background: #fff; padding: 2px; border-radius: 3px; margin-right: 10px; }
        .ch-info { flex: 1; overflow: hidden; }
        .ch-name { font-weight: 600; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ch-tag { font-size: 9px; color: #888; }
        
        .pagination-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #111; border-top: 1px solid #333; }
        .page-btn { background: #333; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .page-info { font-size: 11px; color: #ccc; }

        #bottom-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px); padding: 8px 15px; border-radius: 40px; border: 1px solid #333; display: flex; gap: 10px; align-items: center; z-index: 90; pointer-events: auto; width: auto; max-width: 98%; justify-content: space-between; flex-wrap: nowrap; overflow-x: auto; }
        .btn-ctrl { width: 45px; height: 45px; border-radius: 50%; background: #2a2a2a; color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; flex-shrink: 0; transition: 0.2s; }
        .btn-ctrl:active { background: var(--primary); transform: scale(0.95); }
        .desktop-only { display: flex; }
        @media (max-width: 600px) { .desktop-only { display: none; } #bottom-bar { gap: 5px; padding: 5px 10px; bottom: 10px; } #channel-menu { width: 85%; } }
    </style>
</head>
<body>

<div id="video-layer"><video id="video" onclick="toggleMenu()" playsinline crossorigin="anonymous"></video></div>

<div id="ui-layer">
    <div id="channel-menu">
        <div class="menu-header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/COMPANY%281%29.png" style="width:100px;">
            <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                <div class="brain-status" id="brain-indicator" style="display:none;">
                    <div class="brain-loader"></div> Extraction Col.B... <span id="brain-count">0</span>
                </div>
                <span id="total-count" style="font-size:10px; color:#888;">0 Cha√Ænes</span>
            </div>
        </div>
        
        <input type="text" id="searchInput" placeholder="üîç Rechercher..." oninput="refreshList()">
        
        <div class="filter-bar">
            <label class="vip-toggle">
                <input type="checkbox" id="chk-vip" checked onchange="refreshList()">
                <span>FILTRE DIRECT</span>
            </label>
        </div>

        <div id="channel-list"></div>

        <div class="pagination-bar">
            <button class="page-btn" onclick="changePage(-1)">‚ùÆ</button>
            <span class="page-info" id="page-display">Page 1</span>
            <button class="page-btn" onclick="changePage(1)">‚ùØ</button>
        </div>
    </div>

    <div id="bottom-bar">
        <button class="btn-ctrl" onclick="prevChannel()"><i class="fas fa-step-backward"></i></button>
        <button class="btn-ctrl desktop-only" onclick="adjustVol(-0.1)"><i class="fas fa-minus"></i></button>
        <button class="btn-ctrl btn-large" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
        <button class="btn-ctrl desktop-only" onclick="adjustVol(0.1)"><i class="fas fa-plus"></i></button>
        <button class="btn-ctrl" onclick="nextChannel()"><i class="fas fa-step-forward"></i></button>
        <button class="btn-ctrl" onclick="toggleFullScreen()"><i class="fas fa-expand"></i></button>
    </div>
</div>

<script>
    // URL API GOOGLE (Remplace par la tienne)
    const API_URL = "https://script.google.com/macros/s/AKfycbyTVVHd3DGbEtlRfVN5aboerVM1UEbDYTGv4vJxabValUYDAHRxgLoFppjUO8xwv9SsTw/exec";
    const PROXY_URL = "https://corsproxy.io/?"; // Indispensable pour lire le M3U

    const DEFAULT_CHANNEL = { 
        name: "Novelas TV", 
        url: "https://stormcast-telenovelatv-1-fr.samsung.wurl.tv/playlist.m3u8", 
        logo: "https://upload.wikimedia.org/wikipedia/commons/2/29/Novelas_TV_Logo.png", 
        category: "Start",
        isDirect: true 
    };

    // VARIABLES
    let allChannels = [DEFAULT_CHANNEL]; 
    let filteredChannels = [];
    let loadedUrls = new Set([DEFAULT_CHANNEL.url]);
    
    // Pagination
    let currentPage = 1;
    const itemsPerPage = 50;

    let currentChannelIndex = 0;
    let hls = null;
    const video = document.getElementById('video');

    window.onload = function() {
        playChannel(0);
        refreshList();
        startTheBrain(); // Lancement du processus intelligent
    };

    // --- LE CERVEAU : LECTURE COLONNE B -> EXTRACTION -> VALIDATION -> AJOUT ---
    async function startTheBrain() {
        const brainUI = document.getElementById('brain-indicator');
        const brainCount = document.getElementById('brain-count');
        brainUI.style.display = 'flex';

        try {
            // 1. R√©cup√©rer les donn√©es brutes de l'Excel (API)
            const res = await fetch(`${API_URL}?action=get_playlists`);
            const data = await res.json();
            
            // data est suppos√© √™tre un tableau d'objets venant de l'Excel.
            // On suppose que l'API renvoie un objet par ligne.
            // Exemple : { transponder_url: "http...m3u" (Col B), direct_url: "..." (Col D) }

            // 2. BOUCLE SUR CHAQUE LIGNE DE L'EXCEL
            for (const row of data) {
                
                // CAS A : Il y a un lien direct dans la Colonne D (Premium d√©j√† extrait)
                if (row.url && !loadedUrls.has(row.url)) {
                    await checkAndAddChannel({
                        name: row.name || "Cha√Æne Direct",
                        url: row.url,
                        logo: row.logo,
                        category: "Premium",
                        isDirect: true
                    }, brainCount);
                }

                // CAS B : Il y a un lien M3U dans la Colonne B (Transpondeur √† extraire)
                // Adapte 'row.transponder' selon le nom exact de ta cl√© JSON pour la colonne B
                if (row.transponder_url) {
                    await extractAndProcessM3U(row.transponder_url, brainCount);
                }
            }

        } catch(e) { console.log("Erreur Cerveau", e); }
        
        brainUI.innerHTML = "‚úì Analyse Termin√©e";
        setTimeout(() => brainUI.style.display = 'none', 5000);
    }

    // --- EXTRACTION DU M3U (COLONNE B) ---
    async function extractAndProcessM3U(m3uUrl, counterElement) {
        try {
            // T√©l√©charge le fichier M3U via Proxy
            const res = await fetch(PROXY_URL + encodeURIComponent(m3uUrl));
            if (!res.ok) return;
            const text = await res.text();
            const lines = text.split('\n');

            let currentInfo = null;

            // Analyse ligne par ligne
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                if (line.startsWith('#EXTINF')) {
                    // Extraction du nom
                    let nameParts = line.split(',');
                    let name = nameParts.length > 1 ? nameParts[1].trim() : "Sans Nom";
                    // Extraction logo
                    let logoMatch = line.match(/tvg-logo=["']?([^"']*)["']?/);
                    let logo = logoMatch ? logoMatch[1] : "";
                    
                    currentInfo = { name: name, logo: logo };
                } 
                else if (line.startsWith('http')) {
                    if (currentInfo && !loadedUrls.has(line)) {
                        // On a trouv√© un lien de cha√Æne dans le transpondeur !
                        // On l'envoie au Validateur
                        await checkAndAddChannel({
                            name: currentInfo.name,
                            url: line,
                            logo: currentInfo.logo,
                            category: "Transpondeur",
                            isDirect: false // C'est issu d'un scan
                        }, counterElement);
                        
                        currentInfo = null;
                    }
                }
            }
        } catch (e) {
            console.log("Erreur lecture M3U: " + m3uUrl);
        }
    }

    // --- VALIDATEUR SILENCIEUX (LE TESTEUR) ---
    async function checkAndAddChannel(channelObj, counterElement) {
        // Teste si le lien est vivant (HEAD request rapide)
        const isValid = await checkLinkSilently(channelObj.url);

        if (isValid) {
            // Ajout √† la liste principale
            allChannels.push(channelObj);
            loadedUrls.add(channelObj.url);
            
            // Mise √† jour compteur UI
            let count = parseInt(counterElement.innerText);
            counterElement.innerText = count + 1;

            // Si on est sur la derni√®re page, on rafraichit pour voir l'ajout
            // (Optionnel pour √©viter trop de scintillement)
            if (filteredChannels.length < itemsPerPage * currentPage) {
                 refreshList(true);
            }
        }
        // Si invalide, on ne fait RIEN (La cha√Æne n'existe pas pour l'utilisateur)
    }

    async function checkLinkSilently(url) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), 3000); // 3 sec max par lien
        try {
            const response = await fetch(url, { method: 'HEAD', signal: controller.signal });
            clearTimeout(id);
            return response.ok;
        } catch(e) { return false; }
    }

    // --- GESTION AFFICHAGE (PAGINATION) ---
    function refreshList(keepPage = false) {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const showDirectOnly = document.getElementById('chk-vip').checked;

        filteredChannels = allChannels.filter(ch => {
            if (term && !ch.name.toLowerCase().includes(term)) return false;
            // Filtre : Si coch√©, on montre tout. Si d√©coch√©, on cache les "Direct" (Premium) ?
            // Ou inversement selon ta logique. Ici : Tout montrer par d√©faut.
            return true; 
        });

        document.getElementById('total-count').innerText = filteredChannels.length + " Cha√Ænes";

        if (!keepPage) currentPage = 1;
        renderPagination();
    }

    function renderPagination() {
        const list = document.getElementById('channel-list');
        list.innerHTML = "";
        
        const totalPages = Math.ceil(filteredChannels.length / itemsPerPage) || 1;
        if(currentPage > totalPages) currentPage = totalPages;

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = filteredChannels.slice(start, end);

        const frag = document.createDocumentFragment();

        pageItems.forEach(ch => {
            const isPlaying = (ch.url === allChannels[currentChannelIndex]?.url);
            const div = document.createElement('div');
            div.className = 'channel-row ' + (isPlaying ? 'active' : '');
            
            // Logo
            let logoSrc = ch.logo || "https://via.placeholder.com/35?text=TV";
            // Ic√¥ne source
            let sourceIcon = ch.isDirect ? '<i class="fas fa-star" style="color:gold; font-size:10px;"></i>' : '<i class="fas fa-signal" style="color:#666; font-size:10px;"></i>';

            div.innerHTML = `
                <img src="${logoSrc}" class="ch-logo" onerror="this.src='https://via.placeholder.com/35?text=TV'">
                <div class="ch-info">
                    <div class="ch-name">${ch.name} ${sourceIcon}</div>
                    <div class="ch-tag">${ch.category || 'G√©n√©ral'}</div>
                </div>
            `;
            
            div.onclick = () => {
                const realIndex = allChannels.indexOf(ch);
                playChannel(realIndex);
            };
            frag.appendChild(div);
        });

        list.appendChild(frag);
        document.getElementById('page-display').innerText = `Page ${currentPage} / ${totalPages}`;
    }

    function changePage(direction) {
        currentPage += direction;
        refreshList(true);
    }

    // --- PLAYER ---
    function playChannel(index) {
        if(index < 0 || index >= allChannels.length) return;
        currentChannelIndex = index;
        const ch = allChannels[index];
        
        // Mise √† jour liste pour la surbrillance
        refreshList(true);
        if(window.innerWidth < 900) document.body.classList.remove('menu-open');

        if(Hls.isSupported()) {
            if(hls) hls.destroy();
            hls = new Hls();
            hls.loadSource(ch.url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else if(video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = ch.url;
            video.play();
        }
    }

    function toggleMenu() { document.body.classList.toggle('menu-open'); }
    function nextChannel() { playChannel(currentChannelIndex + 1); }
    function prevChannel() { playChannel(currentChannelIndex - 1); }
    function adjustVol(v) { video.volume = Math.min(1, Math.max(0, video.volume + v)); }
    function toggleFullScreen() {
        if(!document.fullscreenElement) document.documentElement.requestFullscreen();
        else if(document.exitFullscreen) document.exitFullscreen();
    }
</script>
</body>
</html>
